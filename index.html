<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FreshFlow - Premium Water & Meat Delivery | Fresh Quality Guaranteed</title>
  <meta name="description" content="Order fresh water and premium meat online. Fast 30-minute delivery, quality guaranteed. Cash on delivery and UPI payment available.">
  <script src="https://cdn.tailwindcss.com"></script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=geometry,places&callback=initGoogleMaps"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #1e40af;
      --primary-dark: #1e3a8a;
      --primary-light: #3b82f6;
      --secondary-color: #059669;
      --secondary-dark: #047857;
      --accent-color: #f59e0b;
      --success-color: #10b981;
      --error-color: #ef4444;
      --warning-color: #f59e0b;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }
    
    * {
      box-sizing: border-box;
    }
    
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6;
      scroll-behavior: smooth;
      background-color: var(--gray-50);
      color: var(--gray-900);
      font-feature-settings: 'kern' 1, 'liga' 1;
      text-rendering: optimizeLegibility;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    /* Enhanced Animations */
    .cart-badge { 
      animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); 
    }
    
    @keyframes bounceIn {
      0% { transform: scale(0); opacity: 0; }
      50% { transform: scale(1.2); opacity: 0.8; }
      100% { transform: scale(1); opacity: 1; }
    }
    
    /* Professional Card System */
    .product-card {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 16px;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      transform-origin: center;
      box-shadow: var(--shadow-sm);
    }
    
    .product-card:hover { 
      transform: translateY(-4px);
      box-shadow: var(--shadow-xl);
      border-color: var(--gray-300);
    }
    
    .card-elevated {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 16px;
      box-shadow: var(--shadow-md);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .card-elevated:hover {
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }
    
    .card-header {
      padding: 24px 24px 0 24px;
      border-bottom: 1px solid var(--gray-100);
      margin-bottom: 24px;
    }
    
    .card-body {
      padding: 24px;
    }
    
    .card-footer {
      padding: 0 24px 24px 24px;
      border-top: 1px solid var(--gray-100);
      margin-top: 24px;
      padding-top: 24px;
    }
    
    .fade-in { 
      animation: fadeInUp 0.6s ease-out forwards; 
      opacity: 0;
    }
    
    @keyframes fadeInUp {
      from { 
        opacity: 0; 
        transform: translateY(30px); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0); 
      }
    }
    
    .slide-in-right {
      animation: slideInRight 0.4s ease-out;
    }
    
    @keyframes slideInRight {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }
    
    .quantity-selector { 
      user-select: none; 
    }
    
    .floating-cart { 
      position: fixed; 
      bottom: 100px; 
      right: 24px; 
      z-index: 1000;
      animation: float 3s ease-in-out infinite;
      filter: drop-shadow(0 10px 8px rgba(0, 0, 0, 0.04)) drop-shadow(0 4px 3px rgba(0, 0, 0, 0.1));
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    
    /* Loading States */
    .loading {
      position: relative;
      overflow: hidden;
    }
    
    .loading::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
      animation: shimmer 1.5s infinite;
    }
    
    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f5f9;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
    
    /* Professional Button System */
    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 0.875rem;
      letter-spacing: 0.025em;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      cursor: pointer;
    }
    
    .btn-primary:hover {
      background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }
    
    .btn-primary:active {
      transform: translateY(0);
      box-shadow: var(--shadow-sm);
    }
    
    .btn-primary:focus {
      outline: none;
      box-shadow: var(--shadow-lg), 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .btn-secondary {
      background: white;
      border: 1.5px solid var(--gray-300);
      border-radius: 12px;
      color: var(--gray-700);
      font-weight: 500;
      font-size: 0.875rem;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
    }
    
    .btn-secondary:hover {
      border-color: var(--primary-color);
      color: var(--primary-color);
      box-shadow: var(--shadow-sm);
    }
    
    .btn-success {
      background: linear-gradient(135deg, var(--secondary-color), var(--secondary-dark));
      border: none;
      border-radius: 12px;
      color: white;
      font-weight: 600;
      font-size: 0.875rem;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
    }
    
    .btn-success:hover {
      background: linear-gradient(135deg, var(--secondary-dark), var(--secondary-color));
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }
    
    /* Toast Notifications */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      transform: translateX(400px);
      transition: transform 0.3s ease;
    }
    
    .toast.show {
      transform: translateX(0);
    }
    
    /* Enhanced Modal Backdrop */
    .modal-backdrop {
      backdrop-filter: blur(4px);
      background: rgba(0, 0, 0, 0.6);
    }
    
    /* Responsive Grid */
    .responsive-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1.5rem;
    }
    
    @media (max-width: 640px) {
      .responsive-grid {
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 1rem;
      }
    }
    
    /* Professional Form System */
    .form-input {
      background: white;
      border: 1.5px solid var(--gray-300);
      border-radius: 12px;
      padding: 12px 16px;
      font-size: 0.875rem;
      font-weight: 400;
      color: var(--gray-900);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-sm);
    }
    
    .form-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: var(--shadow-md), 0 0 0 3px rgba(30, 64, 175, 0.1);
      transform: translateY(-1px);
    }
    
    .form-input:hover:not(:focus) {
      border-color: var(--gray-400);
    }
    
    .form-input::placeholder {
      color: var(--gray-500);
      font-weight: 400;
    }
    
    .form-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 8px;
      letter-spacing: 0.025em;
    }
    
    .form-group {
      margin-bottom: 24px;
    }
    
    .form-select {
      background: white;
      border: 1.5px solid var(--gray-300);
      border-radius: 12px;
      padding: 12px 16px;
      font-size: 0.875rem;
      font-weight: 400;
      color: var(--gray-900);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-sm);
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 12px center;
      background-repeat: no-repeat;
      background-size: 16px;
      padding-right: 40px;
    }
    
    .form-select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: var(--shadow-md), 0 0 0 3px rgba(30, 64, 175, 0.1);
    }
    
    /* Status Indicators */
    .status-indicator {
      position: relative;
    }
    
    .status-indicator::before {
      content: '';
      position: absolute;
      left: -12px;
      top: 50%;
      transform: translateY(-50%);
      width: 8px;
      height: 8px;
      border-radius: 50%;
      animation: pulse-dot 2s infinite;
    }
    
    .status-online::before {
      background: #10b981;
    }
    
    .status-busy::before {
      background: #f59e0b;
    }
    
    @keyframes pulse-dot {
      0%, 100% { opacity: 1; transform: translateY(-50%) scale(1); }
      50% { opacity: 0.5; transform: translateY(-50%) scale(1.2); }
    }
    
    /* Enhanced Product Cards */
    .product-image-container {
      position: relative;
      overflow: hidden;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    }
    
    .product-badge {
      position: absolute;
      top: 12px;
      right: 12px;
      z-index: 10;
    }
    
    .price-tag {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
      font-weight: 700;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    
    /* Loading Skeleton */
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }
    
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
  </style>
</head>
<body class="bg-gray-50">
  <!-- Toast Notification Container -->
  <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <!-- Header -->
  <header class="bg-white shadow-sm sticky top-0 z-40 border-b border-gray-200 backdrop-blur-sm bg-white/95">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <div class="flex items-center space-x-6">
          <div class="flex items-center space-x-3">
            <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-blue-800 rounded-xl flex items-center justify-center shadow-md">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" fill="white"/>
                <path d="M19 15L19.5 17L22 17.5L19.5 18L19 20L18.5 18L16 17.5L18.5 17L19 15Z" fill="white"/>
                <path d="M5 6L5.5 7.5L7 8L5.5 8.5L5 10L4.5 8.5L3 8L4.5 7.5L5 6Z" fill="white"/>
              </svg>
            </div>
            <div>
              <div class="text-xl font-bold text-gray-900 tracking-tight">FreshFlow</div>
              <div class="text-xs font-medium text-gray-500 -mt-0.5 tracking-wide">Premium Quality</div>
            </div>
          </div>
          
          <div class="hidden lg:flex items-center space-x-4 pl-6 border-l border-gray-200">
            <div class="flex items-center space-x-2">
              <div class="relative">
                <div class="w-2.5 h-2.5 bg-green-500 rounded-full"></div>
                <div class="absolute inset-0 w-2.5 h-2.5 bg-green-500 rounded-full animate-ping opacity-75"></div>
              </div>
              <div class="flex flex-col">
                <span class="text-xs font-semibold text-green-700">Open Now</span>
                <span class="text-xs text-gray-500">Until 11 PM</span>
              </div>
            </div>
            <div class="flex items-center space-x-2">
              <div class="w-6 h-6 bg-blue-50 rounded-lg flex items-center justify-center">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M13 2L3 14H12L11 22L21 10H12L13 2Z" fill="#3B82F6"/>
                </svg>
              </div>
              <div class="flex flex-col">
                <span class="text-xs font-semibold text-gray-900">Fast Delivery</span>
                <span class="text-xs text-gray-500">30-45 min</span>
              </div>
            </div>
            <div class="flex items-center space-x-2">
              <div class="w-6 h-6 bg-green-50 rounded-lg flex items-center justify-center">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M9 12L11 14L15 10M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="#059669" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
              <div class="flex flex-col">
                <span class="text-xs font-semibold text-gray-900">Quality Assured</span>
                <span class="text-xs text-gray-500">100% fresh</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="flex items-center space-x-3">
          <!-- Location Selector -->
          <div class="hidden sm:flex items-center space-x-2 bg-gray-50 rounded-lg px-2 py-1.5 border text-xs">
            <span class="text-blue-600">📍</span>
            <div>
              <div class="text-gray-500 text-xs">To</div>
              <div class="font-medium text-gray-800" id="delivery-location">Select Location</div>
            </div>
            <button onclick="changeLocation()" class="text-blue-600 hover:text-blue-800 text-xs font-medium">
              Change
            </button>
          </div>
          
          <!-- User Profile Section -->
          <div id="user-profile" class="hidden flex items-center space-x-2 bg-blue-50 rounded-lg px-2 py-1 border border-blue-200">
            <div class="w-5 h-5 bg-blue-600 rounded-full flex items-center justify-center">
              <span class="text-white text-xs font-bold" id="user-initial">U</span>
            </div>
            <div class="text-xs">
              <div class="font-medium text-blue-800" id="user-name-display"></div>
            </div>
            <div class="flex space-x-1">
              <button onclick="showMyOrders()" class="bg-black hover:bg-gray-800 text-white px-2 py-1 rounded text-xs font-medium transition-all duration-300 shadow">
                📦
              </button>
              <button onclick="showUserProfile()" class="text-blue-600 hover:text-blue-800 text-xs font-medium px-1">
                Profile
              </button>
            </div>
          </div>
          
          <!-- My Orders Button (Always Visible) -->
          <button onclick="showMyOrders()" class="bg-black hover:bg-gray-800 text-white px-2 py-1 rounded text-xs font-medium shadow hover:shadow-lg transition-all duration-300">
            📦 <span class="hidden sm:inline ml-1">Orders</span>
          </button>
          
          <!-- Login Button -->
          <button id="login-btn" onclick="showUserLogin()" class="btn-primary text-white px-2 py-1 rounded text-xs font-medium shadow hover:shadow-lg transition-all duration-300">
            👤 <span class="hidden sm:inline ml-1">Login</span>
          </button>
          
          <!-- Admin Button -->
          <button onclick="toggleAdmin()" class="bg-black hover:bg-gray-800 text-white px-2 py-1 rounded transition-all duration-300 text-xs font-medium shadow">
            ⚙️ <span class="hidden sm:inline ml-1">Admin</span>
          </button>
        </div>
      </div>
      
      <!-- Mobile Location Bar -->
      <div class="sm:hidden pb-2 border-t border-gray-100 pt-2">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-2">
            <span class="text-blue-600">📍</span>
            <span class="text-xs text-gray-600">To:</span>
            <span class="font-medium text-gray-800 text-xs" id="delivery-location-mobile">Select Location</span>
          </div>
          <button onclick="changeLocation()" class="text-blue-600 hover:text-blue-800 text-xs font-medium">
            Change
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- User Login Modal -->
  <div id="user-login-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-lg p-8 max-w-md w-full">
      <h2 class="text-2xl font-semibold mb-6 text-center">👤 Login / Register</h2>
      <form id="user-login-form">
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Full Name *</label>
            <input type="text" id="user-name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter your full name">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Mobile Number *</label>
            <input type="tel" id="user-phone" required pattern="[0-9]{10}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter 10-digit mobile number">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Complete Address *</label>
            <textarea id="user-address" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="3" placeholder="House/Flat no, Street, Area, City, Pincode"></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Email (Optional)</label>
            <input type="email" id="user-email" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter your email address">
          </div>
        </div>
        <div class="flex space-x-4 mt-6">
          <button type="button" onclick="closeUserLogin()" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-colors">Cancel</button>
          <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors">Save & Continue</button>
        </div>
      </form>
    </div>
  </div>

  <!-- User Profile Modal -->
  <div id="user-profile-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-lg p-8 max-w-md w-full">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-semibold">👤 My Profile</h2>
        <button onclick="closeUserProfile()" class="text-gray-500 hover:text-gray-700 text-2xl">✕</button>
      </div>
      
      <div class="space-y-4">
        <div class="bg-blue-50 p-4 rounded-lg">
          <h3 class="font-medium text-blue-800 mb-2">Personal Information</h3>
          <p class="text-sm text-blue-700"><strong>Name:</strong> <span id="profile-name"></span></p>
          <p class="text-sm text-blue-700"><strong>Phone:</strong> <span id="profile-phone"></span></p>
          <p class="text-sm text-blue-700"><strong>Email:</strong> <span id="profile-email"></span></p>
        </div>
        
        <div class="bg-green-50 p-4 rounded-lg">
          <h3 class="font-medium text-green-800 mb-2">Delivery Address</h3>
          <p class="text-sm text-green-700" id="profile-address"></p>
        </div>
        
        <div class="bg-gray-50 p-4 rounded-lg">
          <h3 class="font-medium text-gray-800 mb-2">Order History</h3>
          <p class="text-sm text-gray-600">Total Orders: <span id="user-order-count" class="font-medium">0</span></p>
          <p class="text-sm text-gray-600">Total Spent: ₹<span id="user-total-spent" class="font-medium">0</span></p>
        </div>
      </div>
      
      <div class="flex space-x-3 mt-6">
        <button onclick="editUserProfile()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors">Edit Profile</button>
        <button onclick="logoutUser()" class="flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition-colors">Logout</button>
      </div>
    </div>
  </div>

  <!-- My Orders Modal -->
  <div id="my-orders-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-lg p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-semibold">📦 My Orders</h2>
        <button onclick="closeMyOrders()" class="text-gray-500 hover:text-gray-700 text-2xl">✕</button>
      </div>
      
      <!-- Order Filters -->
      <div class="flex flex-wrap gap-3 mb-6">
        <button onclick="filterMyOrders('all')" id="filter-all" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium">All Orders</button>
        <button onclick="filterMyOrders('pending')" id="filter-pending" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300">Pending</button>
        <button onclick="filterMyOrders('processing')" id="filter-processing" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300">Processing</button>
        <button onclick="filterMyOrders('out-for-delivery')" id="filter-out-for-delivery" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300">Out for Delivery</button>
        <button onclick="filterMyOrders('delivered')" id="filter-delivered" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300">Delivered</button>
      </div>
      
      <!-- Orders List -->
      <div id="my-orders-list" class="space-y-4">
        <div class="text-center py-12">
          <div class="text-6xl mb-4">📦</div>
          <h3 class="text-xl font-semibold text-gray-900 mb-2">No orders found</h3>
          <p class="text-gray-600 mb-6">You haven't placed any orders yet</p>
          <button onclick="closeMyOrders()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors">
            Start Shopping
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Location Selection Modal -->
  <div id="location-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-lg p-8 max-w-md w-full">
      <h2 class="text-2xl font-semibold mb-6 text-center">📍 Select Delivery Location</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Enter your area/locality</label>
          <input type="text" id="location-input" placeholder="e.g., Downtown, Main Street, etc." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div class="grid grid-cols-2 gap-2">
          <button onclick="selectLocation('Downtown')" class="p-3 text-left border rounded-lg hover:bg-gray-50">
            <div class="font-medium">Downtown</div>
            <div class="text-xs text-gray-500">30-40 mins</div>
          </button>
          <button onclick="selectLocation('Uptown')" class="p-3 text-left border rounded-lg hover:bg-gray-50">
            <div class="font-medium">Uptown</div>
            <div class="text-xs text-gray-500">35-45 mins</div>
          </button>
          <button onclick="selectLocation('Suburbs')" class="p-3 text-left border rounded-lg hover:bg-gray-50">
            <div class="font-medium">Suburbs</div>
            <div class="text-xs text-gray-500">40-50 mins</div>
          </button>
          <button onclick="selectLocation('City Center')" class="p-3 text-left border rounded-lg hover:bg-gray-50">
            <div class="font-medium">City Center</div>
            <div class="text-xs text-gray-500">25-35 mins</div>
          </button>
        </div>
        <button onclick="confirmLocation()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">Confirm Location</button>
      </div>
    </div>
  </div>

  <!-- Hero Section -->
  <section class="relative bg-gradient-to-br from-gray-900 via-blue-900 to-blue-800 text-white py-12 md:py-20 overflow-hidden">
    <!-- Background Elements -->
    <div class="absolute inset-0">
      <div class="absolute inset-0 bg-gradient-to-br from-blue-600/20 to-transparent"></div>
      <div class="absolute top-0 left-0 w-full h-full opacity-5">
        <svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
              <path d="M 40 0 L 0 0 0 40" fill="none" stroke="white" stroke-width="1"/>
            </pattern>
          </defs>
          <rect width="100%" height="100%" fill="url(#grid)" />
        </svg>
      </div>
    </div>
    
    <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center">
        <div class="fade-in">
          <div class="inline-flex items-center px-4 py-2 bg-blue-500/20 backdrop-blur-sm border border-blue-400/30 rounded-full text-blue-200 text-sm font-medium mb-8">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mr-2">
              <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" fill="currentColor"/>
            </svg>
            Premium Quality • Fast Delivery • Trusted by 1000+ customers
          </div>
          <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold mb-6 leading-tight tracking-tight">
            <span class="block text-white">Fresh Water &</span>
            <span class="block bg-gradient-to-r from-blue-400 via-blue-300 to-cyan-300 bg-clip-text text-transparent">Premium Meat</span>
          </h1>
          <p class="text-lg md:text-xl mb-8 text-gray-300 max-w-3xl mx-auto leading-relaxed font-light">
            Experience the finest quality products delivered fresh to your doorstep. Professional service, guaranteed freshness, and unmatched convenience.
          </p>
        </div>
        
        <!-- CTA Buttons -->
        <div class="fade-in flex flex-col sm:flex-row gap-4 justify-center mb-10">
          <button onclick="document.getElementById('products-container').scrollIntoView({behavior: 'smooth'})" class="group relative bg-white text-gray-900 hover:bg-gray-50 px-8 py-3 rounded-xl font-bold text-base shadow-2xl hover:shadow-3xl transition-all duration-300 transform hover:scale-105 border border-gray-200">
            <span class="flex items-center justify-center space-x-2">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="group-hover:scale-110 transition-transform">
                <path d="M3 3H5L5.4 5M7 13H17L21 5H5.4M7 13L5.4 5M7 13L4.7 15.3C4.3 15.7 4.6 16.5 5.1 16.5H17M17 13V17C17 18.1 16.1 19 15 19H9C7.9 19 7 18.1 7 17V13M9 21C9.6 21 10 20.6 10 20S9.6 19 9 19 8 19.4 8 20 8.4 21 9 21ZM20 21C20.6 21 21 20.6 21 20S20.6 19 20 19 19 19.4 19 20 19.4 21 20 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <span>Shop Now</span>
            </span>
          </button>
          <button onclick="changeLocation()" class="group relative bg-transparent border-2 border-white/30 backdrop-blur-sm text-white hover:bg-white/10 hover:border-white/50 px-8 py-3 rounded-xl font-bold text-base transition-all duration-300 transform hover:scale-105">
            <span class="flex items-center justify-center space-x-2">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="group-hover:scale-110 transition-transform">
                <path d="M21 10C21 17L12 23L3 10C3 6.13 7.03 3 12 3S21 6.13 21 10Z" stroke="currentColor" stroke-width="2"/>
                <circle cx="12" cy="10" r="3" stroke="currentColor" stroke-width="2"/>
              </svg>
              <span>Set Location</span>
            </span>
          </button>
        </div>
        
        <!-- Features Grid -->
        <div class="fade-in grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto">
          <div class="group bg-white/5 backdrop-blur-md rounded-2xl p-6 border border-white/10 hover:bg-white/10 hover:border-white/20 transition-all duration-500">
            <div class="w-12 h-12 bg-gradient-to-br from-blue-400 to-blue-600 rounded-xl flex items-center justify-center mb-4 group-hover:scale-110 transition-transform duration-300">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M13 2L3 14H12L11 22L21 10H12L13 2Z" fill="white"/>
              </svg>
            </div>
            <h3 class="font-bold text-lg mb-2 text-white">Lightning Fast</h3>
            <p class="text-gray-300 text-sm leading-relaxed">Professional 30-45 minute delivery guaranteed with real-time tracking</p>
          </div>
          <div class="group bg-white/5 backdrop-blur-md rounded-2xl p-6 border border-white/10 hover:bg-white/10 hover:border-white/20 transition-all duration-500">
            <div class="w-12 h-12 bg-gradient-to-br from-green-400 to-green-600 rounded-xl flex items-center justify-center mb-4 group-hover:scale-110 transition-transform duration-300">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M9 12L11 14L15 10M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <h3 class="font-bold text-lg mb-2 text-white">Quality Assured</h3>
            <p class="text-gray-300 text-sm leading-relaxed">100% fresh products with professional quality guarantee</p>
          </div>
          <div class="group bg-white/5 backdrop-blur-md rounded-2xl p-6 border border-white/10 hover:bg-white/10 hover:border-white/20 transition-all duration-500">
            <div class="w-12 h-12 bg-gradient-to-br from-purple-400 to-purple-600 rounded-xl flex items-center justify-center mb-4 group-hover:scale-110 transition-transform duration-300">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="1" y="4" width="22" height="16" rx="2" ry="2" stroke="white" stroke-width="2"/>
                <line x1="1" y1="10" x2="23" y2="10" stroke="white" stroke-width="2"/>
              </svg>
            </div>
            <h3 class="font-bold text-lg mb-2 text-white">Secure Payment</h3>
            <p class="text-gray-300 text-sm leading-relaxed">Multiple payment options including cash on delivery and UPI</p>
          </div>
        </div>
        
        <!-- Trust Indicators -->
        <div class="fade-in mt-8 flex flex-wrap justify-center items-center gap-6 text-blue-200">
          <div class="flex items-center space-x-1">
            <span class="text-green-400">✓</span>
            <span class="text-xs font-medium">1000+ Happy Customers</span>
          </div>
          <div class="flex items-center space-x-1">
            <span class="text-green-400">✓</span>
            <span class="text-xs font-medium">Same Day Delivery</span>
          </div>
          <div class="flex items-center space-x-1">
            <span class="text-green-400">✓</span>
            <span class="text-xs font-medium">24/7 Support</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Offer Banner (Hidden by default) -->
  <section id="offer-banner" class="hidden bg-gradient-to-r from-red-500 via-pink-500 to-red-600 text-white py-4 relative overflow-hidden">
    <div class="absolute inset-0 bg-black opacity-10"></div>
    <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <div class="text-3xl animate-bounce">🎉</div>
          <div>
            <h3 id="offer-title" class="text-xl font-bold mb-1">Special Offer!</h3>
            <p id="offer-description" class="text-sm opacity-90">Limited time offer - Don't miss out!</p>
          </div>
        </div>
        <div class="flex items-center space-x-4">
          <div id="offer-discount" class="bg-white text-red-600 px-4 py-2 rounded-full font-bold text-lg shadow-lg">
            50% OFF
          </div>
          <button onclick="hideOfferBanner()" class="text-white hover:text-gray-200 text-2xl">✕</button>
        </div>
      </div>
    </div>
    <!-- Animated background elements -->
    <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
      <div class="absolute -top-4 -left-4 w-8 h-8 bg-white opacity-20 rounded-full animate-ping"></div>
      <div class="absolute top-1/2 left-1/4 w-6 h-6 bg-yellow-300 opacity-30 rounded-full animate-pulse"></div>
      <div class="absolute -bottom-2 right-1/4 w-10 h-10 bg-white opacity-10 rounded-full animate-bounce"></div>
    </div>
  </section>

  <!-- Search and Filter -->
  <section class="py-10 bg-white border-b border-gray-100">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Section Header -->
      <div class="text-center mb-8">
        <div class="inline-flex items-center px-3 py-1 bg-blue-50 border border-blue-200 rounded-full text-blue-700 text-xs font-medium mb-4">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mr-1">
            <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
            <path d="m21 21-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Smart Search & Filtering
        </div>
        <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-3 tracking-tight">Browse Our Products</h2>
        <p class="text-base text-gray-600 max-w-2xl mx-auto leading-relaxed">Find exactly what you need with our intelligent search and filtering system</p>
      </div>
      
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-6 lg:space-y-0 gap-6">
        <!-- Search Bar -->
        <div class="flex-1 max-w-2xl mx-auto lg:mx-0">
          <div class="relative group">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-gray-400 group-focus-within:text-blue-500 transition-colors duration-200">
                <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
                <path d="m21 21-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <input 
              type="text" 
              id="search-input" 
              placeholder="Search for water, chicken, mutton, or any product..." 
              class="w-full pl-12 pr-12 py-3 text-base font-medium bg-white border-2 border-gray-200 rounded-xl shadow-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-100 focus:shadow-lg transition-all duration-300 placeholder-gray-500"
              oninput="searchProducts()"
            >
            <div class="absolute inset-y-0 right-0 pr-4 flex items-center">
              <button id="clear-search" onclick="clearSearch()" class="hidden p-1 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-all duration-200">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
        
        <!-- Filters -->
        <div class="flex flex-col sm:flex-row gap-3">
          <!-- Category Filter -->
          <div class="relative">
            <select 
              id="category-filter" 
              onchange="filterByCategory()" 
              class="form-input appearance-none bg-white px-4 py-3 pr-10 rounded-lg shadow-sm cursor-pointer hover:shadow-md transition-all duration-300 font-medium text-sm"
            >
              <option value="all">🏷️ All Categories</option>
              <option value="water">💧 Water Products</option>
              <option value="chicken">🐔 Chicken</option>
              <option value="mutton">🥩 Mutton</option>
            </select>
            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
              <span class="text-gray-400 text-xs">▼</span>
            </div>
          </div>
          
          <!-- Sort Filter -->
          <div class="relative">
            <select 
              id="sort-filter" 
              onchange="sortProducts()" 
              class="form-input appearance-none bg-white px-4 py-3 pr-10 rounded-lg shadow-sm cursor-pointer hover:shadow-md transition-all duration-300 font-medium text-sm"
            >
              <option value="default">📊 Sort by</option>
              <option value="price-low">💰 Price: Low to High</option>
              <option value="price-high">💸 Price: High to Low</option>
              <option value="popular">⭐ Most Popular</option>
              <option value="newest">🆕 Newest First</option>
            </select>
            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
              <span class="text-gray-400 text-xs">▼</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Quick Filter Tags -->
      <div class="mt-4 flex flex-wrap gap-2 justify-center">
        <button onclick="quickFilter('popular')" class="px-3 py-1.5 bg-blue-50 text-blue-600 rounded-full text-xs font-medium hover:bg-blue-100 transition-colors border border-blue-200">
          ⭐ Popular
        </button>
        <button onclick="quickFilter('under-500')" class="px-3 py-1.5 bg-green-50 text-green-600 rounded-full text-xs font-medium hover:bg-green-100 transition-colors border border-green-200">
          💰 Under ₹500
        </button>
        <button onclick="quickFilter('premium')" class="px-3 py-1.5 bg-purple-50 text-purple-600 rounded-full text-xs font-medium hover:bg-purple-100 transition-colors border border-purple-200">
          👑 Premium
        </button>
        <button onclick="quickFilter('fast-delivery')" class="px-3 py-1.5 bg-orange-50 text-orange-600 rounded-full text-xs font-medium hover:bg-orange-100 transition-colors border border-orange-200">
          ⚡ Fast Delivery
        </button>
      </div>
    </div>
  </section>

  <!-- Products Section -->
  <section class="py-8 bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Results Header -->
      <div class="flex justify-between items-center mb-6">
        <div>
          <h2 class="text-xl font-bold text-gray-900">Our Products</h2>
          <p class="text-gray-600 mt-0.5 text-sm" id="results-count">Showing all products</p>
        </div>
        <div class="flex items-center space-x-2">
          <button onclick="toggleView('grid')" id="grid-view" class="p-2 rounded-lg bg-blue-600 text-white text-sm">
            <span>⊞</span>
          </button>
          <button onclick="toggleView('list')" id="list-view" class="p-2 rounded-lg bg-gray-200 text-gray-600 hover:bg-gray-300 text-sm">
            <span>☰</span>
          </button>
        </div>
      </div>
      
      <!-- Loading State -->
      <div id="loading-products" class="hidden">
        <div class="responsive-grid">
          <div class="skeleton h-80 rounded-2xl"></div>
          <div class="skeleton h-80 rounded-2xl"></div>
          <div class="skeleton h-80 rounded-2xl"></div>
          <div class="skeleton h-80 rounded-2xl"></div>
        </div>
      </div>
      
      <!-- Products Grid -->
      <div id="products-container" class="responsive-grid">
        <!-- Products will be dynamically loaded here -->
      </div>
      
      <!-- No Results State -->
      <div id="no-results" class="hidden text-center py-16">
        <div class="max-w-md mx-auto">
          <div class="text-6xl mb-6">🔍</div>
          <h3 class="text-2xl font-bold text-gray-900 mb-4">No products found</h3>
          <p class="text-gray-600 mb-8">We couldn't find any products matching your search. Try adjusting your filters or search terms.</p>
          <div class="space-y-3">
            <button onclick="clearAllFilters()" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors">
              Clear All Filters
            </button>
            <button onclick="showAllProducts()" class="w-full bg-gray-100 text-gray-700 px-6 py-3 rounded-lg font-medium hover:bg-gray-200 transition-colors">
              Show All Products
            </button>
          </div>
        </div>
      </div>
      
      <!-- Load More Button -->
      <div id="load-more-container" class="hidden text-center mt-12">
        <button onclick="loadMoreProducts()" class="bg-white text-blue-600 border-2 border-blue-600 px-8 py-3 rounded-lg font-medium hover:bg-blue-50 transition-colors">
          Load More Products
        </button>
      </div>
    </div>
  </section>

  <!-- Floating Cart Button -->
  <div id="floating-cart" class="floating-cart hidden">
    <button onclick="openCart()" class="group relative bg-gradient-to-r from-blue-600 to-blue-700 text-white p-4 rounded-2xl shadow-2xl hover:shadow-3xl transition-all duration-300 transform hover:scale-110 border-4 border-white">
      <div class="flex items-center space-x-2">
        <span class="text-2xl group-hover:animate-bounce">🛒</span>
        <div class="hidden sm:block text-left">
          <div class="text-sm font-bold">Cart</div>
          <div class="text-xs opacity-90" id="floating-cart-total">₹0</div>
        </div>
      </div>
      <span id="floating-cart-count" class="cart-badge absolute -top-2 -right-2 bg-gradient-to-r from-red-500 to-red-600 text-white text-xs rounded-full h-7 w-7 flex items-center justify-center font-bold shadow-lg border-2 border-white">0</span>
      
      <!-- Pulse Animation for New Items -->
      <div id="cart-pulse" class="absolute inset-0 bg-blue-400 rounded-2xl opacity-0 animate-ping"></div>
    </button>
  </div>

  <!-- Cart Sidebar -->
  <div id="cart-sidebar" class="fixed right-0 top-0 h-full w-full md:w-96 bg-white shadow-lg transform translate-x-full transition-transform duration-300 z-50">
    <div class="flex flex-col h-full">
      <!-- Cart Header -->
      <div class="p-6 border-b bg-blue-50">
        <div class="flex justify-between items-center">
          <div>
            <h2 class="text-xl font-semibold">Your Order</h2>
            <p class="text-sm text-gray-600" id="cart-items-count">0 items</p>
          </div>
          <button onclick="closeCart()" class="text-gray-500 hover:text-gray-700 text-2xl">✕</button>
        </div>
      </div>

      <!-- Cart Items -->
      <div id="cart-items" class="flex-1 overflow-y-auto p-6">
        <div class="text-center py-12">
          <div class="text-4xl mb-4">🛒</div>
          <p class="text-gray-500">Your cart is empty</p>
          <p class="text-sm text-gray-400 mt-2">Add some delicious items!</p>
        </div>
      </div>

      <!-- Cart Footer -->
      <div class="border-t bg-gray-50 p-6">
        <button id="checkout-btn" onclick="proceedToCheckout()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 disabled:bg-gray-300 transition-colors mb-4" disabled>
          Proceed to Checkout
        </button>
        <div class="space-y-3">
          <div class="flex justify-between text-sm">
            <span>Subtotal:</span>
            <span id="cart-subtotal">₹0</span>
          </div>
          <div id="discount-row" class="hidden">
            <div class="flex justify-between text-sm text-green-600">
              <span id="discount-label">Discount:</span>
              <span id="cart-discount">-₹0</span>
            </div>
            <div class="text-xs text-green-500 mt-1" id="discount-details">
              <span id="discount-description"></span>
            </div>
          </div>
          <div class="flex justify-between text-sm">
            <span>Delivery Fee:</span>
            <span id="delivery-fee">₹40</span>
          </div>
          <div class="border-t pt-2">
            <div class="flex justify-between font-semibold text-lg">
              <span>Total to Pay:</span>
              <span id="cart-total" class="text-blue-600">₹40</span>
            </div>
            <div id="savings-display" class="hidden text-xs text-green-600 mt-1 text-right">
              You save ₹<span id="total-savings">0</span> with this offer!
            </div>
          </div>
        </div>
        <p class="text-xs text-gray-500 text-center mt-2">Free delivery on all orders</p>
      </div>
    </div>
  </div>

  <!-- Checkout Modal -->
  <div id="checkout-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-semibold">Complete Your Order</h2>
        <button onclick="closeCheckout()" class="text-gray-500 hover:text-gray-700 text-2xl">✕</button>
      </div>
      
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Order Summary Section -->
        <div class="order-1 lg:order-2">
          <div class="bg-gray-50 rounded-xl p-6 sticky top-0">
            <h3 class="text-xl font-semibold mb-4 flex items-center">
              <span class="mr-2">📋</span>
              Order Summary
            </h3>
            
            <!-- Order Items -->
            <div class="space-y-3 mb-6 max-h-64 overflow-y-auto">
              <div id="checkout-items-list">
                <!-- Items will be populated here -->
              </div>
            </div>
            
            <!-- Price Breakdown -->
            <div class="border-t pt-4 space-y-3">
              <div class="flex justify-between text-sm">
                <span class="text-gray-600">Subtotal (<span id="checkout-item-count">0</span> items)</span>
                <span class="font-medium" id="checkout-subtotal">₹0</span>
              </div>
              
              <div id="checkout-discount-row" class="hidden">
                <div class="flex justify-between text-sm text-green-600">
                  <span class="flex items-center">
                    <span class="mr-1">🎉</span>
                    <span id="checkout-discount-label">Discount</span>
                  </span>
                  <span class="font-medium" id="checkout-discount-amount">-₹0</span>
                </div>
                <div class="text-xs text-green-500 mt-1" id="checkout-discount-description">
                  <!-- Discount description -->
                </div>
              </div>
              
              <div class="flex justify-between text-sm">
                <span class="text-gray-600">Delivery Fee</span>
                <span class="font-medium" id="checkout-delivery-fee">₹40</span>
              </div>
              
              <div class="border-t pt-3">
                <div class="flex justify-between items-center">
                  <span class="text-lg font-semibold">Total Amount</span>
                  <div class="text-right">
                    <div class="text-2xl font-bold text-blue-600" id="checkout-total">₹0</div>
                    <div id="checkout-savings" class="hidden text-sm text-green-600 font-medium">
                      You save ₹<span id="checkout-total-savings">0</span>!
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Offer Applied Badge -->
              <div id="checkout-offer-badge" class="hidden bg-green-100 border border-green-300 rounded-lg p-3 mt-4">
                <div class="flex items-center text-green-800">
                  <span class="text-lg mr-2">🎉</span>
                  <div>
                    <div class="font-semibold text-sm" id="checkout-offer-title">Offer Applied</div>
                    <div class="text-xs" id="checkout-offer-details">Special discount applied to your order</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Delivery Details Section -->
        <div class="order-2 lg:order-1">
          <h3 class="text-xl font-semibold mb-4 flex items-center">
            <span class="mr-2">🚚</span>
            Delivery Details
          </h3>
          
          <!-- User Info Display (for logged in users) -->
          <div id="logged-user-info" class="hidden mb-6 p-4 bg-blue-50 rounded-lg">
            <h4 class="font-medium text-blue-800 mb-2">Delivering to:</h4>
            <p class="text-sm text-blue-700"><strong>Name:</strong> <span id="checkout-user-name"></span></p>
            <p class="text-sm text-blue-700"><strong>Phone:</strong> <span id="checkout-user-phone"></span></p>
            <p class="text-sm text-blue-700"><strong>Address:</strong> <span id="checkout-user-address"></span></p>
            <button onclick="editDeliveryDetails()" class="text-xs text-blue-600 hover:text-blue-800 mt-2">Change delivery details</button>
          </div>
          
          <form id="checkout-form">
            <div id="guest-checkout-fields">
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Full Name *</label>
                <input type="text" id="customer-name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number *</label>
                <input type="tel" id="customer-phone" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Complete Address *</label>
                <textarea id="customer-address" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="3" placeholder="House/Flat no, Street, Landmark"></textarea>
              </div>
            </div>
            
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">Delivery Time</label>
              <select id="delivery-time" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option>ASAP (30-45 mins)</option>
                <option>1-2 hours</option>
                <option>2-4 hours</option>
                <option>Tomorrow morning (9-12 PM)</option>
                <option>Tomorrow evening (5-8 PM)</option>
              </select>
            </div>
            
            <!-- Promo Code Section -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">Promo Code (Optional)</label>
              <div class="flex space-x-2">
                <input type="text" id="promo-code-input" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter promo code">
                <button type="button" onclick="applyPromoCode()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors font-medium">Apply</button>
              </div>
              <div id="promo-code-success" class="hidden mt-2 p-2 bg-green-50 rounded text-sm text-green-800">
                ✅ <span id="promo-success-text">Promo code applied successfully!</span>
              </div>
              <div id="promo-code-error" class="hidden mt-2 p-2 bg-red-50 rounded text-sm text-red-800">
                ❌ <span id="promo-error-text">Invalid or expired promo code</span>
              </div>
            </div>

            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">Payment Method</label>
              <div class="space-y-3">
                <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                  <input type="radio" name="payment" value="cod" checked class="mr-3">
                  <div class="flex items-center">
                    <span class="text-2xl mr-3">💵</span>
                    <div>
                      <div class="font-medium">Cash on Delivery</div>
                      <div class="text-sm text-gray-500">Pay when your order arrives</div>
                    </div>
                  </div>
                </label>
                <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                  <input type="radio" name="payment" value="upi" class="mr-3">
                  <div class="flex items-center">
                    <span class="text-2xl mr-3">📱</span>
                    <div>
                      <div class="font-medium">UPI Payment</div>
                      <div class="text-sm text-gray-500">Pay instantly via UPI (Real payment required)</div>
                    </div>
                  </div>
                </label>
              </div>
              <div id="upi-details" class="hidden mt-3 p-3 bg-blue-50 rounded-lg">
                <p class="text-sm text-blue-800 font-medium">⚠️ Real UPI Payment Required:</p>
                <p class="text-sm text-blue-700 mt-1">Pay to UPI ID: <span class="font-mono bg-white px-2 py-1 rounded">9603831708@ybl</span></p>
                <p class="text-xs text-blue-600 mt-1">You must complete actual payment from your UPI app. Order will be confirmed only after successful payment.</p>
              </div>
              <p id="payment-warning" class="text-red-500 text-sm hidden mt-1">⚠️ Orders above ₹500 require online payment.</p>
            </div>
            
            <div class="mb-6">
              <label class="block text-sm font-medium text-gray-700 mb-2">Special Instructions</label>
              <textarea id="special-instructions" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="2" placeholder="Any special delivery instructions..."></textarea>
            </div>
            
            <div class="flex space-x-4">
              <button type="button" onclick="closeCheckout()" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition-colors font-medium">Cancel</button>
              <button type="submit" id="place-order-btn" class="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors font-bold">
                <span class="flex items-center justify-center">
                  <span class="mr-2">🛒</span>
                  <span>Place Order</span>
                </span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg p-8 max-w-md w-full text-center">
      <div class="text-6xl mb-4">✅</div>
      <h2 class="text-2xl font-semibold mb-4">Order Placed Successfully!</h2>
      <div class="bg-gray-50 p-4 rounded-lg mb-6">
        <p class="text-sm text-gray-600 mb-1">Order #<span id="order-number" class="font-bold"></span></p>
        <p class="text-sm text-gray-600">Estimated delivery: <span id="estimated-delivery" class="font-medium"></span></p>
      </div>
      <p class="text-gray-600 mb-6">We'll call you to confirm your order and provide delivery updates.</p>
      <div class="flex space-x-3">
        <button onclick="closeSuccess()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors">Continue Shopping</button>
        <button onclick="trackOrder()" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">Track Order</button>
      </div>
    </div>
  </div>

  <!-- Order Tracking Modal -->
  <div id="tracking-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-semibold">🚚 Track Your Order</h2>
        <button onclick="closeTracking()" class="text-gray-500 hover:text-gray-700 text-2xl">✕</button>
      </div>
      
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Order Status Section -->
        <div>
          <div class="bg-blue-50 p-4 rounded-lg mb-4">
            <p class="text-sm text-gray-600">Order #<span id="tracking-order-id" class="font-bold"></span></p>
            <p class="text-sm text-gray-600">Placed: <span id="tracking-order-time" class="font-medium"></span></p>
            <p class="text-lg font-semibold text-blue-600 mt-2">Total: ₹<span id="tracking-order-total"></span></p>
          </div>
          
          <!-- Delivery Person Info -->
          <div id="delivery-person-info" class="bg-green-50 p-4 rounded-lg mb-4 hidden">
            <div class="flex items-center space-x-3 mb-3">
              <div class="w-12 h-12 bg-green-600 rounded-full flex items-center justify-center">
                <span class="text-white font-bold text-lg" id="delivery-person-initial">D</span>
              </div>
              <div>
                <h4 class="font-semibold text-green-800" id="delivery-person-name">Delivery Partner</h4>
                <p class="text-sm text-green-600" id="delivery-person-phone">📞 Contact: +91-XXXXXXXXXX</p>
              </div>
            </div>
            <div class="flex items-center justify-between">
              <div class="text-sm text-green-700">
                <p>🛵 Vehicle: <span id="delivery-vehicle">Bike</span></p>
                <p>📍 Distance: <span id="delivery-distance">Calculating...</span></p>
                <p>⏱️ ETA: <span id="delivery-eta">Calculating...</span></p>
              </div>
              <div class="flex space-x-2">
                <button onclick="callDeliveryPerson()" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                  📞 Call
                </button>
                <button onclick="messageDeliveryPerson()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                  💬 Message
                </button>
              </div>
            </div>
          </div>
          
          <div class="space-y-4">
            <div id="status-pending" class="flex items-center p-3 rounded-lg bg-yellow-50 border-l-4 border-yellow-400">
              <div class="flex-shrink-0 w-8 h-8 bg-yellow-400 rounded-full flex items-center justify-center text-white font-bold text-sm">1</div>
              <div class="ml-4">
                <p class="font-medium text-yellow-800">Order Confirmed</p>
                <p class="text-sm text-yellow-600">Your order has been received and confirmed</p>
              </div>
            </div>
            
            <div id="status-processing" class="flex items-center p-3 rounded-lg bg-gray-50 border-l-4 border-gray-300">
              <div class="flex-shrink-0 w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center text-white font-bold text-sm">2</div>
              <div class="ml-4">
                <p class="font-medium text-gray-600">Preparing Order</p>
                <p class="text-sm text-gray-500">Your order is being prepared</p>
              </div>
            </div>
            
            <div id="status-ready" class="flex items-center p-3 rounded-lg bg-gray-50 border-l-4 border-gray-300">
              <div class="flex-shrink-0 w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center text-white font-bold text-sm">3</div>
              <div class="ml-4">
                <p class="font-medium text-gray-600">Ready for Delivery</p>
                <p class="text-sm text-gray-500">Order is ready and will be dispatched soon</p>
              </div>
            </div>
            
            <div id="status-out-for-delivery" class="flex items-center p-3 rounded-lg bg-gray-50 border-l-4 border-gray-300">
              <div class="flex-shrink-0 w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center text-white font-bold text-sm">4</div>
              <div class="ml-4">
                <p class="font-medium text-gray-600">Out for Delivery</p>
                <p class="text-sm text-gray-500">Your order is on the way</p>
              </div>
            </div>
            
            <div id="status-delivered" class="flex items-center p-3 rounded-lg bg-gray-50 border-l-4 border-gray-300">
              <div class="flex-shrink-0 w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center text-white font-bold text-sm">5</div>
              <div class="ml-4">
                <p class="font-medium text-gray-600">Delivered</p>
                <p class="text-sm text-gray-500">Order has been delivered successfully</p>
              </div>
            </div>
          </div>
          
          <div class="bg-gray-50 p-4 rounded-lg mt-4">
            <h4 class="font-medium mb-2">Order Items:</h4>
            <div id="tracking-items" class="space-y-1">
              <!-- Items will be loaded here -->
            </div>
          </div>
        </div>
        
        <!-- Live GPS Tracking Section -->
        <div>
          <div class="bg-white border rounded-lg overflow-hidden">
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-4">
              <div class="flex items-center justify-between">
                <h3 class="font-semibold">📍 Live GPS Tracking</h3>
                <div class="flex items-center space-x-2">
                  <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                  <span class="text-sm">Live</span>
                </div>
              </div>
            </div>
            
            <!-- Map Container -->
            <div id="tracking-map" class="h-80 bg-gray-100 relative overflow-hidden">
              <!-- Google Map will be rendered here -->
              <div id="google-map" class="w-full h-full"></div>
              <div id="map-loading" class="absolute inset-0 flex items-center justify-center bg-white">
                <div class="text-center">
                  <div class="text-4xl mb-2">🗺️</div>
                  <p class="text-gray-600">Loading Google Maps...</p>
                </div>
              </div>
            </div>
            
            <!-- Map Controls -->
            <div class="p-4 bg-gray-50 border-t">
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center space-x-2">
                  <button onclick="centerMapOnDelivery()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                    🎯 Center on Delivery
                  </button>
                  <button onclick="centerMapOnCustomer()" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                    🏠 My Location
                  </button>
                </div>
                <button onclick="toggleMapFullscreen()" class="bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700">
                  ⛶ Fullscreen
                </button>
              </div>
              
              <!-- Enhanced Location Updates -->
              <div class="text-xs text-gray-600 space-y-1">
                <p>Last updated: <span id="location-last-update">Just now</span></p>
                <p>Accuracy: <span id="location-accuracy">High</span> | Speed: <span id="delivery-speed">0 km/h</span></p>
                <p>Connection: <span id="connection-status">🟢 Connected</span></p>
              </div>
            </div>
          </div>
          
          <!-- Delivery Updates Timeline -->
          <div class="mt-4 bg-white border rounded-lg p-4">
            <h4 class="font-semibold mb-3">📱 Live Updates</h4>
            <div id="delivery-updates" class="space-y-2 max-h-32 overflow-y-auto">
              <div class="text-sm text-gray-600 bg-blue-50 p-2 rounded">
                <span class="font-medium">Just now:</span> Tracking started
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- GPS Fullscreen Map Modal -->
  <div id="fullscreen-map-modal" class="fixed inset-0 bg-black bg-opacity-90 hidden z-50">
    <div class="h-full flex flex-col">
      <div class="bg-white p-4 flex items-center justify-between">
        <h3 class="font-semibold">📍 Live GPS Tracking - Order #<span id="fullscreen-order-id"></span></h3>
        <div class="flex items-center space-x-4">
          <div class="flex items-center space-x-2">
            <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
            <span class="text-sm">Live Tracking</span>
          </div>
          <button onclick="closeFullscreenMap()" class="text-gray-500 hover:text-gray-700 text-2xl">✕</button>
        </div>
      </div>
      <div id="fullscreen-map" class="flex-1 bg-gray-100 relative">
        <!-- Fullscreen Google Map will be rendered here -->
        <div id="fullscreen-google-map" class="w-full h-full"></div>
        <div id="fullscreen-map-loading" class="absolute inset-0 flex items-center justify-center bg-white">
          <div class="text-center">
            <div class="text-4xl mb-2">🗺️</div>
            <p class="text-gray-600">Loading Google Maps...</p>
          </div>
        </div>
      </div>
      <div class="bg-white p-4 border-t">
        <div class="flex items-center justify-between">
          <div class="text-sm">
            <span class="font-medium" id="fullscreen-delivery-person">Delivery Partner</span> • 
            <span id="fullscreen-distance">Distance: Calculating...</span> • 
            <span id="fullscreen-eta">ETA: Calculating...</span>
          </div>
          <div class="flex space-x-2">
            <button onclick="callDeliveryPerson()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
              📞 Call Driver
            </button>
            <button onclick="shareTrackingLink()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
              📤 Share Tracking
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin Login Modal -->
  <div id="admin-login-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg p-8 max-w-md w-full">
      <h2 class="text-2xl font-semibold mb-6 text-center">🔐 Admin Login</h2>
      <form id="admin-login-form">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Admin Password</label>
          <input type="password" id="admin-password" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter admin password">
          <p id="password-error" class="text-red-500 text-sm hidden mt-1">❌ Incorrect password. Please try again.</p>
        </div>
        <div class="flex space-x-4">
          <button type="button" onclick="closeAdminLogin()" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-colors">Cancel</button>
          <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors">Login</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Admin Password Change Modal -->
  <div id="admin-password-change-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg p-8 max-w-md w-full">
      <h2 class="text-2xl font-semibold mb-6 text-center">🔑 Change Admin Password</h2>
      <form id="admin-password-change-form">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Current Password</label>
          <input type="password" id="current-admin-password" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter current password">
          <p id="current-password-error" class="text-red-500 text-sm hidden mt-1">❌ Current password is incorrect.</p>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">New Password</label>
          <input type="password" id="new-admin-password" required minlength="6" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter new password (min 6 characters)">
        </div>
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">Confirm New Password</label>
          <input type="password" id="confirm-admin-password" required minlength="6" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Confirm new password">
          <p id="password-match-error" class="text-red-500 text-sm hidden mt-1">❌ Passwords do not match.</p>
        </div>
        <div class="flex space-x-4">
          <button type="button" onclick="closeAdminPasswordChange()" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-colors">Cancel</button>
          <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors">Change Password</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Admin Panel -->
  <div id="admin-panel" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg p-8 max-w-6xl w-full max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-6">
        <div>
          <h2 class="text-2xl font-semibold">Admin Panel - Product Management</h2>
          <p class="text-sm text-gray-600">Manage products, prices, and orders</p>
        </div>
        <button onclick="toggleAdmin()" class="text-gray-500 hover:text-gray-700 text-2xl">✕</button>
      </div>

      <!-- Admin Tabs -->
      <div class="flex justify-between items-center mb-4 border-b">
        <div class="flex space-x-3">
          <button onclick="showAdminTab('products')" id="products-tab" class="px-3 py-2 border-b-2 border-blue-600 text-blue-600 font-medium text-sm">Products</button>
          <button onclick="showAdminTab('orders')" id="orders-tab" class="px-3 py-2 text-gray-600 hover:text-blue-600 text-sm">Orders</button>
          <button onclick="showAdminTab('offers')" id="offers-tab" class="px-3 py-2 text-gray-600 hover:text-blue-600 text-sm">Offers</button>
        </div>
        <button onclick="showAdminPasswordChange()" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1.5 rounded-lg text-xs font-medium transition-colors">
          🔑 Change Password
        </button>
      </div>

      <!-- Products Management -->
      <div id="admin-products" class="space-y-6">
        <!-- Add New Product -->
        <div class="bg-gray-50 p-4 rounded-lg">
          <h3 class="text-base font-semibold mb-3">Add New Product</h3>
          <form id="add-product-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Product Name</label>
              <input type="text" id="new-product-name" required class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-blue-500">
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Price (₹)</label>
              <input type="number" id="new-product-price" step="1" required class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-blue-500">
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Category</label>
              <select id="new-product-category" required class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-blue-500">
                <option value="">Select Category</option>
                <option value="water">Water</option>
                <option value="chicken">Chicken</option>
                <option value="mutton">Mutton</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Product Photo</label>
              <input type="file" id="new-product-photo" accept="image/*" class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-blue-500">
              <p class="text-xs text-gray-500 mt-0.5">JPG, PNG, GIF (max 5MB)</p>
              <div id="photo-preview" class="mt-1 hidden">
                <img id="preview-image" class="w-16 h-16 object-cover rounded border">
              </div>
            </div>
            <div class="md:col-span-2">
              <label class="block text-xs font-medium text-gray-700 mb-1">Description</label>
              <input type="text" id="new-product-description" required class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-blue-500">
            </div>
            <div class="flex items-center">
              <input type="checkbox" id="new-product-popular" class="mr-1">
              <label class="text-xs text-gray-700">Mark as Popular</label>
            </div>
            <div class="md:col-span-2 lg:col-span-1">
              <button type="submit" class="w-full bg-blue-600 text-white py-1.5 rounded text-sm hover:bg-blue-700 transition-colors">Add Product</button>
            </div>
          </form>
        </div>

        <!-- Existing Products -->
        <div>
          <h3 class="text-base font-semibold mb-3">Existing Products</h3>
          <div id="admin-products-list" class="space-y-3">
            <!-- Products will be loaded here -->
          </div>
        </div>
      </div>

      <!-- Offers Management -->
      <div id="admin-offers" class="hidden space-y-6">
        <!-- Create New Offer -->
        <div class="bg-gray-50 p-4 rounded-lg">
          <h3 class="text-base font-semibold mb-3">Create New Offer</h3>
          <form id="create-offer-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Offer Title</label>
              <input type="text" id="offer-title-input" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g., Weekend Special">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Offer Description</label>
              <input type="text" id="offer-desc-input" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g., Get amazing discounts this weekend">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Discount Type</label>
              <select id="discount-type" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                <option value="">Select Type</option>
                <option value="percentage">Percentage Off (%)</option>
                <option value="fixed">Fixed Amount Off (₹)</option>
                <option value="free-delivery">Free Delivery</option>
                <option value="buy-get">Buy X Get Y</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Discount Value</label>
              <input type="number" id="discount-value" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g., 20 for 20% or 100 for ₹100">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Minimum Order (₹)</label>
              <input type="number" id="min-order-value" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="0 for no minimum">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Valid Until</label>
              <input type="datetime-local" id="offer-expiry" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-2">Offer Code (Optional)</label>
              <input type="text" id="offer-code" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g., WEEKEND20">
            </div>
            <div class="flex items-center space-x-4">
              <label class="flex items-center">
                <input type="checkbox" id="show-banner" class="mr-2">
                <span class="text-sm text-gray-700">Show Banner on Homepage</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" id="auto-apply" class="mr-2">
                <span class="text-sm text-gray-700">Auto Apply (No Code Required)</span>
              </label>
            </div>
            <div class="md:col-span-2 lg:col-span-1">
              <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors">Create Offer</button>
            </div>
          </form>
        </div>

        <!-- Active Offers -->
        <div>
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">Active Offers</h3>
            <button onclick="refreshOffers()" class="text-sm bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded">🔄 Refresh</button>
          </div>
          <div id="active-offers-list" class="space-y-4">
            <p class="text-gray-500 text-center py-8">No active offers</p>
          </div>
        </div>
      </div>

      <!-- Orders Management -->
      <div id="admin-orders" class="hidden space-y-6">
        <div class="flex justify-between items-center">
          <h3 class="text-lg font-semibold">Recent Orders</h3>
          <div class="flex space-x-2">
            <select id="order-status-filter" onchange="filterOrdersByStatus()" class="text-sm px-3 py-1 border rounded">
              <option value="all">All Orders</option>
              <option value="pending">Pending</option>
              <option value="processing">Processing</option>
              <option value="delivered">Delivered</option>
              <option value="cancelled">Cancelled</option>
            </select>
            <button onclick="refreshOrders()" class="text-sm bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded">🔄 Refresh</button>
          </div>
        </div>
        <div id="admin-orders-list">
          <p class="text-gray-500 text-center py-8">No orders yet</p>
        </div>
      </div>
    </div>
  </div>

  <!-- UPI Payment Modal -->
  <div id="upi-payment-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg p-8 max-w-md w-full">
      <div class="text-center mb-6">
        <div class="text-4xl mb-4">💳</div>
        <h2 class="text-2xl font-semibold mb-2">Complete Payment</h2>
        <p class="text-gray-600">Choose your preferred UPI app to pay</p>
      </div>
      
      <div class="bg-blue-50 p-4 rounded-lg mb-6">
        <div class="flex justify-between items-center mb-2">
          <span class="text-sm text-gray-600">Order #<span id="upi-order-id"></span></span>
          <span class="font-bold text-blue-600">₹<span id="upi-amount"></span></span>
        </div>
        <p class="text-sm text-gray-600">Pay to: <span class="font-mono bg-white px-2 py-1 rounded">9603831708@ybl</span></p>
      </div>

      <div class="space-y-3 mb-6">
        <button onclick="payWithUPI('phonepe')" class="w-full flex items-center justify-center space-x-3 bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 transition-colors">
          <span class="text-xl">📱</span>
          <span class="font-medium">Pay with PhonePe</span>
        </button>
        
        <button onclick="payWithUPI('googlepay')" class="w-full flex items-center justify-center space-x-3 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors">
          <span class="text-xl">💳</span>
          <span class="font-medium">Pay with Google Pay</span>
        </button>
        
        <button onclick="payWithUPI('paytm')" class="w-full flex items-center justify-center space-x-3 bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 transition-colors">
          <span class="text-xl">💰</span>
          <span class="font-medium">Pay with Paytm</span>
        </button>
        
        <button onclick="payWithUPI('generic')" class="w-full flex items-center justify-center space-x-3 bg-gray-600 text-white py-3 rounded-lg hover:bg-gray-700 transition-colors">
          <span class="text-xl">🏦</span>
          <span class="font-medium">Other UPI Apps</span>
        </button>
      </div>

      <div class="text-center">
        <button onclick="cancelUPIPayment()" class="text-gray-500 hover:text-gray-700 text-sm">Cancel Payment</button>
      </div>
    </div>
  </div>

  <!-- Payment Processing Modal -->
  <div id="payment-processing-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg p-8 max-w-md w-full text-center">
      <div class="text-4xl mb-4">💳</div>
      <h2 class="text-2xl font-semibold mb-4 text-red-600">⚠️ REAL PAYMENT REQUIRED</h2>
      <p class="text-gray-800 mb-6 font-medium">Complete the ACTUAL MONEY TRANSFER in your UPI app. This is not a demo - real payment is required!</p>
      
      <div class="bg-red-50 p-4 rounded-lg mb-6 border-l-4 border-red-500">
        <div class="flex items-center justify-center space-x-2 mb-2">
          <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-red-600"></div>
          <span class="text-sm text-red-800 font-bold">Waiting for REAL payment...</span>
        </div>
        <p class="text-xs text-red-700 font-medium">🚨 ACTUAL MONEY TRANSFER REQUIRED - NOT A SIMULATION</p>
      </div>

      <div class="text-sm text-gray-700 space-y-2 bg-yellow-50 p-4 rounded-lg mb-4">
        <p class="font-bold text-yellow-800">📱 Steps to Complete Payment:</p>
        <p>1. ✓ UPI app should have opened</p>
        <p>2. ✓ Verify amount and UPI ID: 9603831708@ybl</p>
        <p>3. 🔴 COMPLETE THE ACTUAL PAYMENT</p>
        <p>4. 📝 Note down your transaction ID</p>
        <p class="text-xs text-red-600 mt-2 font-bold">⚠️ Order confirmed ONLY after real money transfer</p>
      </div>
      
      <div class="mt-6 space-y-2">
        <button onclick="manualPaymentConfirmation()" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 font-bold">
          ✅ I've Completed the REAL Payment
        </button>
        <button onclick="cancelUPIPayment()" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 text-sm">
          ❌ Cancel Order (No Payment Made)
        </button>
      </div>
      
      <p class="text-xs text-gray-500 mt-4">💡 Tip: Keep your UPI app transaction history ready for verification</p>
    </div>
  </div>

  <!-- Payment Success Modal -->
  <div id="payment-success-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg p-8 max-w-md w-full text-center">
      <div class="text-6xl mb-4">✅</div>
      <h2 class="text-2xl font-semibold mb-4 text-green-600">Payment Successful!</h2>
      <p class="text-gray-600 mb-4">Your payment has been processed successfully.</p>
      
      <div class="bg-green-50 p-4 rounded-lg mb-6">
        <p class="text-sm text-green-800 mb-1">Transaction ID: <span id="transaction-id" class="font-mono"></span></p>
        <p class="text-sm text-green-800">Amount: ₹<span id="paid-amount"></span></p>
      </div>

      <p class="text-gray-600 mb-6">Your order has been confirmed and is being processed.</p>
      
      <div class="flex space-x-3">
        <button onclick="closePaymentSuccess()" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-colors">Continue Shopping</button>
        <button onclick="trackOrderFromPayment()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors">Track Order</button>
      </div>
    </div>
  </div>

  <!-- Payment Failed Modal -->
  <div id="payment-failed-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg p-8 max-w-md w-full text-center">
      <div class="text-6xl mb-4">❌</div>
      <h2 class="text-2xl font-semibold mb-4 text-red-600">Payment Failed</h2>
      <p class="text-gray-600 mb-4">We couldn't process your payment. Please try again.</p>
      
      <div class="bg-red-50 p-4 rounded-lg mb-6">
        <p class="text-sm text-red-800 mb-1">Reason: <span id="failure-reason">Transaction was cancelled or failed</span></p>
        <p class="text-sm text-red-800">Order #<span id="failed-order-id"></span> has been cancelled</p>
      </div>

      <div class="flex space-x-3">
        <button onclick="retryPayment()" class="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium">
          🔄 Try Again
        </button>
        <button onclick="switchToCOD()" class="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors font-medium">
          💵 Pay on Delivery
        </button>
      </div>
      
      <button onclick="cancelFailedOrder()" class="w-full mt-3 text-gray-500 hover:text-gray-700 text-sm">Cancel Order</button>
    </div>
  </div>

  <!-- Cart Overlay -->
  <div id="cart-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-40" onclick="closeCart()"></div>

  <script>
    // Product Database
    let products = [
      // Water Products
      { id: 1, name: "Pure Spring Water", price: 299, category: "water", image: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjRTBGN0ZBIiByeD0iMTAiLz4KPHN2ZyB4PSIyNSIgeT0iMjAiIHdpZHRoPSI1MCIgaGVpZ2h0PSI2MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjMzMzIj4KPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGZpbGw9Im5vbmUiIHZpZXdCb3g9IjAgMCAyNCAyNCIgc3Ryb2tlLXdpZHRoPSIxLjUiIHN0cm9rZT0iIzMzOTNERiI+CiAgPHBhdGggc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBkPSJNMTIgMTguNzVhNi4wMDcgNi4wMDcgMCAwIDEtNi02VjZhNiA2IDAgMCAxIDEyIDB2Ni43NWE2LjAwNyA2LjAwNyAwIDAgMS02IDZaIiAvPgogIDxwYXRoIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgZD0iTTEyIDEyLjc1YTIuMjUgMi4yNSAwIDEgMSAwLTQuNSAyLjI1IDIuMjUgMCAwIDEgMCA0LjVaIiAvPgo8L3N2Zz4KPC9zdmc+Cjx0ZXh0IHg9IjUwIiB5PSI5MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzMzOTNERiIgZm9udC1zaXplPSIxMiIgZm9udC1mYW1pbHk9IkFyaWFsIj5XYXRlcjwvdGV4dD4KPC9zdmc+", description: "5L bottle of natural spring water", popular: true },
      { id: 2, name: "Alkaline Water", price: 199, category: "water", image: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjRTBGN0ZBIiByeD0iMTAiLz4KPHN2ZyB4PSIyNSIgeT0iMjAiIHdpZHRoPSI1MCIgaGVpZ2h0PSI2MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjMzMzIj4KPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGZpbGw9Im5vbmUiIHZpZXdCb3g9IjAgMCAyNCAyNCIgc3Ryb2tlLXdpZHRoPSIxLjUiIHN0cm9rZT0iIzMzOTNERiI+CiAgPHBhdGggc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBkPSJNMTIgMTguNzVhNi4wMDcgNi4wMDcgMCAwIDEtNi02VjZhNiA2IDAgMCAxIDEyIDB2Ni43NWE2LjAwNyA2LjAwNyAwIDAgMS02IDZaIiAvPgogIDxwYXRoIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgZD0iTTEyIDEyLjc1YTIuMjUgMi4yNSAwIDEgMSAwLTQuNSAyLjI1IDIuMjUgMCAwIDEgMCA0LjVaIiAvPgo8L3N2Zz4KPC9zdmc+Cjx0ZXh0IHg9IjUwIiB5PSI5MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzMzOTNERiIgZm9udC1zaXplPSIxMiIgZm9udC1mYW1pbHk9IkFyaWFsIj5BbGthbGluZTwvdGV4dD4KPC9zdmc+", description: "1.5L pH balanced alkaline water", popular: false },
      { id: 3, name: "Sparkling Water", price: 149, category: "water", image: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjRTBGN0ZBIiByeD0iMTAiLz4KPHN2ZyB4PSIyNSIgeT0iMjAiIHdpZHRoPSI1MCIgaGVpZ2h0PSI2MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjMzMzIj4KPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGZpbGw9Im5vbmUiIHZpZXdCb3g9IjAgMCAyNCAyNCIgc3Ryb2tlLXdpZHRoPSIxLjUiIHN0cm9rZT0iIzMzOTNERiI+CiAgPHBhdGggc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBkPSJNMTIgMTguNzVhNi4wMDcgNi4wMDcgMCAwIDEtNi02VjZhNiA2IDAgMCAxIDEyIDB2Ni43NWE2LjAwNyA2LjAwNyAwIDAgMS02IDZaIiAvPgogIDxwYXRoIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgZD0iTTEyIDEyLjc1YTIuMjUgMi4yNSAwIDEgMSAwLTQuNSAyLjI1IDIuMjUgMCAwIDEgMCA0LjVaIiAvPgo8L3N2Zz4KPC9zdmc+Cjx0ZXh0IHg9IjUwIiB5PSI5MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzMzOTNERiIgZm9udC1zaXplPSIxMiIgZm9udC1mYW1pbHk9IkFyaWFsIj5TcGFya2xpbmc8L3RleHQ+Cjwvc3ZnPg==", description: "500ml premium sparkling water", popular: true },
      { id: 4, name: "Mineral Water", price: 229, category: "water", image: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjRTBGN0ZBIiByeD0iMTAiLz4KPHN2ZyB4PSIyNSIgeT0iMjAiIHdpZHRoPSI1MCIgaGVpZ2h0PSI2MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjMzMzIj4KPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGZpbGw9Im5vbmUiIHZpZXdCb3g9IjAgMCAyNCAyNCIgc3Ryb2tlLXdpZHRoPSIxLjUiIHN0cm9rZT0iIzMzOTNERiI+CiAgPHBhdGggc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBkPSJNMTIgMTguNzVhNi4wMDcgNi4wMDcgMCAwIDEtNi02VjZhNiA2IDAgMCAxIDEyIDB2Ni43NWE2LjAwNyA2LjAwNyAwIDAgMS02IDZaIiAvPgogIDxwYXRoIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgZD0iTTEyIDEyLjc1YTIuMjUgMi4yNSAwIDEgMSAwLTQuNSAyLjI1IDIuMjUgMCAwIDEgMCA0LjVaIiAvPgo8L3N2Zz4KPC9zdmc+Cjx0ZXh0IHg9IjUwIiB5PSI5MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzMzOTNERiIgZm9udC1zaXplPSIxMiIgZm9udC1mYW1pbHk9IkFyaWFsIj5NaW5lcmFsPC90ZXh0Pgo8L3N2Zz4=", description: "2L enriched mineral water", popular: false },
      
      // Chicken Products
      { id: 9, name: "Fresh Chicken Breast", price: 999, category: "chicken", image: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjRkVGM0M3IiByeD0iMTAiLz4KPHN2ZyB4PSIyNSIgeT0iMjAiIHdpZHRoPSI1MCIgaGVpZ2h0PSI2MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjRjU5RTBCIj4KICA8cGF0aCBkPSJNMTIgMmMtMS4xIDAtMiAuOS0yIDJ2NGMwIDEuMS45IDIgMiAyaDJjMS4xIDAgMi0uOSAyLTJWNGMwLTEuMS0uOS0yLTItMmgtMnptMCA2Yy0xLjEgMC0yIC45LTIgMnY0YzAgMS4xLjkgMiAyIDJoMmMxLjEgMCAyLS45IDItMnYtNGMwLTEuMS0uOS0yLTItMmgtMnptMCA2Yy0xLjEgMC0yIC45LTIgMnY0YzAgMS4xLjkgMiAyIDJoMmMxLjEgMCAyLS45IDItMnYtNGMwLTEuMS0uOS0yLTItMmgtMnoiLz4KPC9zdmc+Cjx0ZXh0IHg9IjUwIiB5PSI5MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iI0Y1OUUwQiIgZm9udC1zaXplPSIxMiIgZm9udC1mYW1pbHk9IkFyaWFsIj5DaGlja2VuPC90ZXh0Pgo8L3N2Zz4=", description: "1kg boneless chicken breast", popular: true },
      { id: 10, name: "Chicken Wings", price: 699, category: "chicken", image: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjRkVGM0M3IiByeD0iMTAiLz4KPHN2ZyB4PSIyNSIgeT0iMjAiIHdpZHRoPSI1MCIgaGVpZ2h0PSI2MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjRjU5RTBCIj4KICA8cGF0aCBkPSJNMTIgMmMtMS4xIDAtMiAuOS0yIDJ2NGMwIDEuMS45IDIgMiAyaDJjMS4xIDAgMi0uOSAyLTJWNGMwLTEuMS0uOS0yLTItMmgtMnptMCA2Yy0xLjEgMC0yIC45LTIgMnY0YzAgMS4xLjkgMiAyIDJoMmMxLjEgMCAyLS45IDItMnYtNGMwLTEuMS0uOS0yLTItMmgtMnptMCA2Yy0xLjEgMC0yIC45LTIgMnY0YzAgMS4xLjkgMiAyIDJoMmMxLjEgMCAyLS45IDItMnYtNGMwLTEuMS0uOS0yLTItMmgtMnoiLz4KPC9zdmc+Cjx0ZXh0IHg9IjUwIiB5PSI5MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iI0Y1OUUwQiIgZm9udC1zaXplPSIxMiIgZm9udC1mYW1pbHk9IkFyaWFsIj5XaW5nczwvdGV4dD4KPC9zdmc+", description: "500g fresh chicken wings", popular: true },
      
      // Mutton Products
      { id: 15, name: "Mutton Chops", price: 1999, category: "mutton", image: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjRkVFMkUyIiByeD0iMTAiLz4KPHN2ZyB4PSIyNSIgeT0iMjAiIHdpZHRoPSI1MCIgaGVpZ2h0PSI2MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjREM0NjI2Ij4KICA8cGF0aCBkPSJNMTIgMmMtMS4xIDAtMiAuOS0yIDJ2NGMwIDEuMS45IDIgMiAyaDJjMS4xIDAgMi0uOSAyLTJWNGMwLTEuMS0uOS0yLTItMmgtMnptMCA2Yy0xLjEgMC0yIC45LTIgMnY0YzAgMS4xLjkgMiAyIDJoMmMxLjEgMCAyLS45IDItMnYtNGMwLTEuMS0uOS0yLTItMmgtMnptMCA2Yy0xLjEgMC0yIC45LTIgMnY0YzAgMS4xLjkgMiAyIDJoMmMxLjEgMCAyLS45IDItMnYtNGMwLTEuMS0uOS0yLTItMmgtMnoiLz4KPC9zdmc+Cjx0ZXh0IHg9IjUwIiB5PSI5MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iI0RDNDYyNiIgZm9udC1zaXplPSIxMiIgZm9udC1mYW1pbHk9IkFyaWFsIj5NdXR0b248L3RleHQ+Cjwvc3ZnPg==", description: "500g tender mutton chops", popular: true },
      { id: 18, name: "Mutton Mince", price: 1599, category: "mutton", image: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjRkVFMkUyIiByeD0iMTAiLz4KPHN2ZyB4PSIyNSIgeT0iMjAiIHdpZHRoPSI1MCIgaGVpZ2h0PSI2MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjREM0NjI2Ij4KICA8cGF0aCBkPSJNMTIgMmMtMS4xIDAtMiAuOS0yIDJ2NGMwIDEuMS45IDIgMiAyaDJjMS4xIDAgMi0uOSAyLTJWNGMwLTEuMS0uOS0yLTItMmgtMnptMCA2Yy0xLjEgMC0yIC45LTIgMnY0YzAgMS4xLjkgMiAyIDJoMmMxLjEgMCAyLS45IDItMnYtNGMwLTEuMS0uOS0yLTItMmgtMnptMCA2Yy0xLjEgMC0yIC45LTIgMnY0YzAgMS4xLjkgMiAyIDJoMmMxLjEgMCAyLS45IDItMnYtNGMwLTEuMS0uOS0yLTItMmgtMnoiLz4KPC9zdmc+Cjx0ZXh0IHg9IjUwIiB5PSI5MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iI0RDNDYyNiIgZm9udC1zaXplPSIxMiIgZm9udC1mYW1pbHk9IkFyaWFsIj5NaW5jZTwvdGV4dD4KPC9zdmc+", description: "500g fresh mutton mince", popular: true },
    ];
    
    let nextProductId = 21;

    let cart = [];
    let orders = [];
    let orderCounter = 1000;
    let currentLocation = null;
    let filteredProducts = [...products];
    let currentUser = null;
    let activeOffers = [];
    let currentOffer = null;
    let adminPassword = localStorage.getItem('adminPassword') || 'admin123';

    // Initialize app
    document.addEventListener('DOMContentLoaded', function() {
      showLoadingState();
      setTimeout(() => {
        displayProducts();
        updateCartDisplay();
        loadSavedLocation();
        loadUserSession();
        loadActiveOffers();
        hideLoadingState();
        initializeAnimations();
        requestLocationPermission();
      }, 800);
    });

    // Request location permission for better tracking
    function requestLocationPermission() {
      if (navigator.geolocation) {
        // Request permission without immediately getting location
        navigator.geolocation.getCurrentPosition(
          (position) => {
            console.log('Location permission granted');
            showToast('📍 Location access granted for better delivery tracking', 'success');
          },
          (error) => {
            console.log('Location permission denied:', error);
            if (error.code === error.PERMISSION_DENIED) {
              showToast('📍 Location access denied. Tracking will use approximate location.', 'warning');
            }
          },
          {
            enableHighAccuracy: false,
            timeout: 5000,
            maximumAge: 600000 // 10 minutes
          }
        );
      }
    }

    // Professional UI Functions
    function showLoadingState() {
      document.getElementById('loading-products').classList.remove('hidden');
      document.getElementById('products-container').classList.add('hidden');
    }

    function hideLoadingState() {
      document.getElementById('loading-products').classList.add('hidden');
      document.getElementById('products-container').classList.remove('hidden');
    }

    function initializeAnimations() {
      // Add fade-in animation to product cards
      const cards = document.querySelectorAll('.product-card');
      cards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
        card.classList.add('fade-in');
      });
    }

    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast bg-white border-l-4 ${
        type === 'success' ? 'border-green-500' : 
        type === 'error' ? 'border-red-500' : 
        type === 'warning' ? 'border-yellow-500' : 'border-blue-500'
      } p-4 rounded-lg shadow-lg max-w-sm`;
      
      toast.innerHTML = `
        <div class="flex items-center space-x-3">
          <div class="text-2xl">
            ${type === 'success' ? '✅' : 
              type === 'error' ? '❌' : 
              type === 'warning' ? '⚠️' : 'ℹ️'}
          </div>
          <div>
            <p class="font-medium text-gray-900">${message}</p>
          </div>
          <button onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600">
            ✕
          </button>
        </div>
      `;
      
      document.getElementById('toast-container').appendChild(toast);
      
      // Show toast
      setTimeout(() => toast.classList.add('show'), 100);
      
      // Auto remove after 5 seconds
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 5000);
    }

    function clearSearch() {
      document.getElementById('search-input').value = '';
      document.getElementById('clear-search').classList.add('hidden');
      searchProducts();
    }

    function clearAllFilters() {
      document.getElementById('search-input').value = '';
      document.getElementById('category-filter').value = 'all';
      document.getElementById('sort-filter').value = 'default';
      document.getElementById('clear-search').classList.add('hidden');
      filteredProducts = [...products];
      displayProducts(filteredProducts);
      updateResultsCount();
    }

    function showAllProducts() {
      clearAllFilters();
    }

    function quickFilter(type) {
      switch(type) {
        case 'popular':
          document.getElementById('sort-filter').value = 'popular';
          sortProducts();
          break;
        case 'under-500':
          filteredProducts = products.filter(p => p.price < 500);
          displayProducts(filteredProducts);
          break;
        case 'premium':
          filteredProducts = products.filter(p => p.price > 1000);
          displayProducts(filteredProducts);
          break;
        case 'fast-delivery':
          // Show all products as they all have fast delivery
          showAllProducts();
          break;
      }
      updateResultsCount();
    }

    function updateResultsCount() {
      const count = filteredProducts.length;
      const total = products.length;
      document.getElementById('results-count').textContent = 
        count === total ? `Showing all ${total} products` : `Showing ${count} of ${total} products`;
    }

    function toggleView(view) {
      const gridBtn = document.getElementById('grid-view');
      const listBtn = document.getElementById('list-view');
      const container = document.getElementById('products-container');
      
      if (view === 'grid') {
        gridBtn.className = 'p-2 rounded-lg bg-blue-600 text-white';
        listBtn.className = 'p-2 rounded-lg bg-gray-200 text-gray-600 hover:bg-gray-300';
        container.className = 'responsive-grid';
      } else {
        listBtn.className = 'p-2 rounded-lg bg-blue-600 text-white';
        gridBtn.className = 'p-2 rounded-lg bg-gray-200 text-gray-600 hover:bg-gray-300';
        container.className = 'space-y-4';
      }
      
      displayProducts(filteredProducts, view);
    }

    function animateCartPulse() {
      const pulse = document.getElementById('cart-pulse');
      pulse.style.opacity = '0.3';
      setTimeout(() => {
        pulse.style.opacity = '0';
      }, 600);
    }

    // User Management Functions
    function loadUserSession() {
      const savedUser = localStorage.getItem('currentUser');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        showLoggedInUser();
      }
    }

    function showUserLogin() {
      document.getElementById('user-login-modal').classList.remove('hidden');
      // Pre-fill if user data exists
      if (currentUser) {
        document.getElementById('user-name').value = currentUser.name || '';
        document.getElementById('user-phone').value = currentUser.phone || '';
        document.getElementById('user-address').value = currentUser.address || '';
        document.getElementById('user-email').value = currentUser.email || '';
      }
    }

    function closeUserLogin() {
      document.getElementById('user-login-modal').classList.add('hidden');
    }

    function showLoggedInUser() {
      document.getElementById('user-profile').classList.remove('hidden');
      document.getElementById('login-btn').classList.add('hidden');
      document.getElementById('user-name-display').textContent = currentUser.name;
      
      // Set user initial
      const initial = currentUser.name.charAt(0).toUpperCase();
      document.getElementById('user-initial').textContent = initial;
      
      // Show welcome toast
      showToast(`Welcome back, ${currentUser.name}!`, 'success');
    }

    function showUserProfile() {
      document.getElementById('profile-name').textContent = currentUser.name;
      document.getElementById('profile-phone').textContent = currentUser.phone;
      document.getElementById('profile-email').textContent = currentUser.email || 'Not provided';
      document.getElementById('profile-address').textContent = currentUser.address;
      
      // Calculate user statistics
      const userOrders = orders.filter(order => order.customer.phone === currentUser.phone);
      const totalSpent = userOrders.reduce((sum, order) => sum + order.total, 0);
      
      document.getElementById('user-order-count').textContent = userOrders.length;
      document.getElementById('user-total-spent').textContent = totalSpent;
      
      document.getElementById('user-profile-modal').classList.remove('hidden');
    }

    function closeUserProfile() {
      document.getElementById('user-profile-modal').classList.add('hidden');
    }

    function editUserProfile() {
      closeUserProfile();
      showUserLogin();
    }

    function logoutUser() {
      currentUser = null;
      localStorage.removeItem('currentUser');
      
      document.getElementById('user-profile').classList.add('hidden');
      document.getElementById('login-btn').classList.remove('hidden');
      document.getElementById('user-profile-modal').classList.add('hidden');
      document.getElementById('my-orders-modal').classList.add('hidden');
      
      // Clear any checkout forms
      document.getElementById('customer-name').value = '';
      document.getElementById('customer-phone').value = '';
      document.getElementById('customer-address').value = '';
    }

    // My Orders Functions
    function showMyOrders() {
      document.getElementById('my-orders-modal').classList.remove('hidden');
      loadMyOrders();
    }

    function closeMyOrders() {
      document.getElementById('my-orders-modal').classList.add('hidden');
    }

    function loadMyOrders(filter = 'all') {
      let userOrders = [];
      
      if (currentUser) {
        // Get logged-in user's orders
        userOrders = orders.filter(order => 
          order.customer.phone === currentUser.phone
        );
        
        // Check for pending order
        const pendingOrder = localStorage.getItem('pendingOrder');
        if (pendingOrder) {
          const pending = JSON.parse(pendingOrder);
          if (pending.customer.phone === currentUser.phone) {
            userOrders.unshift(pending); // Add to beginning
          }
        }
      } else {
        // For guest users, show orders based on phone number from localStorage
        const guestPhone = localStorage.getItem('customerPhone');
        if (guestPhone) {
          userOrders = orders.filter(order => 
            order.customer.phone === guestPhone
          );
          
          // Check for pending order
          const pendingOrder = localStorage.getItem('pendingOrder');
          if (pendingOrder) {
            const pending = JSON.parse(pendingOrder);
            if (pending.customer.phone === guestPhone) {
              userOrders.unshift(pending); // Add to beginning
            }
          }
        }
        
        // Also check for any pending order without phone match (for immediate after order)
        if (userOrders.length === 0) {
          const pendingOrder = localStorage.getItem('pendingOrder');
          if (pendingOrder) {
            const pending = JSON.parse(pendingOrder);
            userOrders.push(pending);
          }
        }
      }
      
      // Apply filter
      if (filter !== 'all') {
        userOrders = userOrders.filter(order => order.status === filter);
      }
      
      const container = document.getElementById('my-orders-list');
      
      if (userOrders.length === 0) {
        const isLoggedIn = !!currentUser;
        const hasGuestPhone = !!localStorage.getItem('customerPhone');
        
        let message = "You haven't placed any orders yet";
        let suggestion = "Start Shopping";
        
        if (!isLoggedIn && !hasGuestPhone) {
          message = "No orders found. Orders are tracked by phone number.";
          suggestion = "Place Your First Order";
        } else if (filter !== 'all') {
          message = `No ${filter} orders found`;
          suggestion = "View All Orders";
        }
        
        container.innerHTML = `
          <div class="text-center py-12">
            <div class="text-6xl mb-4">📦</div>
            <h3 class="text-xl font-semibold text-gray-900 mb-2">No orders found</h3>
            <p class="text-gray-600 mb-6">${message}</p>
            ${!isLoggedIn && !hasGuestPhone ? `
              <div class="bg-blue-50 p-4 rounded-lg mb-6 max-w-md mx-auto">
                <p class="text-sm text-blue-800 mb-2">💡 <strong>How to track orders:</strong></p>
                <p class="text-sm text-blue-700">• Orders are automatically tracked by your phone number</p>
                <p class="text-sm text-blue-700">• No login required - just use the same phone number</p>
                <p class="text-sm text-blue-700">• For better experience, create an account</p>
              </div>
            ` : ''}
            <button onclick="closeMyOrders()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors">
              ${suggestion}
            </button>
          </div>
        `;
        return;
      }
      
      container.innerHTML = userOrders.map(order => `
        <div class="bg-white border rounded-lg p-6 hover:shadow-md transition-shadow">
          <div class="flex justify-between items-start mb-4">
            <div>
              <div class="flex items-center space-x-3 mb-2">
                <h3 class="text-lg font-semibold text-gray-900">Order #${order.id}</h3>
                <span class="px-3 py-1 rounded-full text-xs font-medium ${getOrderStatusBadge(order.status)}">
                  ${getOrderStatusText(order.status)}
                </span>
              </div>
              <p class="text-sm text-gray-600 mb-1">📅 Placed: ${order.timestamp}</p>
              <p class="text-sm text-gray-600 mb-1">⏰ Delivery: ${order.deliveryTime}</p>
              <p class="text-sm text-gray-600">💳 Payment: ${order.paymentMethod === 'cod' ? 'Cash on Delivery' : 'UPI'} ${order.paymentStatus ? `(${order.paymentStatus})` : ''}</p>
            </div>
            <div class="text-right">
              <p class="text-2xl font-bold text-blue-600">₹${order.total}</p>
              <p class="text-sm text-gray-500">${order.items.length} item${order.items.length > 1 ? 's' : ''}</p>
            </div>
          </div>
          
          <div class="border-t pt-4 mb-4">
            <h4 class="font-medium text-gray-900 mb-2">Order Items:</h4>
            <div class="space-y-1">
              ${order.items.map(item => `
                <div class="flex justify-between text-sm">
                  <span class="text-gray-700">${item.quantity}x ${item.name}</span>
                  <span class="text-gray-900 font-medium">₹${item.price * item.quantity}</span>
                </div>
              `).join('')}
            </div>
          </div>
          
          <div class="flex justify-between items-center">
            <div class="text-sm text-gray-600">
              <p>📍 ${order.customer.address}</p>
              ${order.specialInstructions ? `<p>📝 ${order.specialInstructions}</p>` : ''}
            </div>
            <div class="flex space-x-2">
              ${order.status === 'out-for-delivery' || order.status === 'delivered' ? `
                <button onclick="trackOrderFromMyOrders(${order.id})" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">
                  📍 Track Order
                </button>
              ` : ''}
              ${order.status === 'delivered' ? `
                <button onclick="reorderItems(${order.id})" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-green-700 transition-colors">
                  🔄 Reorder
                </button>
              ` : ''}
              ${order.status === 'pending' || order.status === 'payment-pending' ? `
                <button onclick="cancelOrder(${order.id})" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-red-700 transition-colors">
                  ❌ Cancel
                </button>
              ` : ''}
            </div>
          </div>
        </div>
      `).join('');
    }

    function filterMyOrders(filter) {
      // Update filter buttons
      document.querySelectorAll('[id^="filter-"]').forEach(btn => {
        btn.className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300';
      });
      document.getElementById(`filter-${filter}`).className = 'px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium';
      
      // Load filtered orders
      loadMyOrders(filter);
    }

    function getOrderStatusBadge(status) {
      switch(status) {
        case 'payment-pending': return 'bg-orange-100 text-orange-800';
        case 'payment-confirmed': return 'bg-green-100 text-green-800';
        case 'pending': return 'bg-yellow-100 text-yellow-800';
        case 'processing': return 'bg-blue-100 text-blue-800';
        case 'ready': return 'bg-purple-100 text-purple-800';
        case 'out-for-delivery': return 'bg-indigo-100 text-indigo-800';
        case 'delivered': return 'bg-green-100 text-green-800';
        case 'cancelled': return 'bg-red-100 text-red-800';
        default: return 'bg-gray-100 text-gray-800';
      }
    }

    function getOrderStatusText(status) {
      switch(status) {
        case 'payment-pending': return '⏳ Payment Pending';
        case 'payment-confirmed': return '✅ Payment Confirmed';
        case 'pending': return '📋 Order Confirmed';
        case 'processing': return '👨‍🍳 Preparing';
        case 'ready': return '📦 Ready';
        case 'out-for-delivery': return '🚚 Out for Delivery';
        case 'delivered': return '✅ Delivered';
        case 'cancelled': return '❌ Cancelled';
        default: return status;
      }
    }

    function trackOrderFromMyOrders(orderId) {
      const order = orders.find(o => o.id === orderId);
      if (order) {
        closeMyOrders();
        showOrderTracking(order);
      }
    }

    function reorderItems(orderId) {
      const order = orders.find(o => o.id === orderId);
      if (!order) return;
      
      // Clear current cart
      cart = [];
      
      // Add order items to cart
      order.items.forEach(item => {
        const product = products.find(p => p.id === item.id);
        if (product) {
          cart.push({
            ...product,
            quantity: item.quantity
          });
        }
      });
      
      updateCartDisplay();
      displayProducts(filteredProducts);
      closeMyOrders();
      openCart();
      
      showToast(`${order.items.length} items added to cart from previous order!`, 'success');
    }

    function cancelOrder(orderId) {
      if (!confirm('Are you sure you want to cancel this order?')) return;
      
      const orderIndex = orders.findIndex(o => o.id === orderId);
      if (orderIndex !== -1) {
        orders[orderIndex].status = 'cancelled';
        loadMyOrders();
        showToast('Order cancelled successfully', 'success');
      }
      
      // Check if it's a pending order
      const pendingOrder = localStorage.getItem('pendingOrder');
      if (pendingOrder) {
        const pending = JSON.parse(pendingOrder);
        if (pending.id === orderId) {
          localStorage.removeItem('pendingOrder');
          loadMyOrders();
          showToast('Order cancelled successfully', 'success');
        }
      }
    }

    // Location Management
    function loadSavedLocation() {
      const saved = localStorage.getItem('deliveryLocation');
      if (saved) {
        currentLocation = saved;
        document.getElementById('delivery-location').textContent = saved;
        document.getElementById('delivery-location-mobile').textContent = saved;
      } else {
        // Set default location automatically without showing modal
        currentLocation = 'Downtown';
        document.getElementById('delivery-location').textContent = currentLocation;
        document.getElementById('delivery-location-mobile').textContent = currentLocation;
        localStorage.setItem('deliveryLocation', currentLocation);
      }
    }

    function changeLocation() {
      document.getElementById('location-modal').classList.remove('hidden');
    }

    function selectLocation(location) {
      document.getElementById('location-input').value = location;
    }

    function confirmLocation() {
      const location = document.getElementById('location-input').value.trim();
      if (location) {
        currentLocation = location;
        document.getElementById('delivery-location').textContent = location;
        document.getElementById('delivery-location-mobile').textContent = location;
        localStorage.setItem('deliveryLocation', location);
        document.getElementById('location-modal').classList.add('hidden');
        
        // Show success toast
        showToast(`Delivery location set to ${location}`, 'success');
        
        // Update delivery fee display
        updateCartDisplay();
      } else {
        showToast('Please enter a valid location', 'error');
      }
    }

    // Product Display
    function displayProducts(productsToShow = products, view = 'grid') {
      const container = document.getElementById('products-container');
      const noResults = document.getElementById('no-results');
      
      if (productsToShow.length === 0) {
        container.innerHTML = '';
        noResults.classList.remove('hidden');
        updateResultsCount();
        return;
      }
      
      noResults.classList.add('hidden');
      updateResultsCount();
      
      if (view === 'list') {
        container.innerHTML = productsToShow.map(product => `
          <div class="product-card bg-white rounded-2xl shadow-lg overflow-hidden hover:shadow-2xl transition-all duration-300 border border-gray-100">
            <div class="flex">
              <div class="product-image-container w-48 h-32 flex items-center justify-center relative">
                <img src="${product.image}" alt="${product.name}" class="w-20 h-20 object-cover rounded-lg">
                ${product.popular ? '<div class="product-badge"><span class="bg-gradient-to-r from-orange-500 to-red-500 text-white text-xs px-3 py-1 rounded-full font-medium shadow-lg">🔥 Popular</span></div>' : ''}
              </div>
              <div class="flex-1 p-6">
                <div class="flex justify-between items-start mb-4">
                  <div>
                    <h3 class="text-xl font-bold text-gray-900 mb-2">${product.name}</h3>
                    <p class="text-gray-600 text-sm mb-3">${product.description}</p>
                    <div class="flex items-center space-x-3">
                      <span class="price-tag text-2xl font-bold px-3 py-1 rounded-lg">₹${product.price}</span>
                      <span class="text-xs text-gray-500 bg-gray-100 px-3 py-1 rounded-full font-medium">${getCategoryIcon(product.category)} ${product.category}</span>
                    </div>
                  </div>
                  <div class="flex items-center space-x-4">
                    <div class="quantity-selector flex items-center space-x-3">
                      <button onclick="updateProductQuantity(${product.id}, -1)" class="w-10 h-10 rounded-full bg-gray-100 hover:bg-red-100 hover:text-red-600 flex items-center justify-center transition-all duration-200 font-bold">−</button>
                      <span id="qty-${product.id}" class="w-8 text-center font-bold text-lg">0</span>
                      <button onclick="updateProductQuantity(${product.id}, 1)" class="w-10 h-10 rounded-full bg-gray-100 hover:bg-green-100 hover:text-green-600 flex items-center justify-center transition-all duration-200 font-bold">+</button>
                    </div>
                    <button onclick="addToCart(${product.id})" class="btn-primary text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105">
                      Add to Cart
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `).join('');
      } else {
        container.innerHTML = productsToShow.map(product => `
          <div class="product-card bg-white rounded-2xl shadow-lg overflow-hidden hover:shadow-2xl transition-all duration-300 border border-gray-100 group">
            <div class="product-image-container h-56 flex items-center justify-center relative overflow-hidden">
              <img src="${product.image}" alt="${product.name}" class="w-28 h-28 object-cover rounded-xl transition-transform duration-300 group-hover:scale-110">
              ${product.popular ? '<div class="product-badge"><span class="bg-gradient-to-r from-orange-500 to-red-500 text-white text-xs px-3 py-1 rounded-full font-medium shadow-lg">🔥 Popular</span></div>' : ''}
              <div class="absolute inset-0 bg-gradient-to-t from-black/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
            </div>
            <div class="p-6">
              <div class="mb-4">
                <h3 class="text-lg font-bold text-gray-900 mb-2 group-hover:text-blue-600 transition-colors">${product.name}</h3>
                <p class="text-gray-600 text-sm mb-3 line-clamp-2">${product.description}</p>
                <div class="flex justify-between items-center mb-4">
                  <span class="price-tag text-2xl font-bold px-3 py-1 rounded-lg">₹${product.price}</span>
                  <span class="text-xs text-gray-500 bg-gray-100 px-3 py-1 rounded-full font-medium">${getCategoryIcon(product.category)} ${product.category}</span>
                </div>
              </div>
              <div class="flex items-center justify-between">
                <div class="quantity-selector flex items-center space-x-2">
                  <button onclick="updateProductQuantity(${product.id}, -1)" class="w-9 h-9 rounded-full bg-gray-100 hover:bg-red-100 hover:text-red-600 flex items-center justify-center transition-all duration-200 font-bold text-sm">−</button>
                  <span id="qty-${product.id}" class="w-8 text-center font-bold">0</span>
                  <button onclick="updateProductQuantity(${product.id}, 1)" class="w-9 h-9 rounded-full bg-gray-100 hover:bg-green-100 hover:text-green-600 flex items-center justify-center transition-all duration-200 font-bold text-sm">+</button>
                </div>
                <button onclick="addToCart(${product.id})" class="btn-primary text-white px-4 py-2 rounded-lg font-medium shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105">
                  Add to Cart
                </button>
              </div>
            </div>
          </div>
        `).join('');
      }
      
      // Update quantity displays
      cart.forEach(item => {
        const qtyElement = document.getElementById(`qty-${item.id}`);
        if (qtyElement) {
          qtyElement.textContent = item.quantity;
        }
      });
      
      // Re-initialize animations
      setTimeout(initializeAnimations, 100);
    }

    function getCategoryIcon(category) {
      switch(category) {
        case 'water': return '💧';
        case 'chicken': return '🐔';
        case 'mutton': return '🥩';
        default: return '📦';
      }
    }

    function getGradientColor(category) {
      switch(category) {
        case 'water': return 'from-blue-100 to-blue-200';
        case 'chicken': return 'from-yellow-100 to-yellow-200';
        case 'mutton': return 'from-red-100 to-red-200';
        default: return 'from-gray-100 to-gray-200';
      }
    }

    // Offers Management Functions
    function hideOfferBanner() {
      document.getElementById('offer-banner').classList.add('hidden');
      localStorage.setItem('offerBannerHidden', 'true');
    }

    function showOfferBanner(offer) {
      const banner = document.getElementById('offer-banner');
      document.getElementById('offer-title').textContent = offer.title;
      document.getElementById('offer-description').textContent = offer.description;
      
      let discountText = '';
      switch(offer.discountType) {
        case 'percentage':
          discountText = `${offer.discountValue}% OFF`;
          break;
        case 'fixed':
          discountText = `₹${offer.discountValue} OFF`;
          break;
        case 'free-delivery':
          discountText = 'FREE DELIVERY';
          break;
        case 'buy-get':
          discountText = 'BUY 1 GET 1';
          break;
        default:
          discountText = 'SPECIAL OFFER';
      }
      
      document.getElementById('offer-discount').textContent = discountText;
      banner.classList.remove('hidden');
      
      // Remove hidden flag
      localStorage.removeItem('offerBannerHidden');
    }

    function createOffer(offerData) {
      const offer = {
        id: Date.now(),
        title: offerData.title,
        description: offerData.description,
        discountType: offerData.discountType,
        discountValue: parseFloat(offerData.discountValue),
        minOrderValue: parseFloat(offerData.minOrderValue) || 0,
        offerCode: offerData.offerCode || null,
        showBanner: offerData.showBanner,
        autoApply: offerData.autoApply,
        expiryDate: offerData.expiryDate ? new Date(offerData.expiryDate) : null,
        isActive: true,
        createdAt: new Date(),
        usageCount: 0
      };
      
      activeOffers.push(offer);
      
      // If show banner is enabled, display it
      if (offer.showBanner) {
        currentOffer = offer;
        showOfferBanner(offer);
      }
      
      // Save to localStorage
      localStorage.setItem('activeOffers', JSON.stringify(activeOffers));
      
      return offer;
    }

    function loadActiveOffers() {
      const saved = localStorage.getItem('activeOffers');
      if (saved) {
        activeOffers = JSON.parse(saved);
        
        // Check for active banner offers
        const bannerOffer = activeOffers.find(offer => 
          offer.isActive && 
          offer.showBanner && 
          (!offer.expiryDate || new Date(offer.expiryDate) > new Date())
        );
        
        if (bannerOffer && !localStorage.getItem('offerBannerHidden')) {
          currentOffer = bannerOffer;
          showOfferBanner(bannerOffer);
        }
      }
    }

    function calculateDiscount(subtotal, offer) {
      if (!offer || !offer.isActive) return 0;
      
      // Check minimum order value
      if (offer.minOrderValue > 0 && subtotal < offer.minOrderValue) {
        return 0;
      }
      
      // Check expiry
      if (offer.expiryDate && new Date(offer.expiryDate) < new Date()) {
        return 0;
      }
      
      let discount = 0;
      
      switch(offer.discountType) {
        case 'percentage':
          discount = (subtotal * offer.discountValue) / 100;
          break;
        case 'fixed':
          discount = Math.min(offer.discountValue, subtotal);
          break;
        case 'free-delivery':
          // This will be handled in delivery fee calculation
          discount = 0;
          break;
        case 'buy-get':
          // Simplified buy-get logic (can be enhanced)
          discount = subtotal * 0.5; // 50% off for buy-get
          break;
      }
      
      return Math.round(discount);
    }

    function applyOfferToCart() {
      const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      
      if (subtotal === 0) {
        currentOffer = null;
        return null;
      }
      
      // Find ALL applicable offers (both auto-apply and manual)
      const applicableOffers = activeOffers.filter(offer => {
        // Check if offer is active and not expired
        if (!offer.isActive || (offer.expiryDate && new Date(offer.expiryDate) <= new Date())) {
          return false;
        }
        
        // Check minimum order value
        if (offer.minOrderValue > 0 && subtotal < offer.minOrderValue) {
          return false;
        }
        
        // For auto-apply offers, always include them
        if (offer.autoApply) {
          return true;
        }
        
        // For manual offers, only include if already applied via promo code
        if (offer.offerCode && currentOffer && currentOffer.id === offer.id) {
          return true;
        }
        
        // Include offers without codes (they should auto-apply)
        if (!offer.offerCode) {
          return true;
        }
        
        return false;
      });
      
      if (applicableOffers.length > 0) {
        // Find the best offer (highest discount value)
        let bestOffer = applicableOffers[0];
        let bestDiscount = calculateDiscount(subtotal, bestOffer);
        
        for (let i = 1; i < applicableOffers.length; i++) {
          const currentDiscount = calculateDiscount(subtotal, applicableOffers[i]);
          if (currentDiscount > bestDiscount) {
            bestOffer = applicableOffers[i];
            bestDiscount = currentDiscount;
          }
        }
        
        // Only update if this is a new offer or better offer
        const wasNewOfferApplied = !currentOffer || currentOffer.id !== bestOffer.id;
        
        currentOffer = bestOffer;
        
        // Show notification for newly applied auto offers
        if (wasNewOfferApplied && bestOffer.autoApply && bestDiscount > 0) {
          showToast(`🎉 ${bestOffer.title} automatically applied! You save ₹${bestDiscount}`, 'success');
        }
        
        return bestOffer;
      }
      
      // Clear current offer if no applicable offers (except promo code offers)
      if (currentOffer && (!currentOffer.offerCode || currentOffer.autoApply)) {
        currentOffer = null;
      }
      
      return null;
    }

    function applyPromoCode() {
      const promoCode = document.getElementById('promo-code-input').value.trim().toUpperCase();
      const successDiv = document.getElementById('promo-code-success');
      const errorDiv = document.getElementById('promo-code-error');
      const successText = document.getElementById('promo-success-text');
      const errorText = document.getElementById('promo-error-text');
      
      // Hide previous messages
      successDiv.classList.add('hidden');
      errorDiv.classList.add('hidden');
      
      if (!promoCode) {
        errorText.textContent = 'Please enter a promo code';
        errorDiv.classList.remove('hidden');
        return;
      }
      
      // Find matching offer by code
      const offer = activeOffers.find(o => 
        o.isActive && 
        o.offerCode && 
        o.offerCode.toUpperCase() === promoCode &&
        (!o.expiryDate || new Date(o.expiryDate) > new Date())
      );
      
      if (!offer) {
        errorText.textContent = 'Invalid or expired promo code';
        errorDiv.classList.remove('hidden');
        return;
      }
      
      // Check minimum order value
      const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      if (offer.minOrderValue > 0 && subtotal < offer.minOrderValue) {
        errorText.textContent = `Minimum order value ₹${offer.minOrderValue} required for this offer`;
        errorDiv.classList.remove('hidden');
        return;
      }
      
      // Apply the offer
      currentOffer = offer;
      
      // Update usage count
      offer.usageCount++;
      localStorage.setItem('activeOffers', JSON.stringify(activeOffers));
      
      // Show success message
      const discount = calculateDiscount(subtotal, offer);
      successText.textContent = `${offer.title} applied! You save ₹${discount}`;
      successDiv.classList.remove('hidden');
      
      // Update cart display
      updateCartDisplay();
      
      // Update checkout summary if modal is open
      if (!document.getElementById('checkout-modal').classList.contains('hidden')) {
        updateCheckoutSummary();
      }
      
      // Clear input
      document.getElementById('promo-code-input').value = '';
      
      showToast(`🎉 Promo code "${promoCode}" applied successfully!`, 'success');
    }

    function toggleOfferStatus(offerId) {
      const offer = activeOffers.find(o => o.id === offerId);
      if (offer) {
        offer.isActive = !offer.isActive;
        
        // If deactivating a banner offer, hide the banner
        if (!offer.isActive && offer.showBanner && currentOffer?.id === offerId) {
          hideOfferBanner();
          currentOffer = null;
        }
        
        // If activating a banner offer, show it
        if (offer.isActive && offer.showBanner) {
          currentOffer = offer;
          showOfferBanner(offer);
        }
        
        localStorage.setItem('activeOffers', JSON.stringify(activeOffers));
        loadAdminOffers();
        updateCartDisplay();
      }
    }

    function deleteOffer(offerId) {
      if (confirm('Are you sure you want to delete this offer?')) {
        activeOffers = activeOffers.filter(o => o.id !== offerId);
        
        // If deleting current banner offer, hide banner
        if (currentOffer?.id === offerId) {
          hideOfferBanner();
          currentOffer = null;
        }
        
        localStorage.setItem('activeOffers', JSON.stringify(activeOffers));
        loadAdminOffers();
        updateCartDisplay();
      }
    }

    function loadAdminOffers() {
      const container = document.getElementById('active-offers-list');
      
      if (activeOffers.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">No active offers</p>';
        return;
      }
      
      container.innerHTML = activeOffers.map(offer => `
        <div class="bg-white border rounded-lg p-4">
          <div class="flex justify-between items-start mb-3">
            <div class="flex-1">
              <div class="flex items-center space-x-3 mb-2">
                <h4 class="font-medium text-lg">${offer.title}</h4>
                <span class="px-2 py-1 rounded-full text-xs font-medium ${offer.isActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                  ${offer.isActive ? '✅ Active' : '❌ Inactive'}
                </span>
                ${offer.showBanner ? '<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">🏷️ Banner</span>' : ''}
                ${offer.autoApply ? '<span class="px-2 py-1 bg-purple-100 text-purple-800 rounded-full text-xs font-medium">⚡ Auto</span>' : ''}
              </div>
              <p class="text-sm text-gray-600 mb-2">${offer.description}</p>
              <div class="text-sm text-gray-700 space-y-1">
                <p><strong>Discount:</strong> ${getDiscountDisplayText(offer)}</p>
                ${offer.minOrderValue > 0 ? `<p><strong>Min Order:</strong> ₹${offer.minOrderValue}</p>` : ''}
                ${offer.offerCode ? `<p><strong>Code:</strong> <span class="font-mono bg-gray-100 px-2 py-1 rounded">${offer.offerCode}</span></p>` : ''}
                ${offer.expiryDate ? `<p><strong>Expires:</strong> ${new Date(offer.expiryDate).toLocaleString()}</p>` : '<p><strong>Validity:</strong> No expiry</p>'}
                <p><strong>Used:</strong> ${offer.usageCount} times</p>
              </div>
            </div>
            <div class="flex space-x-2">
              <button onclick="toggleOfferStatus(${offer.id})" class="text-sm px-3 py-1 rounded ${offer.isActive ? 'bg-red-100 text-red-700 hover:bg-red-200' : 'bg-green-100 text-green-700 hover:bg-green-200'}">
                ${offer.isActive ? '⏸️ Deactivate' : '▶️ Activate'}
              </button>
              <button onclick="deleteOffer(${offer.id})" class="text-sm px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200">🗑️ Delete</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    function getDiscountDisplayText(offer) {
      switch(offer.discountType) {
        case 'percentage':
          return `${offer.discountValue}% off`;
        case 'fixed':
          return `₹${offer.discountValue} off`;
        case 'free-delivery':
          return 'Free delivery';
        case 'buy-get':
          return 'Buy 1 Get 1';
        default:
          return 'Special discount';
      }
    }

    function refreshOffers() {
      loadAdminOffers();
      showToast('Offers refreshed successfully', 'success');
    }

    // Admin Functions
    let isAdminLoggedIn = false;

    function toggleAdmin() {
      if (isAdminLoggedIn) {
        const panel = document.getElementById('admin-panel');
        panel.classList.toggle('hidden');
        if (!panel.classList.contains('hidden')) {
          loadAdminProducts();
          loadAdminOrders();
        }
      } else {
        document.getElementById('admin-login-modal').classList.remove('hidden');
      }
    }

    function closeAdminLogin() {
      document.getElementById('admin-login-modal').classList.add('hidden');
      document.getElementById('admin-password').value = '';
      document.getElementById('password-error').classList.add('hidden');
    }

    function authenticateAdmin(password) {
      if (password === adminPassword) {
        isAdminLoggedIn = true;
        closeAdminLogin();
        document.getElementById('admin-panel').classList.remove('hidden');
        loadAdminProducts();
        loadAdminOrders();
        return true;
      } else {
        document.getElementById('password-error').classList.remove('hidden');
        document.getElementById('admin-password').value = '';
        return false;
      }
    }

    function showAdminPasswordChange() {
      document.getElementById('admin-password-change-modal').classList.remove('hidden');
    }

    function closeAdminPasswordChange() {
      document.getElementById('admin-password-change-modal').classList.add('hidden');
      document.getElementById('admin-password-change-form').reset();
      document.getElementById('current-password-error').classList.add('hidden');
      document.getElementById('password-match-error').classList.add('hidden');
    }

    function changeAdminPassword(currentPassword, newPassword, confirmPassword) {
      // Validate current password
      if (currentPassword !== adminPassword) {
        document.getElementById('current-password-error').classList.remove('hidden');
        return false;
      }

      // Validate new password match
      if (newPassword !== confirmPassword) {
        document.getElementById('password-match-error').classList.remove('hidden');
        return false;
      }

      // Validate password length
      if (newPassword.length < 6) {
        document.getElementById('password-match-error').textContent = '❌ Password must be at least 6 characters long.';
        document.getElementById('password-match-error').classList.remove('hidden');
        return false;
      }

      // Update password
      adminPassword = newPassword;
      localStorage.setItem('adminPassword', adminPassword);
      
      closeAdminPasswordChange();
      showToast('🔑 Admin password changed successfully!', 'success');
      
      return true;
    }

    function showAdminTab(tab) {
      // Update tab buttons
      document.getElementById('products-tab').className = tab === 'products' 
        ? 'px-4 py-2 border-b-2 border-blue-600 text-blue-600 font-medium'
        : 'px-4 py-2 text-gray-600 hover:text-blue-600';
      
      document.getElementById('orders-tab').className = tab === 'orders'
        ? 'px-4 py-2 border-b-2 border-blue-600 text-blue-600 font-medium'
        : 'px-4 py-2 text-gray-600 hover:text-blue-600';

      document.getElementById('offers-tab').className = tab === 'offers'
        ? 'px-4 py-2 border-b-2 border-blue-600 text-blue-600 font-medium'
        : 'px-4 py-2 text-gray-600 hover:text-blue-600';

      // Show/hide content
      document.getElementById('admin-products').classList.toggle('hidden', tab !== 'products');
      document.getElementById('admin-orders').classList.toggle('hidden', tab !== 'orders');
      document.getElementById('admin-offers').classList.toggle('hidden', tab !== 'offers');
      
      // Load offers when tab is shown
      if (tab === 'offers') {
        loadAdminOffers();
      }
    }

    function loadAdminProducts() {
      const container = document.getElementById('admin-products-list');
      container.innerHTML = products.map(product => `
        <div class="bg-white border rounded-lg p-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
              <img src="${product.image}" alt="${product.name}" class="w-16 h-16 object-cover rounded-lg">
              <div>
                <h4 class="font-medium">${product.name}</h4>
                <p class="text-sm text-gray-600">${product.description}</p>
                <div class="flex items-center space-x-2 mt-1">
                  <span class="text-xs bg-${product.category === 'water' ? 'blue' : product.category === 'chicken' ? 'yellow' : 'red'}-100 text-${product.category === 'water' ? 'blue' : product.category === 'chicken' ? 'yellow' : 'red'}-800 px-2 py-1 rounded">${product.category}</span>
                  ${product.popular ? '<span class="text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded">Popular</span>' : ''}
                </div>
              </div>
            </div>
            <div class="flex items-center space-x-4">
              <div class="text-right">
                <input type="number" value="${product.price}" step="1" onchange="updateProductPrice(${product.id}, this.value)" class="w-24 px-2 py-1 text-sm border rounded focus:ring-1 focus:ring-blue-500">
                <p class="text-xs text-gray-500">Price (₹)</p>
              </div>
              <div class="flex space-x-2">
                <button onclick="toggleProductPopular(${product.id})" class="text-sm px-2 py-1 rounded ${product.popular ? 'bg-orange-100 text-orange-700' : 'bg-gray-100 text-gray-700'} hover:bg-opacity-80">
                  ${product.popular ? '⭐' : '☆'}
                </button>
                <button onclick="deleteProduct(${product.id})" class="text-sm px-2 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200">🗑️</button>
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }

    function addProduct(name, price, category, image, description, popular) {
      const newProduct = {
        id: nextProductId++,
        name,
        price: parseFloat(price),
        category,
        image,
        description,
        popular
      };
      
      products.push(newProduct);
      displayProducts(filteredProducts);
      loadAdminProducts();
      
      // Reset form
      document.getElementById('add-product-form').reset();
      document.getElementById('photo-preview').classList.add('hidden');
      
      // Show success feedback
      alert('Product added successfully!');
    }

    // Photo preview functionality
    document.getElementById('new-product-photo').addEventListener('change', function(e) {
      const file = e.target.files[0];
      const preview = document.getElementById('photo-preview');
      const previewImage = document.getElementById('preview-image');
      
      if (file) {
        if (file.size > 5 * 1024 * 1024) { // 5MB limit
          alert('File size must be less than 5MB');
          e.target.value = '';
          preview.classList.add('hidden');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
          previewImage.src = e.target.result;
          preview.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      } else {
        preview.classList.add('hidden');
      }
    });

    function updateProductPrice(productId, newPrice) {
      const product = products.find(p => p.id === productId);
      if (product) {
        product.price = parseFloat(newPrice);
        displayProducts(filteredProducts);
        
        // Update cart if product is in cart
        const cartItem = cart.find(item => item.id === productId);
        if (cartItem) {
          cartItem.price = product.price;
          updateCartDisplay();
        }
      }
    }

    function toggleProductPopular(productId) {
      const product = products.find(p => p.id === productId);
      if (product) {
        product.popular = !product.popular;
        displayProducts(filteredProducts);
        loadAdminProducts();
      }
    }

    function deleteProduct(productId) {
      if (confirm('Are you sure you want to delete this product?')) {
        products = products.filter(p => p.id !== productId);
        
        // Remove from cart if present
        cart = cart.filter(item => item.id !== productId);
        
        displayProducts(filteredProducts);
        loadAdminProducts();
        updateCartDisplay();
      }
    }

    function loadAdminOrders() {
      const container = document.getElementById('admin-orders-list');
      if (orders.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">No orders yet</p>';
        return;
      }

      container.innerHTML = orders.map(order => `
        <div class="bg-white border rounded-lg p-4">
          <div class="flex justify-between items-start mb-3">
            <div>
              <h4 class="font-medium">Order #${order.id}</h4>
              <p class="text-sm text-gray-600">${order.timestamp}</p>
              <p class="text-sm text-gray-600">${order.customer.name} - ${order.customer.phone}</p>
              ${order.realPaymentConfirmed ? '<span class="inline-block bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full mt-1">✅ Real Payment Verified</span>' : ''}
            </div>
            <div class="text-right">
              <p class="font-medium text-blue-600">₹${order.total}</p>
              <select onchange="updateOrderStatus(${order.id}, this.value)" class="text-xs px-2 py-1 rounded border mt-1 ${getStatusColor(order.status)}">
                <option value="payment-pending" ${order.status === 'payment-pending' ? 'selected' : ''}>Payment Pending</option>
                <option value="payment-confirmed" ${order.status === 'payment-confirmed' ? 'selected' : ''}>Payment Confirmed</option>
                <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>Processing</option>
                <option value="ready" ${order.status === 'ready' ? 'selected' : ''}>Ready</option>
                <option value="out-for-delivery" ${order.status === 'out-for-delivery' ? 'selected' : ''}>Out for Delivery</option>
                <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
              </select>
            </div>
          </div>
          <div class="text-sm text-gray-600">
            <p><strong>Items:</strong> ${order.items.map(item => `${item.quantity}x ${item.name}`).join(', ')}</p>
            <p><strong>Address:</strong> ${order.customer.address}</p>
            <p><strong>Payment:</strong> ${order.paymentMethod === 'cod' ? 'Cash on Delivery' : 'UPI'} ${order.paymentStatus ? `(${order.paymentStatus})` : ''}</p>
            ${order.paymentTimestamp ? `<p><strong>Payment Time:</strong> ${order.paymentTimestamp}</p>` : ''}
            ${order.transactionId ? `<p><strong>Transaction ID:</strong> <span class="font-mono bg-gray-100 px-2 py-1 rounded text-xs">${order.transactionId}</span></p>` : ''}
            ${order.paymentApp ? `<p><strong>Payment App:</strong> ${order.paymentApp}</p>` : ''}
            ${order.userReportedPaymentTime ? `<p><strong>User Reported Time:</strong> ${order.userReportedPaymentTime}</p>` : ''}
            ${order.paymentVerificationLevel ? `<p><strong>Verification:</strong> <span class="text-xs ${order.paymentVerificationLevel === 'manual-confirmation' ? 'text-orange-600' : 'text-green-600'}">${order.paymentVerificationLevel}</span></p>` : ''}
          </div>
          ${order.paymentDetails ? `
            <div class="mt-3 p-2 bg-gray-50 rounded text-xs">
              <p><strong>Payment Details:</strong></p>
              <p>Amount: ₹${order.paymentDetails.paymentAmount} | To: ${order.paymentDetails.paymentTo}</p>
              <p>System Time: ${order.paymentDetails.systemTimestamp}</p>
              <p>Device: ${order.paymentDetails.deviceInfo}</p>
            </div>
          ` : ''}
        </div>
      `).reverse().join('');
    }

    function getStatusColor(status) {
      switch(status) {
        case 'payment-pending': return 'bg-orange-100 text-orange-800';
        case 'payment-confirmed': return 'bg-green-100 text-green-800';
        case 'pending': return 'bg-yellow-100 text-yellow-800';
        case 'processing': return 'bg-blue-100 text-blue-800';
        case 'ready': return 'bg-purple-100 text-purple-800';
        case 'out-for-delivery': return 'bg-indigo-100 text-indigo-800';
        case 'delivered': return 'bg-green-100 text-green-800';
        case 'cancelled': return 'bg-red-100 text-red-800';
        default: return 'bg-gray-100 text-gray-800';
      }
    }

    function updateOrderStatus(orderId, newStatus) {
      const order = orders.find(o => o.id === orderId);
      if (order) {
        order.status = newStatus;
        loadAdminOrders();
      }
    }

    function filterOrdersByStatus() {
      const filter = document.getElementById('order-status-filter').value;
      // This would filter orders in a real implementation
      loadAdminOrders();
    }

    function refreshOrders() {
      loadAdminOrders();
    }

    // Search and Filter
    function searchProducts() {
      const query = document.getElementById('search-input').value.toLowerCase().trim();
      const clearBtn = document.getElementById('clear-search');
      
      if (query.length > 0) {
        clearBtn.classList.remove('hidden');
        filteredProducts = products.filter(product => 
          product.name.toLowerCase().includes(query) || 
          product.description.toLowerCase().includes(query) ||
          product.category.toLowerCase().includes(query)
        );
      } else {
        clearBtn.classList.add('hidden');
        filteredProducts = [...products];
      }
      
      applyFilters();
      
      // Show search feedback
      if (query.length > 0 && filteredProducts.length === 0) {
        showToast(`No results found for "${query}"`, 'warning');
      }
    }

    function filterByCategory() {
      const category = document.getElementById('category-filter').value;
      if (category === 'all') {
        filteredProducts = [...products];
      } else {
        filteredProducts = products.filter(product => product.category === category);
      }
      applyFilters();
    }

    function sortProducts() {
      const sortBy = document.getElementById('sort-filter').value;
      switch(sortBy) {
        case 'price-low':
          filteredProducts.sort((a, b) => a.price - b.price);
          break;
        case 'price-high':
          filteredProducts.sort((a, b) => b.price - a.price);
          break;
        case 'popular':
          filteredProducts.sort((a, b) => b.popular - a.popular);
          break;
        default:
          filteredProducts = [...products];
      }
      displayProducts(filteredProducts);
    }

    function applyFilters() {
      const query = document.getElementById('search-input').value.toLowerCase();
      const category = document.getElementById('category-filter').value;
      
      let filtered = [...products];
      
      if (query) {
        filtered = filtered.filter(product => 
          product.name.toLowerCase().includes(query) || 
          product.description.toLowerCase().includes(query)
        );
      }
      
      if (category !== 'all') {
        filtered = filtered.filter(product => product.category === category);
      }
      
      filteredProducts = filtered;
      displayProducts(filteredProducts);
    }

    // Delivery Fee Calculation
    function calculateDeliveryFee() {
      if (!currentLocation) return 40;
      
      // Distance-based delivery fee calculation
      const locationDistances = {
        'Downtown': 2,
        'City Center': 1.5,
        'Uptown': 3.5,
        'Suburbs': 4.2
      };
      
      const distance = locationDistances[currentLocation] || 3; // Default 3km if location not found
      
      if (distance <= 3) {
        return 40;
      } else {
        // ₹40 for first 3km + ₹15 for each additional km
        const additionalKm = Math.ceil(distance - 3);
        return 40 + (additionalKm * 15);
      }
    }

    // Cart Management
    function updateProductQuantity(productId, change) {
      const product = products.find(p => p.id === productId);
      const cartItem = cart.find(item => item.id === productId);
      
      if (cartItem) {
        cartItem.quantity += change;
        if (cartItem.quantity <= 0) {
          cart = cart.filter(item => item.id !== productId);
        }
      } else if (change > 0) {
        cart.push({ ...product, quantity: change });
      }
      
      updateCartDisplay();
      updateProductQuantityDisplay(productId);
    }

    function updateProductQuantityDisplay(productId) {
      const qtyElement = document.getElementById(`qty-${productId}`);
      const cartItem = cart.find(item => item.id === productId);
      if (qtyElement) {
        qtyElement.textContent = cartItem ? cartItem.quantity : 0;
      }
    }

    function addToCart(productId) {
      const product = products.find(p => p.id === productId);
      const qtyElement = document.getElementById(`qty-${productId}`);
      const currentQty = parseInt(qtyElement.textContent) || 0;
      
      if (currentQty === 0) {
        updateProductQuantity(productId, 1);
      } else {
        updateProductQuantity(productId, currentQty);
        qtyElement.textContent = '0';
      }
      
      // Show feedback with enhanced animation
      const button = event.target;
      const originalHTML = button.innerHTML;
      const originalClass = button.className;
      
      button.innerHTML = '<span class="flex items-center justify-center space-x-2"><span>✅</span><span>Added!</span></span>';
      button.className = button.className.replace('btn-primary', 'bg-green-600 hover:bg-green-700');
      
      // Show success toast
      showToast(`${product.name} added to cart!`, 'success');
      
      // Reset button after animation
      setTimeout(() => {
        button.innerHTML = originalHTML;
        button.className = originalClass;
      }, 1500);
      
      // Animate cart pulse
      animateCartPulse();
      
      // Check for auto-applicable offers after adding to cart
      setTimeout(() => {
        checkAndNotifyAutoOffers();
      }, 500);
    }

    function checkAndNotifyAutoOffers() {
      const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      
      // Find newly applicable offers
      const applicableOffers = activeOffers.filter(offer => 
        offer.isActive && 
        offer.autoApply &&
        (!offer.expiryDate || new Date(offer.expiryDate) > new Date()) &&
        (offer.minOrderValue === 0 || subtotal >= offer.minOrderValue)
      );
      
      // Check if we just crossed a threshold for an offer
      applicableOffers.forEach(offer => {
        if (offer.minOrderValue > 0 && subtotal >= offer.minOrderValue) {
          const discount = calculateDiscount(subtotal, offer);
          if (discount > 0 && (!currentOffer || currentOffer.id !== offer.id)) {
            // Show special notification for threshold-based offers
            showToast(`🎉 Congratulations! You've unlocked "${offer.title}" - Save ₹${discount}!`, 'success');
          }
        }
      });
      
      // Force cart update to apply new offers
      updateCartDisplay();
    }

    function updateCartDisplay() {
      const cartCount = cart.reduce((sum, item) => sum + item.quantity, 0);
      const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      
      // Always check and apply best available offers
      applyOfferToCart();
      
      const discount = currentOffer ? calculateDiscount(subtotal, currentOffer) : 0;
      const deliveryFee = (currentOffer && currentOffer.discountType === 'free-delivery') ? 0 : calculateDeliveryFee();
      const total = subtotal - discount + deliveryFee;

      // Update floating cart
      const floatingCart = document.getElementById('floating-cart');
      const floatingCartCount = document.getElementById('floating-cart-count');
      const floatingCartTotal = document.getElementById('floating-cart-total');
      
      if (cartCount > 0) {
        floatingCart.classList.remove('hidden');
        floatingCartCount.textContent = cartCount;
        floatingCartTotal.textContent = `₹${total}`;
        animateCartPulse();
      } else {
        floatingCart.classList.add('hidden');
      }

      // Update cart sidebar
      document.getElementById('cart-items-count').textContent = `${cartCount} item${cartCount !== 1 ? 's' : ''}`;
      document.getElementById('cart-subtotal').textContent = `₹${subtotal}`;
      
      // Show/hide discount row with enhanced details
      const discountRow = document.getElementById('discount-row');
      const savingsDisplay = document.getElementById('savings-display');
      
      if (discount > 0 && currentOffer) {
        discountRow.classList.remove('hidden');
        savingsDisplay.classList.remove('hidden');
        
        document.getElementById('cart-discount').textContent = `-₹${discount}`;
        document.getElementById('discount-label').textContent = `${currentOffer.title}:`;
        document.getElementById('total-savings').textContent = discount;
        
        // Show discount description
        const discountDescription = document.getElementById('discount-description');
        let description = '';
        switch(currentOffer.discountType) {
          case 'percentage':
            description = `${currentOffer.discountValue}% off on your order`;
            break;
          case 'fixed':
            description = `₹${currentOffer.discountValue} flat discount`;
            break;
          case 'free-delivery':
            description = 'Free delivery on this order';
            break;
          case 'buy-get':
            description = 'Buy 1 Get 1 offer applied';
            break;
        }
        
        if (currentOffer.offerCode) {
          description += ` (Code: ${currentOffer.offerCode})`;
        }
        
        discountDescription.textContent = description;
      } else {
        discountRow.classList.add('hidden');
        savingsDisplay.classList.add('hidden');
      }
      
      // Update delivery fee display
      const deliveryFeeElement = document.getElementById('delivery-fee');
      if (deliveryFee === 0) {
        deliveryFeeElement.innerHTML = '<span class="text-green-600 font-medium">FREE</span>';
        if (currentOffer && currentOffer.discountType === 'free-delivery') {
          deliveryFeeElement.innerHTML += ' <span class="text-xs text-green-500">(Offer Applied)</span>';
        }
      } else {
        deliveryFeeElement.textContent = `₹${deliveryFee}`;
      }
      
      document.getElementById('cart-total').textContent = `₹${total}`;

      const checkoutBtn = document.getElementById('checkout-btn');
      checkoutBtn.disabled = cartCount === 0;
      
      if (cartCount === 0) {
        checkoutBtn.innerHTML = `<span class="flex items-center justify-center space-x-2"><span>🛒</span><span>Add items to cart</span></span>`;
        checkoutBtn.className = 'w-full bg-gray-300 text-gray-500 py-3 rounded-lg font-semibold cursor-not-allowed mb-4';
      } else {
        const payText = discount > 0 ? `Pay ₹${total} (Save ₹${discount})` : `Proceed to Checkout`;
        checkoutBtn.innerHTML = `<span class="flex items-center justify-center space-x-2"><span>🛒</span><span>${payText}</span></span>`;
        checkoutBtn.className = 'w-full btn-primary text-white py-3 rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all duration-300 mb-4';
      }

      // Update cart items
      const cartItems = document.getElementById('cart-items');
      if (cart.length === 0) {
        cartItems.innerHTML = `
          <div class="text-center py-16">
            <div class="text-6xl mb-6">🛒</div>
            <h3 class="text-xl font-semibold text-gray-900 mb-2">Your cart is empty</h3>
            <p class="text-gray-600 mb-6">Add some delicious items to get started!</p>
            <button onclick="closeCart()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors">
              Continue Shopping
            </button>
          </div>
        `;
      } else {
        cartItems.innerHTML = cart.map((item, index) => `
          <div class="flex items-center justify-between py-4 border-b border-gray-100 hover:bg-gray-50 rounded-lg px-2 transition-colors">
            <div class="flex items-center flex-1">
              <img src="${item.image}" alt="${item.name}" class="w-16 h-16 object-cover rounded-xl mr-4 shadow-sm">
              <div class="flex-1">
                <h4 class="font-semibold text-gray-900">${item.name}</h4>
                <p class="text-sm text-gray-600 mb-1">${item.description}</p>
                <p class="text-sm font-medium text-blue-600">₹${item.price} each</p>
              </div>
            </div>
            <div class="flex items-center space-x-4">
              <div class="flex items-center space-x-2 bg-gray-100 rounded-lg p-1">
                <button onclick="updateCartQuantity(${index}, -1)" class="w-8 h-8 rounded-lg bg-white hover:bg-red-50 hover:text-red-600 flex items-center justify-center transition-all duration-200 font-bold shadow-sm">−</button>
                <span class="w-8 text-center font-bold text-gray-900">${item.quantity}</span>
                <button onclick="updateCartQuantity(${index}, 1)" class="w-8 h-8 rounded-lg bg-white hover:bg-green-50 hover:text-green-600 flex items-center justify-center transition-all duration-200 font-bold shadow-sm">+</button>
              </div>
              <div class="text-right">
                <p class="font-bold text-gray-900">₹${item.price * item.quantity}</p>
                <button onclick="removeFromCart(${index})" class="text-red-500 hover:text-red-700 text-sm transition-colors">Remove</button>
              </div>
            </div>
          </div>
        `).join('');
      }
    }

    function updateCartQuantity(index, change) {
      cart[index].quantity += change;
      if (cart[index].quantity <= 0) {
        cart.splice(index, 1);
      }
      updateCartDisplay();
      displayProducts(filteredProducts); // Refresh to update quantity displays
    }

    function removeFromCart(index) {
      cart.splice(index, 1);
      updateCartDisplay();
      displayProducts(filteredProducts); // Refresh to update quantity displays
    }

    // Cart UI
    function openCart() {
      document.getElementById('cart-sidebar').classList.remove('translate-x-full');
      document.getElementById('cart-overlay').classList.remove('hidden');
    }

    function closeCart() {
      document.getElementById('cart-sidebar').classList.add('translate-x-full');
      document.getElementById('cart-overlay').classList.add('hidden');
    }

    // Checkout
    function proceedToCheckout() {
      if (!currentLocation) {
        changeLocation();
        return;
      }
      
      document.getElementById('checkout-modal').classList.remove('hidden');
      loadCustomerData();
      updateCheckoutSummary();
    }

    function closeCheckout() {
      document.getElementById('checkout-modal').classList.add('hidden');
    }

    function updateCheckoutSummary() {
      const cartCount = cart.reduce((sum, item) => sum + item.quantity, 0);
      const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      
      // Auto-apply best available offers
      applyOfferToCart();
      
      const discount = currentOffer ? calculateDiscount(subtotal, currentOffer) : 0;
      const deliveryFee = (currentOffer && currentOffer.discountType === 'free-delivery') ? 0 : calculateDeliveryFee();
      const total = subtotal - discount + deliveryFee;

      // Update checkout items list
      const checkoutItemsList = document.getElementById('checkout-items-list');
      checkoutItemsList.innerHTML = cart.map(item => `
        <div class="flex items-center justify-between py-2 border-b border-gray-200 last:border-b-0">
          <div class="flex items-center space-x-3">
            <img src="${item.image}" alt="${item.name}" class="w-12 h-12 object-cover rounded-lg">
            <div>
              <h4 class="font-medium text-sm text-gray-900">${item.name}</h4>
              <p class="text-xs text-gray-500">₹${item.price} each</p>
            </div>
          </div>
          <div class="text-right">
            <div class="font-medium text-sm">₹${item.price * item.quantity}</div>
            <div class="text-xs text-gray-500">Qty: ${item.quantity}</div>
          </div>
        </div>
      `).join('');

      // Update summary values
      document.getElementById('checkout-item-count').textContent = cartCount;
      document.getElementById('checkout-subtotal').textContent = `₹${subtotal}`;
      
      // Show/hide discount section
      const discountRow = document.getElementById('checkout-discount-row');
      const offerBadge = document.getElementById('checkout-offer-badge');
      const savingsDisplay = document.getElementById('checkout-savings');
      
      if (discount > 0 && currentOffer) {
        discountRow.classList.remove('hidden');
        offerBadge.classList.remove('hidden');
        savingsDisplay.classList.remove('hidden');
        
        document.getElementById('checkout-discount-label').textContent = currentOffer.title;
        document.getElementById('checkout-discount-amount').textContent = `-₹${discount}`;
        document.getElementById('checkout-total-savings').textContent = discount;
        
        // Update offer badge
        document.getElementById('checkout-offer-title').textContent = currentOffer.title;
        
        // Update discount description
        let description = '';
        switch(currentOffer.discountType) {
          case 'percentage':
            description = `${currentOffer.discountValue}% off on your order`;
            break;
          case 'fixed':
            description = `₹${currentOffer.discountValue} flat discount applied`;
            break;
          case 'free-delivery':
            description = 'Free delivery on this order';
            break;
          case 'buy-get':
            description = 'Buy 1 Get 1 offer applied';
            break;
        }
        
        if (currentOffer.offerCode) {
          description += ` (Code: ${currentOffer.offerCode})`;
        } else if (currentOffer.autoApply) {
          description += ' (Automatically applied)';
        }
        
        document.getElementById('checkout-discount-description').textContent = description;
        document.getElementById('checkout-offer-details').textContent = description;
      } else {
        discountRow.classList.add('hidden');
        offerBadge.classList.add('hidden');
        savingsDisplay.classList.add('hidden');
      }
      
      // Update delivery fee
      const deliveryFeeElement = document.getElementById('checkout-delivery-fee');
      if (deliveryFee === 0) {
        deliveryFeeElement.innerHTML = '<span class="text-green-600 font-medium">FREE</span>';
      } else {
        deliveryFeeElement.textContent = `₹${deliveryFee}`;
      }
      
      // Update total
      document.getElementById('checkout-total').textContent = `₹${total}`;
      
      // Update place order button
      const placeOrderBtn = document.getElementById('place-order-btn');
      if (discount > 0) {
        placeOrderBtn.innerHTML = `
          <span class="flex items-center justify-center">
            <span class="mr-2">🛒</span>
            <span>Pay ₹${total} (Save ₹${discount})</span>
          </span>
        `;
      } else {
        placeOrderBtn.innerHTML = `
          <span class="flex items-center justify-center">
            <span class="mr-2">🛒</span>
            <span>Place Order - ₹${total}</span>
          </span>
        `;
      }
    }

    function loadCustomerData() {
      if (currentUser) {
        // Show logged in user info
        document.getElementById('logged-user-info').classList.remove('hidden');
        document.getElementById('guest-checkout-fields').classList.add('hidden');
        
        document.getElementById('checkout-user-name').textContent = currentUser.name;
        document.getElementById('checkout-user-phone').textContent = currentUser.phone;
        document.getElementById('checkout-user-address').textContent = currentUser.address;
        
        // Remove required attributes for hidden fields
        document.getElementById('customer-name').removeAttribute('required');
        document.getElementById('customer-phone').removeAttribute('required');
        document.getElementById('customer-address').removeAttribute('required');
      } else {
        // Show guest checkout fields
        document.getElementById('logged-user-info').classList.add('hidden');
        document.getElementById('guest-checkout-fields').classList.remove('hidden');
        
        // Restore required attributes
        document.getElementById('customer-name').setAttribute('required', '');
        document.getElementById('customer-phone').setAttribute('required', '');
        document.getElementById('customer-address').setAttribute('required', '');
        
        // Load any saved guest data
        const name = localStorage.getItem('customerName');
        const phone = localStorage.getItem('customerPhone');
        const address = localStorage.getItem('customerAddress');

        if (name) document.getElementById('customer-name').value = name;
        if (phone) document.getElementById('customer-phone').value = phone;
        if (address) document.getElementById('customer-address').value = address;
      }
    }

    function editDeliveryDetails() {
      document.getElementById('logged-user-info').classList.add('hidden');
      document.getElementById('guest-checkout-fields').classList.remove('hidden');
      
      // Pre-fill with current user data
      document.getElementById('customer-name').value = currentUser.name;
      document.getElementById('customer-phone').value = currentUser.phone;
      document.getElementById('customer-address').value = currentUser.address;
      
      // Add required attributes
      document.getElementById('customer-name').setAttribute('required', '');
      document.getElementById('customer-phone').setAttribute('required', '');
      document.getElementById('customer-address').setAttribute('required', '');
    }

    let currentOrderId = null;

    function closeSuccess() {
      document.getElementById('success-modal').classList.add('hidden');
      cart = [];
      updateCartDisplay();
      displayProducts(filteredProducts);
      closeCart();
    }

    function trackOrder() {
      if (currentOrderId) {
        const order = orders.find(o => o.id === currentOrderId);
        if (order) {
          showOrderTracking(order);
        }
      }
    }

    function showOrderTracking(order) {
      document.getElementById('tracking-order-id').textContent = order.id;
      document.getElementById('tracking-order-time').textContent = order.timestamp;
      document.getElementById('tracking-order-total').textContent = order.total;
      
      // Update tracking items
      document.getElementById('tracking-items').innerHTML = order.items.map(item => 
        `<p class="text-sm text-gray-600">${item.quantity}x ${item.name}</p>`
      ).join('');
      
      // Update status indicators
      updateTrackingStatus(order.status);
      
      // Initialize GPS tracking if order is out for delivery
      if (order.status === 'out-for-delivery') {
        initializeGPSTracking(order);
      }
      
      document.getElementById('success-modal').classList.add('hidden');
      document.getElementById('tracking-modal').classList.remove('hidden');
    }

    function updateTrackingStatus(currentStatus) {
      const statuses = ['pending', 'processing', 'ready', 'out-for-delivery', 'delivered'];
      const statusElements = {
        'pending': 'status-pending',
        'processing': 'status-processing', 
        'ready': 'status-ready',
        'out-for-delivery': 'status-out-for-delivery',
        'delivered': 'status-delivered'
      };
      
      const currentIndex = statuses.indexOf(currentStatus);
      
      statuses.forEach((status, index) => {
        const element = document.getElementById(statusElements[status]);
        const circle = element.querySelector('div');
        const text = element.querySelector('p');
        
        if (index <= currentIndex) {
          // Completed or current status
          element.className = element.className.replace(/bg-gray-50 border-gray-300/, `bg-${getStatusBgColor(status)}-50 border-${getStatusBgColor(status)}-400`);
          circle.className = circle.className.replace(/bg-gray-300/, `bg-${getStatusBgColor(status)}-400`);
          text.className = text.className.replace(/text-gray-600/, `text-${getStatusBgColor(status)}-800`);
          element.querySelector('p:last-child').className = element.querySelector('p:last-child').className.replace(/text-gray-500/, `text-${getStatusBgColor(status)}-600`);
        } else {
          // Future status
          element.className = element.className.replace(/bg-\w+-50 border-\w+-400/, 'bg-gray-50 border-gray-300');
          circle.className = circle.className.replace(/bg-\w+-400/, 'bg-gray-300');
          text.className = text.className.replace(/text-\w+-800/, 'text-gray-600');
          element.querySelector('p:last-child').className = element.querySelector('p:last-child').className.replace(/text-\w+-600/, 'text-gray-500');
        }
      });
    }

    function getStatusBgColor(status) {
      switch(status) {
        case 'pending': return 'yellow';
        case 'processing': return 'blue';
        case 'ready': return 'purple';
        case 'out-for-delivery': return 'indigo';
        case 'delivered': return 'green';
        default: return 'gray';
      }
    }

    function closeTracking() {
      document.getElementById('tracking-modal').classList.add('hidden');
      // Stop GPS tracking when modal is closed
      stopGPSTracking();
    }

    // Advanced GPS Tracking System with Real-time Updates
    let gpsTrackingInterval = null;
    let currentTrackingOrder = null;
    let deliveryPersonLocation = null;
    let customerLocation = null;
    let googleMap = null;
    let fullscreenGoogleMap = null;
    let deliveryMarker = null;
    let customerMarker = null;
    let routePath = null;
    let directionsService = null;
    let directionsRenderer = null;
    let isGoogleMapsLoaded = false;
    let trafficLayer = null;
    let heatmapLayer = null;
    let locationHistory = [];
    let estimatedArrivalTime = null;
    let realTimeUpdates = null;
    let geofenceAlerts = [];
    let batteryOptimization = true;
    let networkStatus = 'online';
    let locationAccuracy = 'high';

    // Simulated delivery partners database
    const deliveryPartners = [
      { id: 1, name: 'Rajesh Kumar', phone: '+91-9876543210', vehicle: 'Bike', rating: 4.8 },
      { id: 2, name: 'Amit Singh', phone: '+91-9876543211', vehicle: 'Scooter', rating: 4.9 },
      { id: 3, name: 'Priya Sharma', phone: '+91-9876543212', vehicle: 'Bike', rating: 4.7 },
      { id: 4, name: 'Vikash Yadav', phone: '+91-9876543213', vehicle: 'Bike', rating: 4.6 },
      { id: 5, name: 'Sunita Devi', phone: '+91-9876543214', vehicle: 'Scooter', rating: 4.8 }
    ];

    // City coordinates for simulation (you can replace with real coordinates)
    const cityLocations = {
      'Downtown': { lat: 28.6139, lng: 77.2090 },
      'Uptown': { lat: 28.6289, lng: 77.2065 },
      'City Center': { lat: 28.6129, lng: 77.2295 },
      'Suburbs': { lat: 28.5355, lng: 77.3910 }
    };

    // Advanced Google Maps Initialization with Latest Features
    function initGoogleMaps() {
      isGoogleMapsLoaded = true;
      console.log('Google Maps API loaded successfully');
      
      // Initialize advanced mapping services
      if (window.google && window.google.maps) {
        // Core services
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
          suppressMarkers: true,
          polylineOptions: {
            strokeColor: '#3B82F6',
            strokeWeight: 5,
            strokeOpacity: 0.9,
            geodesic: true
          }
        });
        
        // Initialize advanced features
        initializeAdvancedMapFeatures();
        
        // Setup real-time connectivity monitoring
        setupNetworkMonitoring();
        
        // Initialize geolocation with high accuracy
        initializeHighAccuracyGeolocation();
        
        showToast('🗺️ Advanced GPS tracking system initialized', 'success');
      } else {
        console.error('Google Maps failed to load');
        showToast('⚠️ Maps not available. Using fallback tracking system.', 'warning');
        initializeFallbackTracking();
      }
    }

    function initializeAdvancedMapFeatures() {
      // Traffic layer for real-time traffic data
      trafficLayer = new google.maps.TrafficLayer();
      
      // Initialize Places service for better location accuracy
      if (google.maps.places) {
        placesService = new google.maps.places.PlacesService(document.createElement('div'));
      }
      
      // Setup geocoding service for address validation
      geocoder = new google.maps.Geocoder();
      
      console.log('Advanced map features initialized');
    }

    function setupNetworkMonitoring() {
      // Monitor network connectivity
      window.addEventListener('online', () => {
        networkStatus = 'online';
        showToast('📶 Connection restored - GPS tracking resumed', 'success');
        if (gpsTrackingInterval) {
          resumeHighAccuracyTracking();
        }
      });
      
      window.addEventListener('offline', () => {
        networkStatus = 'offline';
        showToast('📶 Connection lost - Using cached location data', 'warning');
        switchToBatteryOptimizedMode();
      });
    }

    function initializeHighAccuracyGeolocation() {
      // Check if device supports high accuracy GPS
      if (navigator.geolocation) {
        // Test GPS capabilities
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const accuracy = position.coords.accuracy;
            if (accuracy <= 10) {
              locationAccuracy = 'high';
              showToast('📍 High-precision GPS available (±' + Math.round(accuracy) + 'm)', 'success');
            } else if (accuracy <= 50) {
              locationAccuracy = 'medium';
              showToast('📍 Medium-precision GPS available (±' + Math.round(accuracy) + 'm)', 'success');
            } else {
              locationAccuracy = 'low';
              showToast('📍 Basic GPS available (±' + Math.round(accuracy) + 'm)', 'warning');
            }
          },
          (error) => {
            locationAccuracy = 'unavailable';
            console.log('GPS capability test failed:', error);
          },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
          }
        );
      }
    }

    function initializeFallbackTracking() {
      // Fallback tracking system when Google Maps is unavailable
      console.log('Initializing fallback tracking system');
      showToast('📍 Using basic location tracking (Google Maps unavailable)', 'warning');
    }

    // Fallback if Google Maps fails to load
    window.addEventListener('load', function() {
      setTimeout(() => {
        if (!isGoogleMapsLoaded) {
          console.log('Google Maps API failed to load - using fallback');
          showToast('⚠️ Google Maps unavailable. GPS tracking will use basic location services.', 'warning');
          
          // Show setup instructions
          if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            showSetupInstructions();
          }
        }
      }, 5000);
    });

    function showSetupInstructions() {
      const instructions = `
🔧 SETUP REQUIRED FOR REAL ENVIRONMENT:

1. 📍 GOOGLE MAPS API:
   - Get API key from Google Cloud Console
   - Replace 'YOUR_GOOGLE_MAPS_API_KEY' in the script tag
   - Enable Maps JavaScript API, Places API, Directions API

2. 🌐 HTTPS REQUIRED:
   - GPS location only works on HTTPS
   - Deploy to secure server or use ngrok for testing

3. 📱 MOBILE TESTING:
   - Test on actual mobile devices
   - GPS tracking works best on phones

4. 🚚 DELIVERY PARTNER APP:
   - In production, delivery partner would have separate app
   - Their GPS coordinates would be sent to your server
   - Server would broadcast location to customer app

5. 🔄 REAL-TIME UPDATES:
   - Use WebSocket or Server-Sent Events
   - Connect to backend API for live tracking
   - Store GPS coordinates in database

Current Status: Demo mode with simulated GPS
      `;
      
      console.log(instructions);
      
      // Show in UI for developers
      const devNotice = document.createElement('div');
      devNotice.className = 'fixed bottom-4 left-4 bg-yellow-100 border-l-4 border-yellow-500 p-4 rounded shadow-lg max-w-sm z-50';
      devNotice.innerHTML = `
        <div class="flex items-start">
          <div class="text-yellow-600 mr-2">⚠️</div>
          <div>
            <h4 class="font-bold text-yellow-800">Development Mode</h4>
            <p class="text-sm text-yellow-700 mt-1">GPS tracking is simulated. Check console for setup instructions.</p>
            <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-xs text-yellow-600 hover:text-yellow-800 mt-2">Dismiss</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(devNotice);
      
      // Auto-remove after 10 seconds
      setTimeout(() => {
        if (devNotice.parentElement) {
          devNotice.remove();
        }
      }, 10000);
    }

    // Initialize Google Map for tracking
    function initializeGoogleMap(containerId, isFullscreen = false) {
      if (!isGoogleMapsLoaded || !window.google) {
        console.log('Google Maps not loaded yet');
        return null;
      }

      const mapContainer = document.getElementById(containerId);
      if (!mapContainer) return null;

      // Default center (Delhi)
      const defaultCenter = { lat: 28.6139, lng: 77.2090 };
      
      const map = new google.maps.Map(mapContainer, {
        zoom: 13,
        center: defaultCenter,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        styles: [
          {
            featureType: 'poi',
            elementType: 'labels',
            stylers: [{ visibility: 'off' }]
          }
        ],
        mapTypeControl: true,
        streetViewControl: true,
        fullscreenControl: isFullscreen,
        zoomControl: true
      });

      return map;
    }

    // Create custom markers
    function createCustomMarker(map, position, type, title) {
      const markerIcons = {
        delivery: {
          url: 'data:image/svg+xml;base64,' + btoa(`
            <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
              <circle cx="20" cy="20" r="18" fill="#3B82F6" stroke="white" stroke-width="3"/>
              <text x="20" y="26" text-anchor="middle" fill="white" font-size="16" font-family="Arial">🛵</text>
            </svg>
          `),
          scaledSize: new google.maps.Size(40, 40),
          anchor: new google.maps.Point(20, 20)
        },
        customer: {
          url: 'data:image/svg+xml;base64,' + btoa(`
            <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
              <circle cx="20" cy="20" r="18" fill="#10B981" stroke="white" stroke-width="3"/>
              <text x="20" y="26" text-anchor="middle" fill="white" font-size="16" font-family="Arial">🏠</text>
            </svg>
          `),
          scaledSize: new google.maps.Size(40, 40),
          anchor: new google.maps.Point(20, 20)
        }
      };

      const marker = new google.maps.Marker({
        position: position,
        map: map,
        title: title,
        icon: markerIcons[type],
        animation: google.maps.Animation.DROP
      });

      return marker;
    }

    // Update route on map
    function updateMapRoute(map, start, end) {
      if (!directionsService || !directionsRenderer) return;

      directionsRenderer.setMap(map);

      const request = {
        origin: start,
        destination: end,
        travelMode: google.maps.TravelMode.DRIVING,
        avoidHighways: false,
        avoidTolls: false
      };

      directionsService.route(request, (result, status) => {
        if (status === 'OK') {
          directionsRenderer.setDirections(result);
          
          // Calculate and display route info
          const route = result.routes[0];
          const leg = route.legs[0];
          
          // Update distance and duration displays
          document.getElementById('delivery-distance').textContent = leg.distance.text;
          document.getElementById('delivery-eta').textContent = leg.duration.text;
          document.getElementById('fullscreen-distance').textContent = `Distance: ${leg.distance.text}`;
          document.getElementById('fullscreen-eta').textContent = `ETA: ${leg.duration.text}`;
        } else {
          console.error('Directions request failed:', status);
        }
      });
    }

    function initializeGPSTracking(order) {
      currentTrackingOrder = order;
      
      // Assign random delivery partner
      const partner = deliveryPartners[Math.floor(Math.random() * deliveryPartners.length)];
      order.deliveryPartner = partner;
      
      // Show delivery partner info
      showDeliveryPartnerInfo(partner);
      
      // Get customer location (simulate based on delivery location)
      getCustomerLocation(order);
      
      // Start GPS tracking simulation
      startGPSTracking();
      
      // Initialize Google Maps
      initializeTrackingMap();
    }

    function showDeliveryPartnerInfo(partner) {
      document.getElementById('delivery-person-info').classList.remove('hidden');
      document.getElementById('delivery-person-name').textContent = partner.name;
      document.getElementById('delivery-person-phone').textContent = `📞 Contact: ${partner.phone}`;
      document.getElementById('delivery-person-initial').textContent = partner.name.charAt(0);
      document.getElementById('delivery-vehicle').textContent = partner.vehicle;
    }

    function getCustomerLocation(order) {
      // Try to get real customer location using GPS
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            // Use real customer GPS location
            customerLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
            
            // Start delivery person at a nearby location (simulating restaurant/store)
            deliveryPersonLocation = {
              lat: customerLocation.lat + (Math.random() - 0.5) * 0.02,
              lng: customerLocation.lng + (Math.random() - 0.5) * 0.02,
              heading: Math.random() * 360,
              speed: 0
            };
            
            // Update map with real locations
            if (googleMap) {
              initializeTrackingMap();
            }
            
            showToast('📍 Using your real GPS location for tracking', 'success');
          },
          (error) => {
            console.log('GPS location failed:', error);
            // Fallback to simulated location
            const baseLocation = cityLocations[order.customer.location] || cityLocations['Downtown'];
            
            customerLocation = {
              lat: baseLocation.lat + (Math.random() - 0.5) * 0.01,
              lng: baseLocation.lng + (Math.random() - 0.5) * 0.01
            };
            
            deliveryPersonLocation = {
              lat: baseLocation.lat + (Math.random() - 0.5) * 0.02,
              lng: baseLocation.lng + (Math.random() - 0.5) * 0.02,
              heading: Math.random() * 360,
              speed: 0
            };
            
            showToast('📍 Using approximate location (GPS not available)', 'warning');
          },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 300000 // 5 minutes
          }
        );
      } else {
        // Fallback for browsers without geolocation
        const baseLocation = cityLocations[order.customer.location] || cityLocations['Downtown'];
        
        customerLocation = {
          lat: baseLocation.lat + (Math.random() - 0.5) * 0.01,
          lng: baseLocation.lng + (Math.random() - 0.5) * 0.01
        };
        
        deliveryPersonLocation = {
          lat: baseLocation.lat + (Math.random() - 0.5) * 0.02,
          lng: baseLocation.lng + (Math.random() - 0.5) * 0.02,
          heading: Math.random() * 360,
          speed: 0
        };
        
        showToast('📍 GPS not supported, using approximate location', 'warning');
      }
    }

    function startGPSTracking() {
      if (gpsTrackingInterval) {
        clearInterval(gpsTrackingInterval);
      }
      
      // Initialize advanced tracking features
      initializeRealTimeTracking();
      
      // Setup adaptive update intervals based on network and battery
      const updateInterval = getOptimalUpdateInterval();
      
      // Start high-frequency tracking
      gpsTrackingInterval = setInterval(() => {
        updateDeliveryPersonLocationAdvanced();
        updateTrackingDisplayAdvanced();
        addIntelligentDeliveryUpdate();
        updateCustomerLocationIfNeeded();
        
        // Advanced features
        checkGeofenceAlerts();
        updateETAWithTraffic();
        logLocationHistory();
        
        // Battery optimization
        if (batteryOptimization) {
          optimizeBatteryUsage();
        }
      }, updateInterval);
      
      // Initial update with full data
      updateTrackingDisplayAdvanced();
      
      // Start continuous high-accuracy location watching
      startAdvancedLocationWatching();
      
      // Initialize real-time communication
      setupRealTimeUpdates();
      
      showToast('🚀 Advanced GPS tracking started', 'success');
    }

    function initializeRealTimeTracking() {
      // Setup WebSocket connection for real-time updates (simulated)
      console.log('Initializing real-time tracking system');
      
      // In production, this would connect to WebSocket server
      realTimeUpdates = {
        connected: true,
        lastUpdate: new Date(),
        updateCount: 0
      };
      
      // Setup geofence alerts
      setupGeofenceAlerts();
    }

    function getOptimalUpdateInterval() {
      // Adaptive interval based on conditions
      if (networkStatus === 'offline') return 30000; // 30 seconds offline
      if (locationAccuracy === 'low') return 10000;  // 10 seconds for low accuracy
      if (batteryOptimization) return 3000;          // 3 seconds with battery optimization
      return 2000; // 2 seconds for high-performance tracking
    }

    function setupGeofenceAlerts() {
      // Define geofence zones
      geofenceAlerts = [
        {
          name: 'Near Customer',
          radius: 100, // 100 meters
          triggered: false,
          action: 'notify_arrival'
        },
        {
          name: 'Traffic Zone',
          radius: 500, // 500 meters
          triggered: false,
          action: 'check_traffic'
        }
      ];
    }

    function resumeHighAccuracyTracking() {
      if (gpsTrackingInterval) {
        clearInterval(gpsTrackingInterval);
        startGPSTracking();
      }
    }

    function switchToBatteryOptimizedMode() {
      batteryOptimization = true;
      if (gpsTrackingInterval) {
        clearInterval(gpsTrackingInterval);
        startGPSTracking();
      }
    }

    let customerLocationWatcher = null;

    function startCustomerLocationWatching() {
      if (navigator.geolocation && !customerLocationWatcher) {
        customerLocationWatcher = navigator.geolocation.watchPosition(
          (position) => {
            // Update customer location in real-time
            customerLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
            
            // Update map with new customer location
            if (googleMap && customerMarker) {
              customerMarker.setPosition(customerLocation);
              updateMapRoute(googleMap, deliveryPersonLocation, customerLocation);
            }
          },
          (error) => {
            console.log('Customer location watch error:', error);
          },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 30000 // 30 seconds
          }
        );
      }
    }

    function updateCustomerLocationIfNeeded() {
      // Periodically refresh customer location for accuracy
      if (navigator.geolocation && Math.random() > 0.8) { // 20% chance each update
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const newLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
            
            // Only update if location changed significantly (more than 10 meters)
            if (customerLocation) {
              const distance = calculateDistance(customerLocation, newLocation);
              if (distance > 0.01) { // 10 meters
                customerLocation = newLocation;
                if (googleMap && customerMarker) {
                  customerMarker.setPosition(customerLocation);
                }
              }
            }
          },
          (error) => {
            // Silently handle errors for periodic updates
          },
          {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 60000 // 1 minute
          }
        );
      }
    }

    function stopGPSTracking() {
      if (gpsTrackingInterval) {
        clearInterval(gpsTrackingInterval);
        gpsTrackingInterval = null;
      }
      
      // Stop watching customer location
      if (customerLocationWatcher) {
        navigator.geolocation.clearWatch(customerLocationWatcher);
        customerLocationWatcher = null;
      }
    }

    function updateDeliveryPersonLocationAdvanced() {
      if (!deliveryPersonLocation || !customerLocation) return;
      
      // Advanced location simulation with realistic GPS behavior
      const deltaLat = customerLocation.lat - deliveryPersonLocation.lat;
      const deltaLng = customerLocation.lng - deliveryPersonLocation.lng;
      const distance = Math.sqrt(deltaLat * deltaLat + deltaLng * deltaLng);
      
      // If very close to customer, stop moving
      if (distance < 0.0005) {
        deliveryPersonLocation.speed = 0;
        deliveryPersonLocation.status = 'arrived';
        return;
      }
      
      // Advanced movement simulation with multiple factors
      const baseSpeed = getRealisticSpeed();
      const trafficFactor = getTrafficFactor();
      const roadFactor = getRoadConstraints();
      const weatherFactor = getWeatherFactor();
      
      // Calculate optimal route direction
      const direction = Math.atan2(deltaLat, deltaLng);
      const actualDirection = direction + roadFactor;
      
      // Apply all factors to movement
      const finalSpeed = baseSpeed * trafficFactor * weatherFactor;
      
      // Update position with advanced calculations
      deliveryPersonLocation.lat += Math.sin(actualDirection) * finalSpeed;
      deliveryPersonLocation.lng += Math.cos(actualDirection) * finalSpeed;
      deliveryPersonLocation.heading = actualDirection * (180 / Math.PI);
      deliveryPersonLocation.speed = (finalSpeed * 111000 * 3.6).toFixed(1);
      
      // Advanced GPS metadata
      deliveryPersonLocation.accuracy = getGPSAccuracy();
      deliveryPersonLocation.lastUpdate = new Date();
      deliveryPersonLocation.altitude = 50 + Math.random() * 20; // Simulate altitude
      deliveryPersonLocation.bearing = deliveryPersonLocation.heading;
      deliveryPersonLocation.provider = locationAccuracy === 'high' ? 'GPS' : 'Network';
      
      // Update real-time stats
      realTimeUpdates.updateCount++;
      realTimeUpdates.lastUpdate = new Date();
    }

    function getRealisticSpeed() {
      // Simulate realistic delivery vehicle speeds
      const timeOfDay = new Date().getHours();
      let baseSpeed = 0.0001;
      
      // Adjust speed based on time (rush hour, etc.)
      if (timeOfDay >= 8 && timeOfDay <= 10) baseSpeed *= 0.7; // Morning rush
      if (timeOfDay >= 17 && timeOfDay <= 19) baseSpeed *= 0.6; // Evening rush
      if (timeOfDay >= 22 || timeOfDay <= 6) baseSpeed *= 1.3; // Night time
      
      // Add random variation
      return baseSpeed + (Math.random() * 0.0001);
    }

    function getTrafficFactor() {
      // Simulate real-time traffic conditions
      const random = Math.random();
      if (random > 0.9) return 0.3; // Heavy traffic
      if (random > 0.7) return 0.6; // Moderate traffic
      if (random > 0.3) return 0.8; // Light traffic
      return 1.0; // Clear roads
    }

    function getRoadConstraints() {
      // Simulate following actual roads (not straight line)
      return (Math.random() - 0.5) * 0.3;
    }

    function getWeatherFactor() {
      // Simulate weather impact on delivery speed
      return 0.9 + (Math.random() * 0.2); // 90-110% of normal speed
    }

    function getGPSAccuracy() {
      // Simulate realistic GPS accuracy based on conditions
      if (locationAccuracy === 'high') {
        return Math.random() > 0.8 ? 'Medium' : 'High';
      } else if (locationAccuracy === 'medium') {
        return Math.random() > 0.6 ? 'Low' : 'Medium';
      }
      return 'Low';
    }

    function updateTrackingDisplayAdvanced() {
      if (!deliveryPersonLocation || !customerLocation) return;
      
      // Advanced ETA calculation with traffic data
      calculateAdvancedETA();
      
      // Update display with enhanced information
      updateAdvancedLocationDisplay();
      
      // Update map with traffic layer
      if (googleMap && trafficLayer) {
        trafficLayer.setMap(googleMap);
      }
      
      // Update real-time statistics
      updateRealTimeStats();
    }

    function calculateAdvancedETA() {
      if (isGoogleMapsLoaded && directionsService) {
        // Use Google's real-time traffic data for accurate ETA
        const request = {
          origin: deliveryPersonLocation,
          destination: customerLocation,
          travelMode: google.maps.TravelMode.DRIVING,
          drivingOptions: {
            departureTime: new Date(),
            trafficModel: google.maps.TrafficModel.BEST_GUESS
          },
          avoidHighways: false,
          avoidTolls: false
        };

        directionsService.route(request, (result, status) => {
          if (status === 'OK') {
            const route = result.routes[0];
            const leg = route.legs[0];
            
            // Update displays with traffic-aware data
            document.getElementById('delivery-distance').textContent = leg.distance.text;
            document.getElementById('delivery-eta').textContent = leg.duration_in_traffic ? 
              leg.duration_in_traffic.text : leg.duration.text;
            
            // Update fullscreen displays
            document.getElementById('fullscreen-distance').textContent = `Distance: ${leg.distance.text}`;
            document.getElementById('fullscreen-eta').textContent = `ETA: ${leg.duration_in_traffic ? 
              leg.duration_in_traffic.text : leg.duration.text}`;
            
            // Store for advanced calculations
            estimatedArrivalTime = new Date(Date.now() + (leg.duration_in_traffic ? 
              leg.duration_in_traffic.value * 1000 : leg.duration.value * 1000));
          }
        });
      } else {
        // Fallback calculation
        const distance = calculateDistance(deliveryPersonLocation, customerLocation);
        const eta = calculateETA(distance, deliveryPersonLocation.speed || 20);
        
        document.getElementById('delivery-distance').textContent = `${distance.toFixed(1)} km`;
        document.getElementById('delivery-eta').textContent = eta;
      }
    }

    function updateAdvancedLocationDisplay() {
      // Update speed with more precision
      const speed = parseFloat(deliveryPersonLocation.speed) || 0;
      document.getElementById('delivery-speed').textContent = `${speed} km/h`;
      
      // Update accuracy with detailed info
      const accuracy = deliveryPersonLocation.accuracy || 'Unknown';
      const provider = deliveryPersonLocation.provider || 'GPS';
      document.getElementById('location-accuracy').textContent = `${accuracy} (${provider})`;
      
      // Update last update time with precision
      const lastUpdate = deliveryPersonLocation.lastUpdate;
      const timeDiff = Math.floor((new Date() - lastUpdate) / 1000);
      document.getElementById('location-last-update').textContent = 
        timeDiff < 5 ? 'Just now' : `${timeDiff}s ago`;
    }

    function updateRealTimeStats() {
      // Update connection status
      const connectionStatus = networkStatus === 'online' ? 
        `🟢 Connected (${realTimeUpdates.updateCount} updates)` : 
        '🔴 Offline Mode';
      
      // Add connection indicator to UI
      const statusElement = document.getElementById('connection-status');
      if (statusElement) {
        statusElement.textContent = connectionStatus;
      }
    }

    function updateTrackingDisplay() {
      if (!deliveryPersonLocation || !customerLocation) return;
      
      // Calculate distance and ETA using Google Maps if available
      if (isGoogleMapsLoaded && window.google) {
        // Use Google Maps Distance Matrix API for more accurate calculations
        const service = new google.maps.DistanceMatrixService();
        service.getDistanceMatrix({
          origins: [deliveryPersonLocation],
          destinations: [customerLocation],
          travelMode: google.maps.TravelMode.DRIVING,
          unitSystem: google.maps.UnitSystem.METRIC,
          avoidHighways: false,
          avoidTolls: false
        }, (response, status) => {
          if (status === 'OK' && response.rows[0].elements[0].status === 'OK') {
            const element = response.rows[0].elements[0];
            const distance = element.distance.text;
            const duration = element.duration.text;
            
            // Update display elements
            document.getElementById('delivery-distance').textContent = distance;
            document.getElementById('delivery-eta').textContent = duration;
            document.getElementById('fullscreen-distance').textContent = `Distance: ${distance}`;
            document.getElementById('fullscreen-eta').textContent = `ETA: ${duration}`;
          }
        });
      } else {
        // Fallback to manual calculation
        const distance = calculateDistance(deliveryPersonLocation, customerLocation);
        const eta = calculateETA(distance, deliveryPersonLocation.speed || 20);
        
        // Update display elements
        document.getElementById('delivery-distance').textContent = `${distance.toFixed(1)} km`;
        document.getElementById('delivery-eta').textContent = eta;
        document.getElementById('fullscreen-distance').textContent = `Distance: ${distance.toFixed(1)} km`;
        document.getElementById('fullscreen-eta').textContent = `ETA: ${eta}`;
      }
      
      // Update other display elements
      document.getElementById('delivery-speed').textContent = `${deliveryPersonLocation.speed || 0} km/h`;
      document.getElementById('location-last-update').textContent = 'Just now';
      document.getElementById('location-accuracy').textContent = 'High';
      
      // Update map if initialized
      if (googleMap) {
        updateMapMarkers();
      }
    }

    function calculateDistance(pos1, pos2) {
      const R = 6371; // Earth's radius in km
      const dLat = (pos2.lat - pos1.lat) * Math.PI / 180;
      const dLng = (pos2.lng - pos1.lng) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(pos1.lat * Math.PI / 180) * Math.cos(pos2.lat * Math.PI / 180) *
                Math.sin(dLng/2) * Math.sin(dLng/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function calculateETA(distance, speed) {
      if (speed === 0) return 'Calculating...';
      const timeInHours = distance / speed;
      const timeInMinutes = Math.round(timeInHours * 60);
      
      if (timeInMinutes < 1) return 'Arriving now';
      if (timeInMinutes === 1) return '1 minute';
      if (timeInMinutes < 60) return `${timeInMinutes} minutes`;
      
      const hours = Math.floor(timeInMinutes / 60);
      const minutes = timeInMinutes % 60;
      return `${hours}h ${minutes}m`;
    }

    function addIntelligentDeliveryUpdate() {
      // Intelligent updates based on actual delivery status and location
      const updates = getContextualUpdates();
      
      // Add updates based on conditions and timing
      if (shouldAddUpdate()) {
        const update = selectBestUpdate(updates);
        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        const updatesContainer = document.getElementById('delivery-updates');
        const updateElement = document.createElement('div');
        updateElement.className = `text-sm text-gray-600 ${update.bgColor} p-2 rounded border-l-4 ${update.borderColor}`;
        updateElement.innerHTML = `
          <div class="flex items-center space-x-2">
            <span class="text-lg">${update.icon}</span>
            <div>
              <span class="font-medium">${time}:</span> ${update.message}
              ${update.subtext ? `<div class="text-xs text-gray-500 mt-1">${update.subtext}</div>` : ''}
            </div>
          </div>
        `;
        
        updatesContainer.insertBefore(updateElement, updatesContainer.firstChild);
        
        // Keep only last 8 updates for better history
        while (updatesContainer.children.length > 8) {
          updatesContainer.removeChild(updatesContainer.lastChild);
        }
        
        // Show important updates as notifications
        if (update.important) {
          showToast(`🚚 ${update.message}`, 'success');
        }
      }
    }

    function getContextualUpdates() {
      const distance = calculateDistance(deliveryPersonLocation, customerLocation);
      const speed = parseFloat(deliveryPersonLocation.speed) || 0;
      const timeOfDay = new Date().getHours();
      
      let updates = [];
      
      // Distance-based updates
      if (distance > 2) {
        updates.push({
          message: 'On the way to your location',
          icon: '🚚',
          bgColor: 'bg-blue-50',
          borderColor: 'border-blue-400',
          important: false,
          subtext: `${distance.toFixed(1)}km away`
        });
      } else if (distance > 0.5) {
        updates.push({
          message: 'Getting closer to your area',
          icon: '📍',
          bgColor: 'bg-green-50',
          borderColor: 'border-green-400',
          important: false,
          subtext: 'Less than 2km away'
        });
      } else if (distance > 0.1) {
        updates.push({
          message: 'Almost at your location',
          icon: '🎯',
          bgColor: 'bg-orange-50',
          borderColor: 'border-orange-400',
          important: true,
          subtext: 'Arriving soon'
        });
      } else {
        updates.push({
          message: 'Arrived at your building',
          icon: '✅',
          bgColor: 'bg-green-50',
          borderColor: 'border-green-400',
          important: true,
          subtext: 'Please come to collect your order'
        });
      }
      
      // Speed-based updates
      if (speed < 5) {
        updates.push({
          message: 'Navigating through traffic',
          icon: '🚦',
          bgColor: 'bg-yellow-50',
          borderColor: 'border-yellow-400',
          important: false,
          subtext: 'Moving slowly due to traffic'
        });
      } else if (speed > 30) {
        updates.push({
          message: 'Taking the highway route',
          icon: '🛣️',
          bgColor: 'bg-blue-50',
          borderColor: 'border-blue-400',
          important: false,
          subtext: 'Good traffic conditions'
        });
      }
      
      // Time-based updates
      if (timeOfDay >= 12 && timeOfDay <= 14) {
        updates.push({
          message: 'Lunch hour delivery in progress',
          icon: '🍽️',
          bgColor: 'bg-purple-50',
          borderColor: 'border-purple-400',
          important: false,
          subtext: 'Peak delivery time'
        });
      }
      
      // Weather-based updates (simulated)
      if (Math.random() > 0.9) {
        updates.push({
          message: 'Adjusting route due to weather conditions',
          icon: '🌧️',
          bgColor: 'bg-gray-50',
          borderColor: 'border-gray-400',
          important: false,
          subtext: 'Taking safer route'
        });
      }
      
      return updates;
    }

    function shouldAddUpdate() {
      // Intelligent update frequency based on conditions
      const distance = calculateDistance(deliveryPersonLocation, customerLocation);
      const speed = parseFloat(deliveryPersonLocation.speed) || 0;
      
      // More frequent updates when close to customer
      if (distance < 0.5) return Math.random() > 0.5; // 50% chance when close
      if (distance < 1) return Math.random() > 0.7;   // 30% chance when nearby
      if (speed < 5) return Math.random() > 0.6;      // 40% chance in traffic
      
      return Math.random() > 0.8; // 20% chance normally
    }

    function selectBestUpdate(updates) {
      // Select the most relevant update based on current conditions
      if (updates.length === 0) {
        return {
          message: 'Delivery in progress',
          icon: '🚚',
          bgColor: 'bg-blue-50',
          borderColor: 'border-blue-400',
          important: false
        };
      }
      
      // Prioritize important updates
      const importantUpdates = updates.filter(u => u.important);
      if (importantUpdates.length > 0) {
        return importantUpdates[Math.floor(Math.random() * importantUpdates.length)];
      }
      
      return updates[Math.floor(Math.random() * updates.length)];
    }

    function checkGeofenceAlerts() {
      if (!deliveryPersonLocation || !customerLocation) return;
      
      const distance = calculateDistance(deliveryPersonLocation, customerLocation) * 1000; // Convert to meters
      
      geofenceAlerts.forEach(alert => {
        if (distance <= alert.radius && !alert.triggered) {
          alert.triggered = true;
          handleGeofenceAlert(alert);
        } else if (distance > alert.radius && alert.triggered) {
          alert.triggered = false; // Reset when leaving zone
        }
      });
    }

    function handleGeofenceAlert(alert) {
      switch(alert.action) {
        case 'notify_arrival':
          showToast('🎯 Delivery partner is near your location!', 'success');
          addIntelligentDeliveryUpdate();
          break;
        case 'check_traffic':
          // Simulate traffic check
          if (Math.random() > 0.7) {
            showToast('🚦 Checking traffic conditions...', 'warning');
          }
          break;
      }
    }

    function updateETAWithTraffic() {
      // This would integrate with real traffic APIs in production
      if (estimatedArrivalTime) {
        const now = new Date();
        const timeRemaining = Math.max(0, estimatedArrivalTime - now);
        const minutesRemaining = Math.floor(timeRemaining / (1000 * 60));
        
        // Update ETA displays with more precision
        const etaText = minutesRemaining < 1 ? 'Arriving now' : 
                      minutesRemaining === 1 ? '1 minute' : 
                      `${minutesRemaining} minutes`;
        
        document.getElementById('delivery-eta').textContent = etaText;
        document.getElementById('fullscreen-eta').textContent = `ETA: ${etaText}`;
      }
    }

    function logLocationHistory() {
      // Store location history for analytics and route optimization
      if (deliveryPersonLocation) {
        locationHistory.push({
          timestamp: new Date(),
          location: { ...deliveryPersonLocation },
          speed: deliveryPersonLocation.speed,
          accuracy: deliveryPersonLocation.accuracy
        });
        
        // Keep only last 100 location points
        if (locationHistory.length > 100) {
          locationHistory.shift();
        }
      }
    }

    function optimizeBatteryUsage() {
      // Implement battery optimization strategies
      const batteryLevel = navigator.battery ? navigator.battery.level : 1;
      
      if (batteryLevel < 0.2) { // Less than 20% battery
        // Reduce update frequency
        if (gpsTrackingInterval) {
          clearInterval(gpsTrackingInterval);
          gpsTrackingInterval = setInterval(() => {
            updateDeliveryPersonLocationAdvanced();
            updateTrackingDisplayAdvanced();
          }, 10000); // 10 second intervals
        }
        
        showToast('🔋 Battery optimization enabled', 'warning');
      }
    }

    function startAdvancedLocationWatching() {
      if (navigator.geolocation && !customerLocationWatcher) {
        const options = {
          enableHighAccuracy: locationAccuracy === 'high',
          timeout: locationAccuracy === 'high' ? 15000 : 10000,
          maximumAge: locationAccuracy === 'high' ? 30000 : 60000
        };
        
        customerLocationWatcher = navigator.geolocation.watchPosition(
          (position) => {
            // Update customer location with enhanced data
            customerLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
              accuracy: position.coords.accuracy,
              altitude: position.coords.altitude,
              heading: position.coords.heading,
              speed: position.coords.speed,
              timestamp: new Date(position.timestamp)
            };
            
            // Update map with new customer location
            if (googleMap && customerMarker) {
              customerMarker.setPosition(customerLocation);
              updateMapRoute(googleMap, deliveryPersonLocation, customerLocation);
            }
            
            // Log customer location updates
            console.log('Customer location updated:', {
              accuracy: Math.round(position.coords.accuracy),
              timestamp: new Date(position.timestamp).toLocaleTimeString()
            });
          },
          (error) => {
            console.log('Customer location watch error:', error);
            // Fallback to less frequent updates
            setTimeout(() => {
              if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                  (position) => {
                    customerLocation = {
                      lat: position.coords.latitude,
                      lng: position.coords.longitude
                    };
                  },
                  () => {},
                  { enableHighAccuracy: false, timeout: 5000 }
                );
              }
            }, 30000); // Try again in 30 seconds
          },
          options
        );
      }
    }

    function setupRealTimeUpdates() {
      // In production, this would establish WebSocket connection
      console.log('Setting up real-time communication channel');
      
      // Simulate WebSocket connection
      realTimeUpdates.connected = true;
      
      // Simulate periodic server sync
      setInterval(() => {
        if (networkStatus === 'online' && realTimeUpdates.connected) {
          // Simulate server sync
          realTimeUpdates.lastSync = new Date();
          
          // Occasionally simulate server updates
          if (Math.random() > 0.95) {
            simulateServerUpdate();
          }
        }
      }, 5000);
    }

    function simulateServerUpdate() {
      // Simulate receiving updates from server
      const serverUpdates = [
        'Order confirmed by restaurant',
        'Delivery partner assigned',
        'Order picked up',
        'Route optimized for faster delivery'
      ];
      
      const update = serverUpdates[Math.floor(Math.random() * serverUpdates.length)];
      showToast(`📡 Server update: ${update}`, 'success');
    }

    // Initialize Google Maps for tracking
    function initializeTrackingMap() {
      // Hide loading indicator
      const loadingElement = document.getElementById('map-loading');
      if (loadingElement) {
        loadingElement.style.display = 'none';
      }

      // Initialize main tracking map
      googleMap = initializeGoogleMap('google-map', false);
      
      if (googleMap && deliveryPersonLocation && customerLocation) {
        // Create markers
        deliveryMarker = createCustomMarker(
          googleMap, 
          deliveryPersonLocation, 
          'delivery', 
          `${currentTrackingOrder.deliveryPartner.name} - Delivery Partner`
        );
        
        customerMarker = createCustomMarker(
          googleMap, 
          customerLocation, 
          'customer', 
          'Your Location'
        );

        // Set up route
        updateMapRoute(googleMap, deliveryPersonLocation, customerLocation);

        // Center map to show both markers
        const bounds = new google.maps.LatLngBounds();
        bounds.extend(deliveryPersonLocation);
        bounds.extend(customerLocation);
        googleMap.fitBounds(bounds);
        
        // Add some padding
        setTimeout(() => {
          googleMap.panToBounds(bounds);
        }, 1000);
      } else if (!isGoogleMapsLoaded) {
        // Fallback: show loading message
        const mapContainer = document.getElementById('google-map');
        if (mapContainer) {
          mapContainer.innerHTML = `
            <div class="flex items-center justify-center h-full bg-gray-100">
              <div class="text-center">
                <div class="text-4xl mb-2">🗺️</div>
                <p class="text-gray-600">Loading Google Maps...</p>
                <p class="text-sm text-gray-500 mt-2">Please wait while we initialize the map</p>
              </div>
            </div>
          `;
        }
      }
    }

    function updateMapMarkers() {
      if (!googleMap || !deliveryPersonLocation || !customerLocation) return;
      
      // Update delivery marker position
      if (deliveryMarker) {
        deliveryMarker.setPosition(deliveryPersonLocation);
        
        // Add smooth animation
        if (deliveryMarker.getAnimation() !== google.maps.Animation.BOUNCE) {
          deliveryMarker.setAnimation(google.maps.Animation.BOUNCE);
          setTimeout(() => {
            deliveryMarker.setAnimation(null);
          }, 2000);
        }
      }
      
      // Update route
      updateMapRoute(googleMap, deliveryPersonLocation, customerLocation);
      
      // Update fullscreen map if it exists
      if (fullscreenGoogleMap && document.getElementById('fullscreen-map-modal').classList.contains('hidden') === false) {
        updateFullscreenMap();
      }
    }

    function updateFullscreenMap() {
      if (!fullscreenGoogleMap || !deliveryPersonLocation || !customerLocation) return;
      
      // Update markers on fullscreen map
      const deliveryMarkerFullscreen = createCustomMarker(
        fullscreenGoogleMap, 
        deliveryPersonLocation, 
        'delivery', 
        `${currentTrackingOrder.deliveryPartner.name} - Delivery Partner`
      );
      
      const customerMarkerFullscreen = createCustomMarker(
        fullscreenGoogleMap, 
        customerLocation, 
        'customer', 
        'Your Location'
      );
      
      // Update route on fullscreen map
      updateMapRoute(fullscreenGoogleMap, deliveryPersonLocation, customerLocation);
    }

    // Map Control Functions
    function centerMapOnDelivery() {
      if (googleMap && deliveryPersonLocation) {
        googleMap.setCenter(deliveryPersonLocation);
        googleMap.setZoom(16);
        
        // Add bounce animation to delivery marker
        if (deliveryMarker) {
          deliveryMarker.setAnimation(google.maps.Animation.BOUNCE);
          setTimeout(() => {
            deliveryMarker.setAnimation(null);
          }, 2000);
        }
        
        showToast('Map centered on delivery partner', 'success');
      }
    }

    function centerMapOnCustomer() {
      if (googleMap && customerLocation) {
        googleMap.setCenter(customerLocation);
        googleMap.setZoom(16);
        
        // Add bounce animation to customer marker
        if (customerMarker) {
          customerMarker.setAnimation(google.maps.Animation.BOUNCE);
          setTimeout(() => {
            customerMarker.setAnimation(null);
          }, 2000);
        }
        
        showToast('Map centered on your location', 'success');
      }
    }

    function toggleMapFullscreen() {
      document.getElementById('fullscreen-order-id').textContent = currentTrackingOrder?.id || '';
      document.getElementById('fullscreen-delivery-person').textContent = currentTrackingOrder?.deliveryPartner?.name || 'Delivery Partner';
      
      // Hide fullscreen loading indicator
      const fullscreenLoadingElement = document.getElementById('fullscreen-map-loading');
      if (fullscreenLoadingElement) {
        fullscreenLoadingElement.style.display = 'none';
      }
      
      // Initialize fullscreen Google Map
      fullscreenGoogleMap = initializeGoogleMap('fullscreen-google-map', true);
      
      if (fullscreenGoogleMap && deliveryPersonLocation && customerLocation) {
        // Create markers for fullscreen map
        const deliveryMarkerFullscreen = createCustomMarker(
          fullscreenGoogleMap, 
          deliveryPersonLocation, 
          'delivery', 
          `${currentTrackingOrder.deliveryPartner.name} - Delivery Partner`
        );
        
        const customerMarkerFullscreen = createCustomMarker(
          fullscreenGoogleMap, 
          customerLocation, 
          'customer', 
          'Your Location'
        );

        // Set up route for fullscreen map
        updateMapRoute(fullscreenGoogleMap, deliveryPersonLocation, customerLocation);

        // Center map to show both markers
        const bounds = new google.maps.LatLngBounds();
        bounds.extend(deliveryPersonLocation);
        bounds.extend(customerLocation);
        fullscreenGoogleMap.fitBounds(bounds);
      }
      
      document.getElementById('fullscreen-map-modal').classList.remove('hidden');
    }

    function closeFullscreenMap() {
      document.getElementById('fullscreen-map-modal').classList.add('hidden');
    }

    // Communication Functions
    function callDeliveryPerson() {
      if (currentTrackingOrder?.deliveryPartner) {
        const phone = currentTrackingOrder.deliveryPartner.phone;
        const confirmed = confirm(`Call ${currentTrackingOrder.deliveryPartner.name} at ${phone}?`);
        if (confirmed) {
          // In a real app, this would initiate a phone call
          window.open(`tel:${phone.replace(/[^0-9+]/g, '')}`);
          showToast('Calling delivery partner...', 'success');
        }
      }
    }

    function messageDeliveryPerson() {
      if (currentTrackingOrder?.deliveryPartner) {
        const phone = currentTrackingOrder.deliveryPartner.phone;
        const message = prompt('Enter your message for the delivery partner:');
        if (message) {
          // In a real app, this would send an SMS or in-app message
          const smsUrl = `sms:${phone.replace(/[^0-9+]/g, '')}?body=${encodeURIComponent(message)}`;
          window.open(smsUrl);
          showToast('Message sent to delivery partner', 'success');
        }
      }
    }

    function shareTrackingLink() {
      const trackingUrl = `${window.location.origin}${window.location.pathname}?track=${currentTrackingOrder?.id}`;
      
      if (navigator.share) {
        navigator.share({
          title: `Track Order #${currentTrackingOrder?.id}`,
          text: 'Track my FreshFlow delivery in real-time',
          url: trackingUrl
        });
      } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(trackingUrl).then(() => {
          showToast('Tracking link copied to clipboard!', 'success');
        }).catch(() => {
          // Fallback for older browsers
          const textArea = document.createElement('textarea');
          textArea.value = trackingUrl;
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand('copy');
          document.body.removeChild(textArea);
          showToast('Tracking link copied!', 'success');
        });
      }
    }

    // Auto-update order status when delivery person reaches customer
    function checkDeliveryCompletion() {
      if (!deliveryPersonLocation || !customerLocation) return;
      
      const distance = calculateDistance(deliveryPersonLocation, customerLocation);
      
      // If delivery person is very close (within 50 meters), mark as delivered
      if (distance < 0.05 && currentTrackingOrder) {
        setTimeout(() => {
          currentTrackingOrder.status = 'delivered';
          updateTrackingStatus('delivered');
          stopGPSTracking();
          
          // Add final delivery update
          const updatesContainer = document.getElementById('delivery-updates');
          const updateElement = document.createElement('div');
          updateElement.className = 'text-sm text-gray-600 bg-green-100 p-2 rounded border-l-4 border-green-500';
          updateElement.innerHTML = `<span class="font-medium">Just now:</span> ✅ Order delivered successfully!`;
          updatesContainer.insertBefore(updateElement, updatesContainer.firstChild);
          
          showToast('🎉 Order delivered successfully!', 'success');
        }, 5000); // Wait 5 seconds to simulate delivery completion
      }
    }

    // Enhanced status update function
    function updateOrderStatus(orderId, newStatus) {
      const order = orders.find(o => o.id === orderId);
      if (order) {
        const oldStatus = order.status;
        order.status = newStatus;
        order.lastUpdated = new Date().toLocaleString();
        
        // Start GPS tracking when order goes out for delivery
        if (newStatus === 'out-for-delivery' && currentTrackingOrder?.id === orderId) {
          initializeGPSTracking(order);
        }
        
        // Stop GPS tracking when order is delivered or cancelled
        if ((newStatus === 'delivered' || newStatus === 'cancelled') && currentTrackingOrder?.id === orderId) {
          stopGPSTracking();
        }
        
        // Real-time update for customers
        updateCustomerOrderStatus(orderId, newStatus, oldStatus);
        
        loadAdminOrders();
        
        // Show admin feedback
        showToast(`Order #${orderId} status updated to ${getOrderStatusText(newStatus)}`, 'success');
      }
    }

    // Real-time order status updates for customers
    function updateCustomerOrderStatus(orderId, newStatus, oldStatus) {
      // Update My Orders modal if it's open
      if (!document.getElementById('my-orders-modal').classList.contains('hidden')) {
        loadMyOrders();
        
        // Show notification to customer if status changed significantly
        const importantStatusChanges = ['processing', 'ready', 'out-for-delivery', 'delivered'];
        if (importantStatusChanges.includes(newStatus)) {
          showCustomerStatusNotification(orderId, newStatus);
        }
      }
      
      // Update tracking modal if it's open for this order
      if (!document.getElementById('tracking-modal').classList.contains('hidden') && 
          currentTrackingOrder?.id === orderId) {
        updateTrackingStatus(newStatus);
        
        // Add status update to delivery updates
        const updatesContainer = document.getElementById('delivery-updates');
        if (updatesContainer) {
          const updateElement = document.createElement('div');
          updateElement.className = 'text-sm text-gray-600 bg-blue-50 p-2 rounded border-l-4 border-blue-500';
          updateElement.innerHTML = `<span class="font-medium">Just now:</span> ${getOrderStatusText(newStatus)}`;
          updatesContainer.insertBefore(updateElement, updatesContainer.firstChild);
          
          // Keep only last 5 updates
          while (updatesContainer.children.length > 5) {
            updatesContainer.removeChild(updatesContainer.lastChild);
          }
        }
      }
      
      // Store status change in localStorage for persistence
      const statusHistory = JSON.parse(localStorage.getItem('orderStatusHistory') || '{}');
      if (!statusHistory[orderId]) {
        statusHistory[orderId] = [];
      }
      statusHistory[orderId].push({
        status: newStatus,
        timestamp: new Date().toLocaleString(),
        previousStatus: oldStatus
      });
      localStorage.setItem('orderStatusHistory', JSON.stringify(statusHistory));
    }

    function showCustomerStatusNotification(orderId, newStatus) {
      const statusMessages = {
        'processing': '👨‍🍳 Your order is being prepared!',
        'ready': '📦 Your order is ready for delivery!',
        'out-for-delivery': '🚚 Your order is out for delivery!',
        'delivered': '✅ Your order has been delivered!'
      };
      
      const message = statusMessages[newStatus] || `Order status updated to ${getOrderStatusText(newStatus)}`;
      
      // Show toast notification
      showToast(`Order #${orderId}: ${message}`, 'success');
      
      // Play notification sound for important updates
      if (['out-for-delivery', 'delivered'].includes(newStatus)) {
        playCustomerNotificationSound();
      }
      
      // Show browser notification if supported
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(`FreshFlow - Order #${orderId}`, {
          body: message,
          icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjMzMzIiByeD0iMTYiLz4KPHN2ZyB4PSIxNiIgeT0iMTYiIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjZmZmIj4KICA8cGF0aCBkPSJNMTIgMkwxMy4wOSA4LjI2TDIwIDlMMTMuMDkgOS43NEwxMiAxNkwxMC45MSA5Ljc0TDQgOUwxMC45MSA4LjI2TDEyIDJaIi8+CiAgPHBhdGggZD0iTTE5IDE1TDE5LjUgMTdMMjIgMTcuNUwxOS41IDE4TDE5IDIwTDE4LjUgMThMMTYgMTcuNUwxOC41IDE3TDE5IDE1WiIvPgogIDxwYXRoIGQ9Ik01IDZMNS41IDcuNUw3IDhMNS41IDguNUw1IDEwTDQuNSA4LjVMMyA4TDQuNSA3LjVMNSA2WiIvPgo8L3N2Zz4KPC9zdmc+',
          badge: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiMzMzMiLz4KPHN2ZyB4PSI4IiB5PSI4IiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2ZmZiI+CiAgPHBhdGggZD0iTTEyIDJMMTMuMDkgOC4yNkwyMCA5TDEzLjA5IDkuNzRMMTIgMTZMMTAuOTEgOS43NEw0IDlMMTAuOTEgOC4yNkwxMiAyWiIvPgo8L3N2Zz4KPC9zdmc+'
        });
      }
    }

    function playCustomerNotificationSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // Create a pleasant notification sound for customers
        const playTone = (frequency, duration, delay = 0) => {
          setTimeout(() => {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
          }, delay);
        };
        
        // Play pleasant notification: ascending tones
        playTone(523, 0.2, 0);     // C5
        playTone(659, 0.2, 200);   // E5
        playTone(784, 0.3, 400);   // G5
        
      } catch (error) {
        console.log('Customer notification sound failed:', error);
      }
    }

    // Request notification permission on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Request notification permission
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
      }
    });

    // Check for delivery completion periodically
    setInterval(() => {
      if (gpsTrackingInterval && currentTrackingOrder) {
        checkDeliveryCompletion();
      }
    }, 10000); // Check every 10 seconds

    // UPI Payment Functions
    function showUPIPaymentOptions(order) {
      document.getElementById('upi-order-id').textContent = order.id;
      document.getElementById('upi-amount').textContent = order.total;
      document.getElementById('upi-payment-modal').classList.remove('hidden');
    }

    let paymentCheckInterval = null;
    let paymentStartTime = null;

    function payWithUPI(app) {
      const pendingOrder = JSON.parse(localStorage.getItem('pendingOrder'));
      if (!pendingOrder) return;

      const amount = pendingOrder.total;
      const upiId = '9603831708@ybl';
      const merchantName = 'FreshFlow';
      const transactionNote = `Order ${pendingOrder.id}`;

      let upiUrl = '';

      switch(app) {
        case 'phonepe':
          upiUrl = `phonepe://pay?pa=${upiId}&pn=${merchantName}&am=${amount}&tn=${transactionNote}&cu=INR`;
          break;
        case 'googlepay':
          upiUrl = `tez://upi/pay?pa=${upiId}&pn=${merchantName}&am=${amount}&tn=${transactionNote}&cu=INR`;
          break;
        case 'paytm':
          upiUrl = `paytmmp://pay?pa=${upiId}&pn=${merchantName}&am=${amount}&tn=${transactionNote}&cu=INR`;
          break;
        case 'generic':
          upiUrl = `upi://pay?pa=${upiId}&pn=${merchantName}&am=${amount}&tn=${transactionNote}&cu=INR`;
          break;
      }

      // Hide UPI selection modal
      document.getElementById('upi-payment-modal').classList.add('hidden');
      
      // Show payment processing modal
      document.getElementById('payment-processing-modal').classList.remove('hidden');

      // Store payment start time
      paymentStartTime = Date.now();

      // Try to open UPI app
      try {
        window.location.href = upiUrl;
      } catch (error) {
        console.log('Could not open UPI app directly');
        // Fallback: create a temporary link and click it
        const link = document.createElement('a');
        link.href = upiUrl;
        link.click();
      }

      // Start automatic payment status checking
      startPaymentStatusCheck(pendingOrder);
    }

    function startPaymentStatusCheck(order) {
      let checkCount = 0;
      const maxChecks = 120; // Check for 4 minutes (120 * 2 seconds) - longer for real payments
      
      paymentCheckInterval = setInterval(() => {
        checkCount++;
        
        // Update status text
        document.getElementById('payment-status-text').textContent = 
          `⏳ Verifying real payment... (${checkCount * 2}s) - Please complete actual payment`;

        // In a real application, this would check with payment gateway/bank API
        // For now, we'll wait for manual confirmation or timeout
        
        if (checkCount >= maxChecks) {
          clearInterval(paymentCheckInterval);
          handlePaymentTimeout(order);
        }
      }, 2000); // Check every 2 seconds

      // Listen for app focus events (when user returns from UPI app)
      window.addEventListener('focus', handleAppFocus);
      document.addEventListener('visibilitychange', handleVisibilityChange);
    }

    function manualPaymentConfirmation() {
      const pendingOrder = JSON.parse(localStorage.getItem('pendingOrder'));
      if (!pendingOrder) return;

      // Show strict confirmation dialog
      const confirmed = confirm(`⚠️ REAL PAYMENT REQUIRED: Have you completed the actual UPI payment of ₹${pendingOrder.total} to 9603831708@ybl?\n\n🚨 WARNING: This requires REAL MONEY TRANSFER. Only click OK if you have successfully sent the actual payment from your bank account.\n\nFalse confirmation will result in order cancellation.`);
      
      if (confirmed) {
        // MANDATORY transaction reference - not optional
        let transactionRef = '';
        let attempts = 0;
        const maxAttempts = 3;
        
        while (attempts < maxAttempts && (!transactionRef || transactionRef.trim().length < 8)) {
          attempts++;
          transactionRef = prompt(`🔴 MANDATORY: Enter your UPI Transaction ID/Reference Number\n\n📱 Find this in your UPI app under transaction history\n💳 Example: T2312345678901, 334567890123, etc.\n\n⚠️ Minimum 8 characters required\nAttempt ${attempts}/${maxAttempts}:`);
          
          if (!transactionRef) {
            alert('❌ Transaction ID is required to confirm real payment. Order will be cancelled if not provided.');
            if (attempts === maxAttempts) {
              cancelUPIPayment();
              return;
            }
          } else if (transactionRef.trim().length < 8) {
            alert(`❌ Transaction ID too short. Please enter the complete transaction reference (minimum 8 characters). You entered: ${transactionRef.trim().length} characters.`);
            if (attempts === maxAttempts) {
              alert('❌ Maximum attempts exceeded. Order cancelled.');
              cancelUPIPayment();
              return;
            }
          }
        }
        
        if (transactionRef && transactionRef.trim().length >= 8) {
          // Additional verification questions
          const paymentApp = prompt('📱 Which UPI app did you use for payment?\n(PhonePe/GooglePay/Paytm/BHIM/Other)');
          const paymentTime = prompt('🕐 What time did you complete the payment?\n(e.g., 2:30 PM, 14:30, etc.)');
          
          if (paymentApp && paymentTime) {
            handlePaymentSuccess(pendingOrder, transactionRef.trim(), paymentApp, paymentTime);
          } else {
            alert('❌ Payment verification incomplete. Please provide all required details.');
          }
        }
      } else {
        alert('❌ Payment not confirmed. Order remains pending. Complete the payment and try again.');
      }
    }

    function checkPaymentStatus(order, checkCount, maxChecks) {
      // In a real application, this would make an API call to payment gateway
      // to verify if payment was actually received
      
      // For demonstration, we're requiring manual confirmation
      // Real implementation would check with UPI payment gateway APIs
      
      // This function would typically:
      // 1. Call payment gateway API with transaction details
      // 2. Verify payment status from bank/UPI provider
      // 3. Confirm actual money transfer
      // 4. Return success/failure based on real payment status
    }

    function handleAppFocus() {
      // When user returns to the app, increase chance of payment success
      if (paymentCheckInterval) {
        setTimeout(() => {
          const pendingOrder = JSON.parse(localStorage.getItem('pendingOrder'));
          if (pendingOrder && Math.random() > 0.3) {
            handlePaymentSuccess(pendingOrder);
          }
        }, 1000);
      }
    }

    function handleVisibilityChange() {
      if (!document.hidden && paymentCheckInterval) {
        // Page became visible, user likely returned from UPI app
        setTimeout(() => {
          const pendingOrder = JSON.parse(localStorage.getItem('pendingOrder'));
          if (pendingOrder && Math.random() > 0.4) {
            handlePaymentSuccess(pendingOrder);
          }
        }, 1500);
      }
    }

    function handlePaymentSuccess(order, transactionRef, paymentApp, paymentTime) {
      // Clear the checking interval
      if (paymentCheckInterval) {
        clearInterval(paymentCheckInterval);
        paymentCheckInterval = null;
      }

      // Remove event listeners
      window.removeEventListener('focus', handleAppFocus);
      document.removeEventListener('visibilitychange', handleVisibilityChange);

      // Store comprehensive payment details
      const paymentDetails = {
        transactionId: transactionRef,
        paymentApp: paymentApp,
        userReportedTime: paymentTime,
        systemTimestamp: new Date().toLocaleString(),
        paymentAmount: order.total,
        paymentTo: '9603831708@ybl',
        verificationStatus: 'user-confirmed', // In real app, this would be 'gateway-verified'
        ipAddress: 'hidden-for-privacy', // In real app, would capture actual IP
        deviceInfo: navigator.userAgent.substring(0, 50) + '...',
        orderConfirmationTime: new Date().toISOString()
      };
      
      // Update order with comprehensive payment information
      order.status = 'payment-confirmed';
      order.paymentStatus = 'completed';
      order.paymentTimestamp = new Date().toLocaleString();
      order.transactionId = transactionRef;
      order.paymentMethod = 'upi';
      order.paymentApp = paymentApp;
      order.userReportedPaymentTime = paymentTime;
      order.realPaymentConfirmed = true;
      order.paymentDetails = paymentDetails;
      order.paymentVerificationLevel = 'manual-confirmation'; // In real app: 'gateway-verified'
      
      // Add audit trail
      order.auditTrail = [
        {
          timestamp: new Date().toISOString(),
          action: 'payment_initiated',
          details: `UPI payment initiated for ₹${order.total}`
        },
        {
          timestamp: new Date().toISOString(),
          action: 'payment_confirmed',
          details: `Payment confirmed via ${paymentApp} with transaction ID: ${transactionRef}`
        },
        {
          timestamp: new Date().toISOString(),
          action: 'order_confirmed',
          details: 'Order confirmed and added to processing queue'
        }
      ];

      // Add order to confirmed orders
      orders.push(order);
      
      // Clear pending order
      localStorage.removeItem('pendingOrder');

      // Send updated WhatsApp notification with payment confirmation
      sendWhatsAppNotification(order);

      // Hide processing modal
      document.getElementById('payment-processing-modal').classList.add('hidden');

      // Show success modal with detailed information
      document.getElementById('transaction-id').textContent = transactionRef;
      document.getElementById('paid-amount').textContent = order.total;
      document.getElementById('payment-success-modal').classList.remove('hidden');

      // Update admin panel if open
      if (isAdminLoggedIn && !document.getElementById('admin-panel').classList.contains('hidden')) {
        loadAdminOrders();
      }

      // Set current order for tracking
      currentOrderId = order.id;
      
      // Show detailed success toast
      showToast(`✅ Payment Confirmed! Transaction ID: ${transactionRef.substring(0, 12)}...`, 'success');
      
      // Log payment confirmation (in real app, this would go to secure server logs)
      console.log('Payment Confirmed:', {
        orderId: order.id,
        transactionId: transactionRef,
        amount: order.total,
        timestamp: new Date().toISOString(),
        app: paymentApp
      });
    }

    function handlePaymentFailure(order, reason = 'Transaction failed') {
      // Clear the checking interval
      if (paymentCheckInterval) {
        clearInterval(paymentCheckInterval);
        paymentCheckInterval = null;
      }

      // Remove event listeners
      window.removeEventListener('focus', handleAppFocus);
      document.removeEventListener('visibilitychange', handleVisibilityChange);

      // Hide processing modal
      document.getElementById('payment-processing-modal').classList.add('hidden');

      // Show failure modal
      document.getElementById('failure-reason').textContent = reason;
      document.getElementById('failed-order-id').textContent = order.id;
      document.getElementById('payment-failed-modal').classList.remove('hidden');
    }

    function handlePaymentTimeout(order) {
      handlePaymentFailure(order, 'Payment timeout - transaction took too long');
    }

    function closePaymentSuccess() {
      document.getElementById('payment-success-modal').classList.add('hidden');
      cart = [];
      updateCartDisplay();
      displayProducts(filteredProducts);
      closeCart();
    }

    function trackOrderFromPayment() {
      if (currentOrderId) {
        const order = orders.find(o => o.id === currentOrderId);
        if (order) {
          document.getElementById('payment-success-modal').classList.add('hidden');
          showOrderTracking(order);
        }
      }
    }

    function retryPayment() {
      document.getElementById('payment-failed-modal').classList.add('hidden');
      const pendingOrder = JSON.parse(localStorage.getItem('pendingOrder'));
      if (pendingOrder) {
        showUPIPaymentOptions(pendingOrder);
      }
    }

    function switchToCOD() {
      const pendingOrder = JSON.parse(localStorage.getItem('pendingOrder'));
      if (!pendingOrder) return;

      // Convert to COD order
      pendingOrder.paymentMethod = 'cod';
      pendingOrder.status = 'pending';
      pendingOrder.paymentStatus = 'cod';

      // Add order to confirmed orders
      orders.push(pendingOrder);
      
      // Clear pending order
      localStorage.removeItem('pendingOrder');

      // Hide failure modal
      document.getElementById('payment-failed-modal').classList.add('hidden');

      // Show success modal
      document.getElementById('order-number').textContent = pendingOrder.id;
      document.getElementById('estimated-delivery').textContent = pendingOrder.deliveryTime;
      document.getElementById('success-modal').classList.remove('hidden');

      // Update admin panel if open
      if (isAdminLoggedIn && !document.getElementById('admin-panel').classList.contains('hidden')) {
        loadAdminOrders();
      }

      // Set current order for tracking
      currentOrderId = pendingOrder.id;
    }

    function cancelFailedOrder() {
      // Clear pending order
      localStorage.removeItem('pendingOrder');
      
      // Hide failure modal
      document.getElementById('payment-failed-modal').classList.add('hidden');
      
      // Show cancellation message
      alert('Order cancelled. You can place a new order anytime.');
    }

    function cancelUPIPayment() {
      // Clear pending order
      localStorage.removeItem('pendingOrder');
      
      // Hide all payment modals
      document.getElementById('upi-payment-modal').classList.add('hidden');
      document.getElementById('payment-confirmation-modal').classList.add('hidden');
      
      // Show cancellation message
      alert('Order cancelled. You can place a new order anytime.');
    }

    // Check for pending payment on page load
    document.addEventListener('DOMContentLoaded', function() {
      const pendingOrder = localStorage.getItem('pendingOrder');
      if (pendingOrder) {
        const order = JSON.parse(pendingOrder);
        // Show payment options for pending order
        setTimeout(() => {
          if (confirm(`You have a pending payment for Order #${order.id} (₹${order.total}). Would you like to complete the payment now?`)) {
            showUPIPaymentOptions(order);
          } else {
            cancelUPIPayment();
          }
        }, 1000);
      }
    });

    // Admin login form submission
    document.getElementById('admin-login-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const password = document.getElementById('admin-password').value;
      authenticateAdmin(password);
    });

    // Admin password change form submission
    document.getElementById('admin-password-change-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const currentPassword = document.getElementById('current-admin-password').value;
      const newPassword = document.getElementById('new-admin-password').value;
      const confirmPassword = document.getElementById('confirm-admin-password').value;
      
      // Hide previous errors
      document.getElementById('current-password-error').classList.add('hidden');
      document.getElementById('password-match-error').classList.add('hidden');
      
      changeAdminPassword(currentPassword, newPassword, confirmPassword);
    });

    // Admin form submission
    document.getElementById('add-product-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const name = document.getElementById('new-product-name').value;
      const price = document.getElementById('new-product-price').value;
      const category = document.getElementById('new-product-category').value;
      const photoFile = document.getElementById('new-product-photo').files[0];
      const description = document.getElementById('new-product-description').value;
      const popular = document.getElementById('new-product-popular').checked;
      
      if (!photoFile) {
        alert('Please select a product photo');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        addProduct(name, price, category, e.target.result, description, popular);
      };
      reader.readAsDataURL(photoFile);
    });

    // Payment method toggle
    document.addEventListener('change', function(e) {
      if (e.target.name === 'payment') {
        const upiDetails = document.getElementById('upi-details');
        if (e.target.value === 'upi') {
          upiDetails.classList.remove('hidden');
        } else {
          upiDetails.classList.add('hidden');
        }
      }
    });

    // User login form submission
    document.getElementById('user-login-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Validate phone number
      const phone = document.getElementById('user-phone').value;
      if (!/^[0-9]{10}$/.test(phone)) {
        showToast('Please enter a valid 10-digit mobile number', 'error');
        return;
      }
      
      const userData = {
        name: document.getElementById('user-name').value.trim(),
        phone: phone,
        address: document.getElementById('user-address').value.trim(),
        email: document.getElementById('user-email').value.trim(),
        registrationDate: new Date().toLocaleString(),
        totalOrders: 0,
        totalSpent: 0
      };
      
      // Save user data
      currentUser = userData;
      localStorage.setItem('currentUser', JSON.stringify(userData));
      
      // Show logged in state
      showLoggedInUser();
      closeUserLogin();
      
      // Show success toast instead of alert
      showToast(`Welcome ${userData.name}! Your profile has been saved for future orders.`, 'success');
    });

    // WhatsApp Notification Functions
    function sendWhatsAppNotification(order) {
      // Create detailed order message for WhatsApp
      const itemsList = order.items.map(item => 
        `• ${item.quantity}x ${item.name} - ₹${item.price * item.quantity}`
      ).join('\n');
      
      const paymentStatus = order.paymentMethod === 'upi' ? 
        (order.realPaymentConfirmed ? '✅ UPI PAID' : '⏳ UPI PENDING') : 
        '💵 Cash on Delivery';
      
      const message = `🔔 *NEW ORDER ALERT* 🔔

📋 *Order #${order.id}*
📅 ${order.timestamp}

👤 *Customer Details:*
Name: ${order.customer.name}
📞 Phone: ${order.customer.phone}
📍 Address: ${order.customer.address}
🌍 Location: ${order.customer.location || 'Not specified'}

🛒 *Order Items:*
${itemsList}

💰 *Payment Details:*
Subtotal: ₹${order.subtotal}
Delivery: ₹${order.deliveryFee}
*Total: ₹${order.total}*
Payment: ${paymentStatus}

⏰ *Delivery Time:* ${order.deliveryTime}
${order.specialInstructions ? `📝 *Special Instructions:* ${order.specialInstructions}` : ''}

${order.transactionId ? `💳 *Transaction ID:* ${order.transactionId}` : ''}
${order.paymentApp ? `📱 *Payment App:* ${order.paymentApp}` : ''}

🚀 *Action Required:* Please confirm and prepare order
📱 Reply to this message to update order status

---
FreshFlow Order Management System`;

      // Encode message for WhatsApp URL
      const encodedMessage = encodeURIComponent(message);
      const whatsappUrl = `https://wa.me/919603831708?text=${encodedMessage}`;
      
      // Play notification sound
      playNotificationSound();
      
      // Show admin notification popup
      showAdminNotificationPopup(order);
      
      // Auto-open WhatsApp (will work on mobile devices)
      try {
        // Create a temporary link and click it
        const link = document.createElement('a');
        link.href = whatsappUrl;
        link.target = '_blank';
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Show success toast
        showToast('📱 WhatsApp notification sent to admin!', 'success');
      } catch (error) {
        console.log('WhatsApp auto-open failed:', error);
        // Fallback: show manual link
        showManualWhatsAppLink(whatsappUrl, order);
      }
    }

    function playNotificationSound() {
      // Create audio context for notification sound
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // Create a more attention-grabbing notification sound
        const playTone = (frequency, duration, delay = 0) => {
          setTimeout(() => {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
          }, delay);
        };
        
        // Play notification sequence: high-low-high pattern
        playTone(800, 0.2, 0);     // High tone
        playTone(600, 0.2, 300);   // Low tone  
        playTone(800, 0.3, 600);   // High tone (longer)
        
        // Repeat the sequence after 1 second for emphasis
        playTone(800, 0.2, 1000);
        playTone(600, 0.2, 1300);
        playTone(800, 0.3, 1600);
        
      } catch (error) {
        console.log('Audio notification failed:', error);
        // Fallback: try to play a simple beep
        try {
          const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
          audio.play().catch(() => {});
        } catch (e) {
          console.log('Fallback audio failed');
        }
      }
    }

    function showAdminNotificationPopup(order) {
      // Create notification popup
      const notification = document.createElement('div');
      notification.className = 'fixed top-4 right-4 bg-red-600 text-white p-6 rounded-lg shadow-2xl z-50 max-w-sm border-l-4 border-yellow-400 animate-pulse';
      notification.innerHTML = `
        <div class="flex items-start space-x-3">
          <div class="text-2xl animate-bounce">🔔</div>
          <div class="flex-1">
            <h3 class="font-bold text-lg mb-2">NEW ORDER ALERT!</h3>
            <p class="text-sm mb-2">Order #${order.id} - ₹${order.total}</p>
            <p class="text-sm mb-2">Customer: ${order.customer.name}</p>
            <p class="text-sm mb-3">Phone: ${order.customer.phone}</p>
            <div class="flex space-x-2">
              <button onclick="openWhatsAppManually('${order.id}')" class="bg-green-500 hover:bg-green-600 text-white text-xs px-3 py-1 rounded font-medium">
                📱 Open WhatsApp
              </button>
              <button onclick="this.parentElement.parentElement.parentElement.parentElement.remove()" class="bg-gray-500 hover:bg-gray-600 text-white text-xs px-3 py-1 rounded">
                Dismiss
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(notification);
      
      // Auto-remove after 30 seconds
      setTimeout(() => {
        if (notification.parentElement) {
          notification.remove();
        }
      }, 30000);
      
      // Make it blink for attention
      let blinkCount = 0;
      const blinkInterval = setInterval(() => {
        notification.style.opacity = notification.style.opacity === '0.5' ? '1' : '0.5';
        blinkCount++;
        if (blinkCount > 10) {
          clearInterval(blinkInterval);
          notification.style.opacity = '1';
        }
      }, 500);
    }

    function showManualWhatsAppLink(whatsappUrl, order) {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
      modal.innerHTML = `
        <div class="bg-white rounded-lg p-8 max-w-md w-full">
          <div class="text-center mb-6">
            <div class="text-4xl mb-4">📱</div>
            <h2 class="text-2xl font-semibold mb-2">Send WhatsApp Notification</h2>
            <p class="text-gray-600">Click the button below to send order details to admin</p>
          </div>
          
          <div class="bg-green-50 p-4 rounded-lg mb-6">
            <p class="text-sm text-green-800 mb-2"><strong>Order #${order.id}</strong></p>
            <p class="text-sm text-green-800">Customer: ${order.customer.name}</p>
            <p class="text-sm text-green-800">Total: ₹${order.total}</p>
            <p class="text-sm text-green-800">To: 9603831708</p>
          </div>
          
          <div class="flex space-x-3">
            <button onclick="window.open('${whatsappUrl}', '_blank')" class="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors font-medium">
              📱 Open WhatsApp
            </button>
            <button onclick="this.parentElement.parentElement.parentElement.remove()" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition-colors">
              Close
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    function openWhatsAppManually(orderId) {
      const order = orders.find(o => o.id == orderId) || JSON.parse(localStorage.getItem('pendingOrder') || '{}');
      if (order.id) {
        sendWhatsAppNotification(order);
      }
    }

    // Offer form submission
    document.getElementById('create-offer-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const offerData = {
        title: document.getElementById('offer-title-input').value,
        description: document.getElementById('offer-desc-input').value,
        discountType: document.getElementById('discount-type').value,
        discountValue: document.getElementById('discount-value').value,
        minOrderValue: document.getElementById('min-order-value').value,
        offerCode: document.getElementById('offer-code').value,
        showBanner: document.getElementById('show-banner').checked,
        autoApply: document.getElementById('auto-apply').checked,
        expiryDate: document.getElementById('offer-expiry').value
      };
      
      const offer = createOffer(offerData);
      loadAdminOffers();
      
      // Reset form
      document.getElementById('create-offer-form').reset();
      
      // Show success message
      showToast(`Offer "${offer.title}" created successfully!`, 'success');
      
      // If banner is enabled, show notification
      if (offer.showBanner) {
        showToast('🎉 Offer banner is now live on homepage!', 'success');
      }
    });

    // Form submission
    document.getElementById('checkout-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const paymentMethod = document.querySelector('input[name="payment"]:checked').value;

      // Validate payment method for large orders
      if (subtotal > 500 && paymentMethod === 'cod') {
        document.getElementById('payment-warning').classList.remove('hidden');
        return;
      } else {
        document.getElementById('payment-warning').classList.add('hidden');
      }

      // Get customer info (from logged user or form)
      let customerInfo;
      if (currentUser && document.getElementById('logged-user-info').classList.contains('hidden') === false) {
        // Use logged in user info
        customerInfo = {
          name: currentUser.name,
          phone: currentUser.phone,
          address: currentUser.address,
          email: currentUser.email,
          location: currentLocation
        };
      } else {
        // Use form data (guest or edited user info)
        customerInfo = {
          name: document.getElementById('customer-name').value,
          phone: document.getElementById('customer-phone').value,
          address: document.getElementById('customer-address').value,
          location: currentLocation
        };
        
        // Save guest customer info for future use
        if (!currentUser) {
          localStorage.setItem('customerName', customerInfo.name);
          localStorage.setItem('customerPhone', customerInfo.phone);
          localStorage.setItem('customerAddress', customerInfo.address);
        }
      }
      
      // Calculate final amounts with offers
      const discount = currentOffer ? calculateDiscount(subtotal, currentOffer) : 0;
      const deliveryFee = (currentOffer && currentOffer.discountType === 'free-delivery') ? 0 : calculateDeliveryFee();
      const finalTotal = subtotal - discount + deliveryFee;
      
      const order = {
        id: orderCounter++,
        timestamp: new Date().toLocaleString(),
        customer: customerInfo,
        deliveryTime: document.getElementById('delivery-time').value,
        specialInstructions: document.getElementById('special-instructions').value,
        paymentMethod: paymentMethod,
        items: [...cart],
        subtotal: subtotal,
        discount: discount,
        appliedOffer: currentOffer ? {
          id: currentOffer.id,
          title: currentOffer.title,
          discountType: currentOffer.discountType,
          discountValue: currentOffer.discountValue
        } : null,
        deliveryFee: deliveryFee,
        total: finalTotal,
        status: paymentMethod === 'upi' ? 'payment-pending' : 'pending',
        isRegisteredUser: !!currentUser
      };
      
      // Update offer usage count
      if (currentOffer) {
        currentOffer.usageCount++;
        localStorage.setItem('activeOffers', JSON.stringify(activeOffers));
      }

      // Clear cart immediately after placing order
      cart = [];
      updateCartDisplay();
      displayProducts(filteredProducts);
      closeCart();

      if (paymentMethod === 'upi') {
        // Store order temporarily until payment is confirmed
        localStorage.setItem('pendingOrder', JSON.stringify(order));
        currentOrderId = order.id;
        
        // Send WhatsApp notification for UPI orders (payment pending)
        sendWhatsAppNotification(order);
        
        // Close checkout modal
        closeCheckout();
        
        // Show UPI payment options
        showUPIPaymentOptions(order);
      } else {
        // For COD, confirm order immediately
        orders.push(order);
        currentOrderId = order.id;
        
        // Send WhatsApp notification for COD orders
        sendWhatsAppNotification(order);
        
        // Show success modal
        document.getElementById('order-number').textContent = order.id;
        document.getElementById('estimated-delivery').textContent = order.deliveryTime;
        closeCheckout();
        document.getElementById('success-modal').classList.remove('hidden');
      }
      
      // Reset form
      document.getElementById('checkout-form').reset();
    });
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'966dae45212711ee',t:'MTc1MzgwMzI3MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
